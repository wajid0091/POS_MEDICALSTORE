<!DOCTYPE html>
<html lang="ur" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Inam Medical POS">
    <meta name="apple-mobile-web-app-title" content="Inam Medical POS">
    <meta name="theme-color" content="#1e293b">
    <meta name="msapplication-navbutton-color" content="#1e293b">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-starturl" content="/">
    <link rel="icon" type="image/png" href="icons/icon-192.png"> <!-- Changed path to local -->
    <link rel="apple-touch-icon" href="icons/icon-192.png"> <!-- Changed path to local -->
    <link rel="manifest" href="manifest.json">

    <title>Inam Medical Center - POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Nastaliq Urdu', sans-serif; background-color: #f1f5f9; overflow-x: hidden; }
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .main-layout { display: flex; min-height: 100vh; transition: margin-right 0.3s ease; }
        .sidebar { width: 260px; background-color: #1e293b; color: #e2e8f0; transition: width 0.3s ease; flex-shrink: 0; z-index: 10; }
        .sidebar.collapsed { width: 72px; }
        
        .main-content { 
            flex-grow: 1; 
            padding: 1.5rem; 
            height: 100vh;
            overflow: hidden;
            transition: margin-left 0.3s ease; 
        }
        .dark .main-content { background-color: #0f172a; }
        
        #cart-sidebar {
            width: 400px; position: fixed; top: 0; right: 0; height: 100%; background-color: #1e293b;
            border-left: 1px solid #334155; transform: translateX(100%); transition: transform 0.3s ease;
            z-index: 20; display: flex; flex-direction: column;
        }
        #cart-sidebar.open { transform: translateX(0); }
        .main-layout.cart-open { margin-right: 400px; }

        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .dark .card { background-color: #1e293b; border: 1px solid #334155; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.5px; border: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn:disabled { background-color: #4b5563; color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-info { background-color: #0ea5e9; color: white; }

        .input-field { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; background-color: #f9fafb; }
        .dark .input-field { background-color: #334155; border-color: #4b5563; color: #e2e8f0; }
        .page { display: none; height: 100%; }
        .page.active { display: flex; flex-direction: column; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .product-card-pos {
            display: flex; flex-direction: column; justify-content: space-between; height: 120px;
            padding: 0.75rem; border: 1px solid rgba(0,0,0,0.2); border-radius: 8px;
            text-align: center; cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .product-card-pos:not(.disabled):hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); filter: brightness(1.1); }
        .product-card-pos.disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(80%); }
        .product-card-pos .product-name {
            font-weight: 700; font-size: 0.875rem; line-height: 1.25rem; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-overflow: ellipsis;
        }
        .product-card-pos .product-details { 
            font-size: 0.75rem; line-height: 1rem; 
        }
        .product-card-pos .product-details .stock-text { font-weight: 600; }

        .category-filter-btn {
            padding: 0.5rem 1rem; border-radius: 9999px; color: white; font-weight: 600;
            border: 2px solid transparent; transition: all 0.2s ease; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .category-filter-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .category-filter-btn.active { border-color: #ffffff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); transform: scale(1.05); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: #1e293b; color: #e2e8f0; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 90%; max-width: 600px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .sidebar .nav-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: #cbd5e1; transition: background-color 0.2s, color 0.2s; border-radius: 8px; margin: 0.25rem 0.5rem; }
        .sidebar .nav-link.active { background-color: #2563eb; color: white; }
        .sidebar .nav-link .link-text { margin-left: 1rem; white-space: nowrap; opacity: 1; transition: opacity 0.3s; }
        .sidebar.collapsed .nav-link .link-text { opacity: 0; width: 0; pointer-events: none; }
        
        .dark .card *:not(i):not(button) { color: #e2e8f0; } 
        .dark table, .dark table *:not(i):not(button) { color: #e2e8f0; }

        .dark .card .text-gray-400, .dark .text-gray-400 { color: #9ca3af !important; }
        .dark .card .text-green-400, .dark .text-green-400 { color: #4ade80 !important; }
        .dark .card .text-red-500, .dark .text-red-500 { color: #f87171 !important; }
        .dark .card .text-yellow-500, .dark .text-yellow-500 { color: #facc15 !important; }
        .dark .card .text-orange-400, .dark .text-orange-400 { color: #fb923c !important; }
        .dark .card .text-slate-500, .dark .text-slate-500 { color: #64748b !important; }
        .dark .text-red-400 { color: #fb7185 !important; }
        .dark .text-green-600 { color: #22c55e !important; }
        .dark .text-yellow-400 { color: #facc15 !important; }
        
        .force-black-text, .force-black-text * { 
            color: black !important; 
            opacity: 1 !important;
        }

        @media print {
            body.printing * { visibility: hidden !important; }
            .no-print { display: none !important; }
            #invoice-modal .printable-area, #invoice-modal .printable-area * { visibility: visible !important; }
            #invoice-modal { position: absolute; left: 0; top: 0; margin: 0; padding: 0; width: 100%; height: auto; display: block !important; }
            #invoice-print-area-wrapper { display: block !important; width: 80mm; padding: 3mm; box-sizing: border-box; background: white !important; }
            #invoice-print-area-wrapper *, #invoice-print-area * { 
                color: black !important; 
                opacity: 1 !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
            #invoice-print-area-wrapper h2 { font-size: 14pt; margin-bottom: 4px; }
            #invoice-print-area-wrapper p, #invoice-print-area-wrapper div, #invoice-print-area-wrapper span, #invoice-print-area-wrapper strong { font-size: 9pt; }
            #invoice-print-area-wrapper table th, #invoice-print-area-wrapper table td { padding: 2px 0; font-size: 8pt; }
            #invoice-print-area-wrapper hr { border-style: dashed !important; border-color: black !important; }

            .report-printable, .report-printable * { visibility: visible !important; color: black !important; }
            .report-printable { display: block !important; position: absolute; left: 0; top: 0; margin: 0; padding: 10mm; width: 100%; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .report-printable .card { background-color: #f3f4f6 !important; border: 1px solid #ccc; }
            .report-printable .text-green-600 { color: #059669 !important; }
        }
    </style>
</head>
<body class="dark">

<!-- ALL HTML BODY CONTENT REMAINS THE SAME -->
<!-- THE ONLY CHANGE IS IN THE SCRIPT TAG AT THE VERY BOTTOM -->
<div id="login-container" class="flex items-center justify-center min-h-screen bg-slate-900">
    <div class="w-full max-w-sm p-8 space-y-6 bg-slate-800 rounded-2xl shadow-2xl">
        <div class="text-center">
            <i class="fas fa-clinic-medical text-blue-400 text-6xl"></i>
            <h1 class="mt-5 text-3xl font-bold text-white tracking-tight">Inam Medical</h1>
            <p class="mt-2 text-slate-400">POS میں خوش آمدید</p>
        </div>
        <form id="login-form" class="space-y-6">
            <div class="space-y-4">
                <div>
                    <label for="email-address" class="text-sm font-medium text-slate-300">Email Address</label>
                    <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field mt-1" placeholder="user@example.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-slate-300">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field mt-1" placeholder="••••••••">
                </div>
            </div>
            <p id="login-error" class="text-red-400 text-sm text-center h-4"></p>
            <div>
                <button type="submit" class="btn btn-primary w-full group text-base py-3">
                    <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                </button>
            </div>
        </form>
    </div>
</div>

<div id="app-layout" class="main-layout hidden">
    <!-- Left Sidebar -->
    <aside id="sidebar" class="sidebar flex flex-col no-print">
        <div class="p-4 text-center flex items-center justify-center h-20 border-b border-slate-700">
            <i class="fas fa-clinic-medical text-blue-400 text-3xl"></i>
            <h1 class="text-xl font-bold text-white ml-2 link-text">Inam Medical</h1>
        </div>
        <nav class="flex-grow py-4">
            <a href="#" class="nav-link" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw w-6 text-lg"></i><span class="link-text">Dashboard</span></a>
            <a href="#" class="nav-link" data-page="pos"><i class="fas fa-cash-register fa-fw w-6 text-lg"></i><span class="link-text">POS</span></a>
            <a href="#" class="nav-link" data-page="transactions"><i class="fas fa-history fa-fw w-6 text-lg"></i><span class="link-text">Transactions</span></a>
            <a href="#" class="nav-link" data-page="products"><i class="fas fa-box-open fa-fw w-6 text-lg"></i><span class="link-text">Products</span></a>
            <a href="#" class="nav-link" data-page="credit"><i class="fas fa-book fa-fw w-6 text-lg"></i><span class="link-text">Credit (Udhaar)</span></a>
            <a href="#" class="nav-link" data-page="suppliers"><i class="fas fa-truck fa-fw w-6 text-lg"></i><span class="link-text">Suppliers</span></a>
            <a href="#" class="nav-link" data-page="reports"><i class="fas fa-chart-pie fa-fw w-6 text-lg"></i><span class="link-text">Sales Reports</span></a>
            <a href="#" class="nav-link" data-page="settings"><i class="fas fa-cogs fa-fw w-6 text-lg"></i><span class="link-text">Settings</span></a>
        </nav>
        <div class="p-2 border-t border-slate-700">
             <button id="sidebar-toggle" class="w-full text-left nav-link"><i class="fas fa-chevron-left fa-fw w-6 text-lg"></i><span class="link-text">Collapse</span></button>
             <button id="logout-btn" class="w-full text-left nav-link text-red-400 hover:bg-red-500 hover:text-white"><i class="fas fa-sign-out-alt fa-fw w-6 text-lg"></i><span class="link-text">Logout</span></button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="main-content">
        
        <!-- Dashboard Page -->
        <div id="dashboard" class="page overflow-y-auto">
             <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Dashboard</h1>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-5"><h3 class="text-gray-400">Total Stock (Cost)</h3><p id="total-stock-value-cost" class="text-3xl font-bold">₨0.00</p></div>
                <div class="card p-5"><h3 class="text-gray-400">Total Stock (Sell)</h3><p id="total-stock-value-sell" class="text-3xl font-bold">₨0.00</p></div>
                <div class="card p-5"><h3 class="text-gray-400">Today's Net Sales</h3><p id="todays-sales" class="text-3xl font-bold">₨0.00</p></div>
                <div class="card p-5"><h3 class="text-gray-400">Today's Net Profit</h3><p id="todays-profit" class="text-3xl font-bold text-green-400">₨0.00</p></div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <div class="lg:col-span-1 card"><h3 class="text-xl font-semibold mb-4">Today's Top Selling Products</h3><div id="top-selling-products" class="space-y-3 max-h-60 overflow-y-auto"></div></div>
                <div class="lg:col-span-1 card">
                    <h3 class="text-xl font-semibold mb-4 text-red-500">Low Stock Alerts (≤ 10)</h3>
                    <div id="low-stock-alerts" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
                 <div class="lg:col-span-1 card">
                    <h3 class="text-xl font-semibold mb-4 text-yellow-500">Expiring Soon (30 Days)</h3>
                    <div id="expiring-soon-alerts" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div class="card p-5"><h3 class="text-gray-400">Total Credit Due</h3><p id="total-credit-due" class="text-3xl font-bold text-orange-400">₨0.00</p></div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-slate-500">Out of Stock Products</h3>
                    <div id="out-of-stock-alerts" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
             </div>
        </div>

        <!-- POS Page -->
        <div id="pos" class="page flex-col">
            <div class="card flex flex-col flex-grow overflow-hidden">
                <div class="flex-shrink-0 mb-4">
                    <input type="text" id="product-search" placeholder="Search products by name or batch number..." class="input-field w-full mb-3">
                    <div id="category-filters" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4 flex-grow overflow-y-auto p-1"></div>
            </div>
        </div>

        <!-- Transactions Page -->
        <div id="transactions" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">All Transactions</h1>
            <div class="card flex-grow flex flex-col overflow-hidden">
                 <div class="overflow-auto flex-grow"><table class="w-full text-left"><thead><tr class="bg-slate-800 sticky top-0 z-10"><th class="p-3">Invoice ID</th><th>Date</th><th>Customer</th><th>Status</th><th>Total</th><th class="text-center">Actions</th></tr></thead><tbody id="transactions-table-body"></tbody></table></div>
            </div>
        </div>
        
        <!-- Products Page -->
        <div id="products" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Product Management</h1>
            <div class="card mb-6 flex-shrink-0">
                <h2 class="text-xl font-bold mb-4">Add New Product</h2>
                <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div><label class="font-medium">Product Name</label><input type="text" id="product-name" class="input-field" required></div>
                    <div><label class="font-medium">Batch Number</label><input type="text" id="product-batch-number" class="input-field"></div>
                    <div><label class="font-medium">Category</label><select id="product-category" class="input-field" required></select></div>
                    <div><label class="font-medium">Cost Price</label><input type="number" id="product-cost-price" class="input-field" required min="0" step="0.01"></div>
                    <div><label class="font-medium">Sell Price</label><input type="number" id="product-sell-price" class="input-field" required min="0" step="0.01"></div>
                    <div><label class="font-medium">Stock</label><input type="number" id="product-stock" class="input-field" required min="0"></div>
                    <div><label class="font-medium">Expiry Date</label><input type="date" id="product-expiry" class="input-field" required></div>
                    <div class="lg:col-start-4"><button type="submit" class="btn btn-primary w-full"><i class="fas fa-plus mr-2"></i>Add Product</button></div>
                </form>
            </div>
            <div class="card flex-grow flex flex-col overflow-hidden">
                 <h2 class="text-xl font-bold mb-4 flex-shrink-0">All Products</h2>
                 <div class="overflow-auto flex-grow"><table class="w-full text-left"><thead><tr class="bg-slate-800 sticky top-0 z-10"><th class="p-3">Name</th><th>Batch No.</th><th>Category</th><th>Cost Price</th><th>Sell Price</th><th>Stock</th><th>Expiry Date</th><th>Actions</th></tr></thead><tbody id="products-table-body"></tbody></table></div>
            </div>
        </div>
        
        <!-- Other Pages -->
        <div id="credit" class="page flex-col"> <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Credit / Udhaar Management</h1> <div class="card flex-grow flex flex-col overflow-hidden"> <div class="overflow-auto flex-grow"> <table class="w-full text-left"><thead class="bg-slate-800 sticky top-0 z-10"><tr><th class="p-3">Invoice ID</th><th>Date</th><th>Customer</th><th>Phone</th><th>Amount Due</th><th class="text-center">Actions</th></tr></thead><tbody id="credit-table-body"></tbody></table> </div> </div> </div>
        <div id="suppliers" class="page flex-col"> <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Supplier Purchases</h1> <div class="card flex-grow flex flex-col overflow-hidden"> <div class="flex justify-between items-center mb-4 flex-shrink-0"> <h2 class="text-xl font-bold">Purchase History</h2> <button id="add-purchase-btn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add New Purchase</button> </div> <div class="overflow-auto flex-grow"> <table class="w-full text-left"> <thead class="bg-slate-800 sticky top-0 z-10"> <tr> <th class="p-3">Date</th> <th>Supplier</th> <th>Total Bill</th> <th>Paid</th> <th class="text-red-400">Remaining</th> <th class="text-center">Actions</th> </tr> </thead> <tbody id="purchases-table-body"></tbody> </table> </div> </div> </div>
        <div id="reports" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Sales Report</h1>
            <div class="card flex-grow flex flex-col overflow-hidden">
                <div class="flex flex-wrap justify-between items-center mb-4 no-print gap-4 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-info" id="report-daily-btn">Today</button>
                        <button class="btn btn-sm btn-info" id="report-weekly-btn">This Week</button>
                        <button class="btn btn-sm btn-info" id="report-monthly-btn">This Month</button>
                    </div>
                    <div class="flex items-center gap-4">
                        <div><label for="report-start-date" class="text-sm">Start</label><input type="date" id="report-start-date" class="input-field p-2 text-sm"></div>
                        <div><label for="report-end-date" class="text-sm">End</label><input type="date" id="report-end-date" class="input-field p-2 text-sm"></div>
                        <button class="btn btn-primary btn-sm" id="report-filter-btn">Filter</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="print-report-btn" class="btn bg-gray-600"><i class="fas fa-print mr-2"></i>Print Report</button>
                        <button id="download-report-pdf-btn" class="btn bg-blue-700"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button>
                    </div>
                </div>
                <div id="report-print-area" class="report-printable flex-grow overflow-y-auto">
                    <h2 id="report-title" class="text-center text-3xl font-bold my-4">Sales Summary Report</h2>
                    <div class="grid grid-cols-3 gap-4 my-6">
                        <div class="card text-center"><p>Net Sales</p><p id="report-total-sales" class="text-2xl font-bold">₨0.00</p></div>
                        <div class="card text-center"><p>Net Profit</p><p id="report-total-profit" class="text-2xl font-bold text-green-600">₨0.00</p></div>
                        <div class="card text-center"><p>Total Bills</p><p id="report-total-bills" class="text-2xl font-bold">0</p></div>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-700 sticky top-0 z-10"><tr><th class="p-2">Invoice ID</th><th>Time</th><th>Customer</th><th class="text-right">Total</th><th class="text-right">Profit</th></tr></thead><tbody id="report-transactions-table"></tbody></table></div>
                </div>
            </div>
        </div>
        <div id="settings" class="page">
            <h1 class="text-3xl font-bold mb-6">Settings</h1>
            <div class="card max-w-2xl mx-auto">
                <div class="mb-6 bg-slate-700 p-4 rounded-lg">
                    <p class="text-sm text-slate-400">Logged in as:</p>
                    <p id="logged-in-email" class="text-lg font-semibold"></p>
                </div>
                <form id="settings-form" class="space-y-4">
                    <div><label for="setting-contact-number" class="font-medium">Store Contact</label><input type="text" id="setting-contact-number" class="input-field mt-1"></div>
                    <div><label for="setting-email" class="font-medium">Store Email</label><input type="email" id="setting-email" class="input-field mt-1"></div>
                    <div class="pt-4"><button type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Save</button></div>
                </form>
                <div class="mt-8 pt-6 border-t border-slate-700 text-center">
                    <p class="text-slate-400 mb-3">For software updates or support, contact the developer:</p>
                    <a href="https://wa.me/923139071038" target="_blank" class="btn btn-success">
                        <i class="fab fa-whatsapp mr-2"></i>Contact on WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Right Cart Sidebar -->
    <aside id="cart-sidebar" class="no-print text-slate-200">
        <div class="p-4 flex justify-between items-center h-20 border-b border-slate-700"> <h2 class="text-2xl font-bold">Current Sale</h2> <button id="cart-close-btn" class="text-2xl hover:text-red-500 transition-colors">&times;</button> </div>
        <div id="cart-items" class="p-4 space-y-3 flex-grow overflow-y-auto"></div>
        <div class="p-4 border-t border-slate-700 space-y-3">
            <div class="flex justify-between font-medium"><span>Subtotal</span><span id="cart-subtotal">₨0.00</span></div>
            <div class="flex justify-between items-center font-medium">
                <label for="cart-discount-value">Discount</label>
                <div class="flex items-center border border-slate-600 rounded-lg">
                    <input type="number" id="cart-discount-value" value="0" class="input-field w-24 text-right bg-transparent border-0" min="0">
                    <div class="flex bg-slate-700 rounded-r-md">
                        <button id="discount-type-amount" class="px-2 py-1 text-sm rounded-l-md bg-blue-600">₨</button>
                        <button id="discount-type-percent" class="px-2 py-1 text-sm rounded-r-md bg-slate-600">%</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-between font-bold text-2xl border-t dark:border-slate-600 pt-2 mt-2"><span>Total</span><span id="cart-total">₨0.00</span></div>
            <div class="mt-4"><label for="customer-name" class="font-medium">Customer Name</label><input type="text" id="customer-name" placeholder="Walk-in Customer" class="input-field mt-1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3 p-4">
            <button id="complete-sale-btn" class="btn btn-success w-full text-lg"><i class="fas fa-check-circle mr-2"></i>Finalize</button>
            <button id="add-to-credit-btn" class="btn btn-warning w-full text-lg"><i class="fas fa-book mr-2"></i>Credit</button>
        </div>
    </aside>
</div>

<!-- All Modals -->
<div id="invoice-modal" class="modal-overlay no-print"> 
    <div class="modal-content dark:bg-slate-800 dark:text-slate-200 max-w-sm w-full">
        <div id="invoice-print-area-wrapper" class="printable-area p-4"> <!-- Added padding here -->
            <div id="invoice-print-area">
                <div class="text-center mb-4"> 
                    <i class="fas fa-home text-blue-500 text-3xl mb-1"></i> <!-- Changed icon to fa-home -->
                    <h2 class="text-xl font-extrabold tracking-wider">INAM MEDICAL</h2> 
                    <p id="receipt-store-contact" class="text-xs"></p> 
                    <p id="receipt-store-email" class="text-xs"></p> 
                </div> 
                <hr class="my-2 border-dashed"> 
                <div class="text-xs mb-2 space-y-1"> 
                    <div class="flex justify-between"><strong>Invoice:</strong> <span id="invoice-id"></span></div> 
                    <div class="flex justify-between"><strong>Customer:</strong> <span id="invoice-customer-name"></span></div> 
                    <div class="flex justify-between"><strong>Date:</strong> <span id="invoice-date"></span></div> 
                </div> 
                <hr class="my-2 border-dashed"> 
                <table class="w-full text-xs mb-2"> 
                    <thead> 
                        <tr class="border-b-2 border-dashed"> 
                            <th class="text-left py-1">ITEM</th> 
                            <th class="text-center">QTY</th> 
                            <th class="text-right">PRICE</th> 
                            <th class="text-right">TOTAL</th> 
                        </tr> 
                    </thead> 
                    <tbody id="invoice-items" class="divide-y divide-dashed"></tbody> 
                </table> 
                <hr class="my-2 border-dashed"> 
                <div class="text-xs space-y-1"> 
                    <div class="flex justify-between"><span>Subtotal:</span><span id="invoice-subtotal"></span></div> 
                    <div class="flex justify-between"><span>Discount:</span><span id="invoice-discount"></span></div> 
                    <div class="flex justify-between font-bold text-base border-t-2 border-dashed mt-1 pt-1"><span>Grand Total:</span><span id="invoice-total"></span></div> 
                </div> 
                <p class="text-center text-xs mt-4">Thank you for your visit!</p> 
            </div>
        </div>
        <div class="flex justify-end gap-3 p-4 bg-slate-700 rounded-b-lg"> 
            <button id="print-invoice-btn" class="btn bg-gray-600 text-white"><i class="fas fa-print mr-2"></i>Print</button> 
            <button id="download-invoice-pdf-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button> 
            <button id="close-invoice-btn" class="btn btn-danger"><i class="fas fa-times mr-2"></i>Close</button> 
        </div> 
    </div> 
</div>
<div id="credit-modal" class="modal-overlay no-print"> <div class="modal-content"> <h2 class="text-2xl font-bold mb-4">Add to Credit (Udhaar)</h2> <form id="credit-form" class="space-y-4"> <div><label class="font-medium">Customer Name</label><input type="text" id="credit-customer-name" class="input-field" required></div> <div><label class="font-medium">Phone</label><input type="tel" id="credit-customer-phone" class="input-field" required></div> <div><label class="font-medium">Address</label><input type="text" id="credit-customer-address" class="input-field"></div> <div><label class="font-medium">CNIC</label><input type="text" id="credit-customer-cnic" class="input-field"></div> <div class="text-lg font-bold mt-4">Total: <span id="credit-modal-total"></span></div> <div class="flex justify-end gap-3 pt-4"> <button type="button" id="cancel-credit-btn" class="btn btn-danger">Cancel</button> <button type="submit" class="btn btn-success">Save Credit</button> </div> </form> </div> </div>
<div id="purchase-modal" class="modal-overlay no-print"> <div class="modal-content"> <h2 class="text-2xl font-bold mb-4">Add Supplier Purchase</h2> <form id="purchase-form" class="space-y-4"> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div><label class="font-medium">Supplier Name</label><input type="text" id="purchase-supplier-name" class="input-field" required></div> <div><label class="font-medium">Contact</label><input type="tel" id="purchase-supplier-contact" class="input-field"></div> <div><label class="font-medium">Date</label><input type="date" id="purchase-date" class="input-field" required></div> <div><label class="font-medium">Total Bill</label><input type="number" id="purchase-total-amount" class="input-field" required min="0" step="0.01"></div> <div><label class="font-medium">Amount Paid</label><input type="number" id="purchase-amount-paid" class="input-field" required min="0" step="0.01"></div> <div class="p-2 rounded-lg bg-slate-700 text-center"><label class="font-medium">Remaining</label><div id="purchase-amount-remaining" class="text-xl font-bold text-red-400 mt-1">₨0.00</div></div> </div> <div class="flex justify-end gap-3 pt-4"> <button type="button" id="cancel-purchase-btn" class="btn btn-danger">Cancel</button> <button type="submit" class="btn btn-success">Save</button> </div> </form> </div> </div>
<div id="edit-product-modal" class="modal-overlay no-print"> <div class="modal-content"> <h2 class="text-2xl font-bold mb-4">Edit Product</h2> <form id="edit-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end"> <div class="md:col-span-2"><label class="font-medium">Name</label><input type="text" id="edit-product-name" class="input-field" required></div> <div><label class="font-medium">Batch No.</label><input type="text" id="edit-product-batch-number" class="input-field"></div> <div><label class="font-medium">Category</label><select id="edit-product-category" class="input-field" required></select></div> <div><label class="font-medium">Cost Price</label><input type="number" id="edit-product-cost-price" class="input-field" required min="0" step="0.01"></div> <div><label class="font-medium">Sell Price</label><input type="number" id="edit-product-sell-price" class="input-field" required min="0" step="0.01"></div> <div><label class="font-medium">Stock</label><input type="number" id="edit-product-stock" class="input-field" required min="0"></div> <div><label class="font-medium">Expiry Date</label><input type="date" id="edit-product-expiry" class="input-field" required></div> <div class="md:col-span-2 flex justify-end gap-3 pt-4"> <button type="button" id="cancel-edit-product-btn" class="btn btn-danger">Cancel</button> <button type="submit" class="btn btn-success">Save</button> </div> </form> </div> </div>
<div id="return-sale-modal" class="modal-overlay no-print"> <div class="modal-content max-w-2xl"> <h2 class="text-2xl font-bold mb-4">Return Items from Invoice <span id="return-invoice-id" class="text-yellow-400"></span></h2> <form id="return-sale-form"> <div id="return-items-list" class="space-y-3 max-h-72 overflow-y-auto mb-4 p-2 bg-slate-800 rounded-lg"></div> <div class="flex justify-end gap-3 pt-4 border-t border-slate-700"> <button type="button" id="cancel-return-btn" class="btn btn-danger">Cancel</button> <button type="submit" class="btn btn-warning">Process Return</button> </div> </form> </div> </div>

<!-- Settle Credit Modal -->
<div id="settle-credit-modal" class="modal-overlay no-print">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-4">Settle Credit</h2>
    <form id="settle-credit-form" class="space-y-4">
      <input type="hidden" id="settle-credit-id">
      <div>Customer: <strong id="settle-customer-name"></strong></div>
      <div>Amount Due: <strong id="settle-amount-due" class="text-red-400"></strong></div>
      <hr class="border-slate-600">
      <div>
        <label class="font-medium">Amount Paid</label>
        <input type="number" id="settle-amount-paid" class="input-field" required min="0.01" step="0.01">
      </div>
      <div>Remaining: <strong id="settle-amount-remaining" class="text-yellow-400"></strong></div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" id="cancel-settle-credit-btn" class="btn btn-danger">Cancel</button>
        <button type="submit" class="btn btn-success">Save Payment</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getDatabase, ref, onValue, off, set, push, update, remove, runTransaction } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  // --- Firebase Configuration ---
  const firebaseConfig = {
    apiKey: "AIzaSyBdm5Ot1bjCq6Ytrul9L2UQo61oSmSeaa0",
    authDomain: "student-program-e6ed4.firebaseapp.com",
    databaseURL: "https://student-program-e6ed4-default-rtdb.firebaseio.com",
    projectId: "student-program-e6ed4",
    storageBucket: "student-program-e6ed4.firebasestorage.app",
    messagingSenderId: "466600750135",
    appId: "1:466600750135:web:a5f034144278156ef0a3b2"
  };

  // --- Initialize Firebase ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase(app);

  // --- Global State ---
  let currentUserUID = null;
  let currentUserEmail = null;
  let dbRefs = {};
  let dbListeners = [];
  let invoiceActionTaken = false; 

document.addEventListener('DOMContentLoaded', () => {
    
    if ('serviceWorker' in navigator) {
        // ***FIXED***: Changed 'worker.js' to 'service-worker.js'
        navigator.serviceWorker.register('service-worker.js')
            .then(reg => console.log('Service Worker registered successfully', reg))
            .catch(err => console.error('Service Worker registration failed:', err));
    }

    const loginContainer = document.getElementById('login-container');
    const appLayout = document.getElementById('app-layout');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserUID = user.uid;
            currentUserEmail = user.email;
            loginContainer.classList.add('hidden');
            appLayout.classList.remove('hidden');
            initAppForUser();
        } else {
            currentUserUID = null;
            currentUserEmail = null;
            loginContainer.classList.remove('hidden');
            appLayout.classList.add('hidden');
            cleanupListeners();
        }
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = loginForm['email-address'].value;
        const password = loginForm['password'].value;
        loginError.textContent = ''; 
        signInWithEmailAndPassword(auth, email, password)
            .catch((error) => {
                const errorCode = error.code;
                console.error("Login Error:", errorCode);
                if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password' || errorCode === 'auth/invalid-credential') {
                    loginError.textContent = 'ای میل یا پاس ورڈ غلط ہے۔';
                } else {
                    loginError.textContent = 'لاگ ان کے دوران ایک خرابی پیش آئی۔';
                }
            });
    });

    logoutBtn.addEventListener('click', () => {
        signOut(auth).catch((error) => console.error('Logout Error', error));
    });
    
    function cleanupListeners() {
        dbListeners.forEach(l => off(l.ref, l.type));
        dbListeners = [];
    }

    function initAppForUser() {
        if (!currentUserUID) return;
        
        dbRefs = {
            products: ref(database, `data/${currentUserUID}/products`),
            sales: ref(database, `data/${currentUserUID}/sales`),
            settings: ref(database, `data/${currentUserUID}/settings`),
            credit: ref(database, `data/${currentUserUID}/credit`),
            purchases: ref(database, `data/${currentUserUID}/purchases`)
        };

        const CATEGORIES = [
            { name: 'Tablets', color: '#FDBA74' }, { name: 'Syrups', color: '#93C5FD' }, { name: 'Injections', color: '#FCA5A5' }, 
            { name: 'Ointments', color: '#D8B4FE' }, { name: 'Drops', color: '#67E8F9' }, { name: 'Surgical', color: '#E5E7EB' }, { name: 'General', color: '#BEF264' },
        ];
        
        let state = { products: [], sales: [], cart: [], settings: {}, credit: [], purchases: [], discountType: 'amount', activeCategory: 'All' };
        const formatCurrency = (amount) => `₨${(parseFloat(amount) || 0).toFixed(2)}`;
        const getCategoryColor = (categoryName) => CATEGORIES.find(c => c.name === categoryName)?.color || '#D1D5DB';

        const showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            document.querySelectorAll('.nav-link[data-page]').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');
            updateAllPages();
            if (pageId === 'pos') renderCategoryFilters();
            if (pageId === 'settings') document.getElementById('logged-in-email').textContent = currentUserEmail;
            if (pageId === 'reports' && !document.getElementById('report-transactions-table').innerHTML) { 
                document.getElementById('report-daily-btn').click(); 
            }
        };
        document.querySelectorAll('.nav-link[data-page]').forEach(link => link.addEventListener('click', e => { e.preventDefault(); showPage(link.dataset.page); }));
        document.getElementById('sidebar-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        
        function updateAllPages(){
            updateDashboard();
            const activePage = document.querySelector('.page.active')?.id;
            if (activePage === 'pos') renderPosProducts();
            if (activePage === 'products') renderProductsTable();
            if (activePage === 'transactions') renderTransactionsPage();
            if (activePage === 'credit') renderCreditPage();
            if (activePage === 'suppliers') renderPurchasesPage();
        }
        
        function updateDashboard() {
            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999);
            const todaysSalesData = state.sales.filter(s => { const saleDate = new Date(s.date); return saleDate >= startOfDay && saleDate <= endOfDay; });
            const totalStockCost = state.products.reduce((sum, p) => sum + ((p.costPrice || 0) * (p.stock || 0)), 0);
            const totalStockSell = state.products.reduce((sum, p) => sum + ((p.sellingPrice || 0) * (p.stock || 0)), 0);
            const netSalesToday = todaysSalesData.reduce((sum, s) => sum + (s.total || 0), 0);
            const netProfitToday = todaysSalesData.reduce((sum, s) => sum + (s.profit || 0), 0);
            const totalCreditDue = state.credit.filter(c => !c.isPaid).reduce((sum, c) => sum + (c.total || 0), 0);
            document.getElementById('total-stock-value-cost').textContent = formatCurrency(totalStockCost);
            document.getElementById('total-stock-value-sell').textContent = formatCurrency(totalStockSell);
            document.getElementById('todays-sales').textContent = formatCurrency(netSalesToday);
            document.getElementById('todays-profit').textContent = formatCurrency(netProfitToday);
            document.getElementById('total-credit-due').textContent = formatCurrency(totalCreditDue);
            const salesCountToday = todaysSalesData.filter(s => s.status !== "Returned" && s.status !== "Partially Returned").flatMap(s => s.items).reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + item.quantity; return acc; }, {});
            document.getElementById('top-selling-products').innerHTML = Object.entries(salesCountToday).sort((a,b) => b[1] - a[1]).slice(0, 10).map(([name, count]) => `<div class="flex justify-between"><span>${name}</span> <b>${count} sold</b></div>`).join('') || '<p class="text-gray-400">No sales today.</p>';
            document.getElementById('low-stock-alerts').innerHTML = state.products.filter(p => p.stock > 0 && p.stock <= 10).map(p => `<div class="flex justify-between"><span>${p.name}</span> <b>${p.stock} left</b></div>`).join('') || '<p class="text-gray-400">No low stock products.</p>';
            const thirtyDaysFromNow = new Date(); thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
            document.getElementById('expiring-soon-alerts').innerHTML = state.products.filter(p => p.expiryDate && new Date(p.expiryDate) <= thirtyDaysFromNow && new Date(p.expiryDate) >= new Date()).sort((a,b) => new Date(a.expiryDate) - new Date(b.expiryDate)).map(p => `<div class="flex justify-between"><span>${p.name}</span> <b class="text-yellow-400">${p.expiryDate}</b></div>`).join('') || '<p class="text-gray-400">No products expiring soon.</p>';
            document.getElementById('out-of-stock-alerts').innerHTML = state.products.filter(p => p.stock === 0 || !p.stock).map(p => `<div class="flex justify-between"><span>${p.name}</span><b>Finished</b></div>`).join('') || '<p class="text-gray-400">All products are in stock.</p>';
        }

        function renderPosProducts() {
            const listEl = document.getElementById('product-list'); if (!listEl) return;
            const search = document.getElementById('product-search').value.toLowerCase();
            const categoryFiltered = state.activeCategory === 'All' ? state.products : state.products.filter(p => p.category === state.activeCategory);
            const filtered = categoryFiltered.filter(p => p.stock > 0 && (p.name.toLowerCase().includes(search) || (p.batchNumber && p.batchNumber.toLowerCase().includes(search))));
            listEl.innerHTML = filtered.map(p => {
                const cartItem = state.cart.find(item => item.id === p.id);
                const displayStock = p.stock - (cartItem ? cartItem.quantity : 0);
                const disabled = displayStock <= 0;
                const categoryColor = getCategoryColor(p.category);
                const stockColor = displayStock <= 10 ? '#dc2626' : '#000000'; // red-600 and black
                
                return `<div class="product-card-pos ${disabled ? 'disabled' : ''}" style="background-color: ${categoryColor};" ${!disabled ? `onclick="app.addToCart('${p.id}')"` : ''}>
                    <div class="product-name" style="color: #000000;">${p.name}</div>
                    <div class="product-details flex justify-between w-full">
                        <span style="color: #000000;">${formatCurrency(p.sellingPrice)}</span>
                        <span class="stock-text" style="color: ${stockColor};">Stock: ${displayStock}</span>
                    </div>
                </div>`;
            }).join('') || '<p class="col-span-full p-4">No products found.</p>';
        }

        function renderCategoryFilters() {
            const container = document.getElementById('category-filters'); if (!container) return;
            let buttonsHTML = `<button class="category-filter-btn ${state.activeCategory === 'All' ? 'active' : ''}" data-category="All" style="background-color: #4b5563;">All</button>`;
            buttonsHTML += CATEGORIES.map(cat => `<button class="category-filter-btn ${state.activeCategory === cat.name ? 'active' : ''}" data-category="${cat.name}" style="background-color: ${getCategoryColor(cat.name)}; color: #000000;">${cat.name}</button>`).join('');
            container.innerHTML = buttonsHTML;
            container.querySelectorAll('.category-filter-btn').forEach(btn => btn.addEventListener('click', (e) => { state.activeCategory = e.target.dataset.category; renderCategoryFilters(); renderPosProducts(); }));
        }
        
        function populateCategorySelects() {
            const addSelect = document.getElementById('product-category'); const editSelect = document.getElementById('edit-product-category');
            if(addSelect) addSelect.innerHTML = CATEGORIES.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            if(editSelect) editSelect.innerHTML = CATEGORIES.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        function renderTransactionsPage() {
            const tableBody = document.getElementById('transactions-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = state.sales.sort((a, b) => new Date(b.date) - new Date(a.date)).map(s => {
                let statusClass, statusText = s.status;
                switch(s.status) {
                    case 'Returned': statusClass = 'text-red-400'; break;
                    case 'Partially Returned': statusClass = 'text-orange-400'; break;
                    case 'Credit': statusClass = 'text-yellow-400'; break;
                    default: statusClass = 'text-green-400';
                }
                const returnBtnDisabled = s.status === 'Returned';
                return `<tr class="border-b dark:border-slate-700 hover:bg-slate-700">
                    <td class="p-3">${s.id}</td>
                    <td>${new Date(s.date).toLocaleString()}</td>
                    <td>${s.customerName || 'N/A'}</td>
                    <td class="${statusClass} font-semibold">${statusText}</td>
                    <td>${formatCurrency(s.total)}</td>
                    <td class="text-center space-x-2">
                        <button class="btn btn-sm btn-info" onclick="app.showInvoice('${s.id}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-sm btn-warning" onclick="app.showReturnModal('${s.id}')" ${returnBtnDisabled ? 'disabled' : ''}><i class="fas fa-undo"></i></button>
                    </td>
                </tr>`;
            }).join('') || `<tr><td colspan="6" class="text-center p-4">No transactions found.</td></tr>`;
        };
        
        const displayInvoice = (sale) => {
            if (!sale) return;
            invoiceActionTaken = false;
            const modal = document.getElementById('invoice-modal');
            modal.querySelector('#invoice-id').textContent = sale.id;
            modal.querySelector('#invoice-customer-name').textContent = sale.customerName;
            modal.querySelector('#invoice-date').textContent = new Date(sale.date).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
            modal.querySelector('#invoice-items').innerHTML = sale.items.map(item => `<tr><td class="text-left py-1">${item.name}</td><td class="text-center">${item.quantity}</td><td class="text-right">${(item.sellingPrice || 0).toFixed(2)}</td><td class="text-right">${formatCurrency(item.sellingPrice * item.quantity)}</td></tr>`).join('');
            modal.querySelector('#invoice-subtotal').textContent = formatCurrency(sale.subtotal);
            modal.querySelector('#invoice-discount').textContent = formatCurrency(sale.discount);
            modal.querySelector('#invoice-total').textContent = formatCurrency(sale.total);
            modal.classList.add('visible');
        };

        window.app = {
            addToCart: (id) => { const wasEmpty = state.cart.length === 0; const p = state.products.find(prod => prod.id === id); const existing = state.cart.find(i => i.id === id); const availableStock = p.stock - (existing ? existing.quantity : 0); if (availableStock <= 0) return; if (existing) { existing.quantity++; } else { state.cart.push({ ...p, quantity: 1 }); } renderCart(); if (wasEmpty && state.cart.length > 0) { document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('app-layout').classList.add('cart-open');} },
            removeFromCart: (id) => { state.cart = state.cart.filter(i => i.id !== id); renderCart(); if(state.cart.length === 0) {document.getElementById('cart-sidebar').classList.remove('open'); document.getElementById('app-layout').classList.remove('cart-open');} },
            updateCartQuantity: (id, change) => { const item = state.cart.find(i => i.id === id); if (!item) return; const p = state.products.find(prod => prod.id === id); if (change > 0 && p.stock <= item.quantity) return; item.quantity += change; if (item.quantity <= 0) app.removeFromCart(id); else renderCart(); },
            deleteProduct: (productId) => { if (confirm('Are you sure?')) remove(ref(database, `data/${currentUserUID}/products/${productId}`)); },
            showEditProductModal: (productId) => { const p = state.products.find(p => p.id === productId); if (!p) return; const form = document.getElementById('edit-product-form'); form.dataset.productId = productId; form.querySelector('#edit-product-name').value = p.name; form.querySelector('#edit-product-batch-number').value = p.batchNumber || ''; form.querySelector('#edit-product-category').value = p.category || 'General'; form.querySelector('#edit-product-cost-price').value = p.costPrice || 0; form.querySelector('#edit-product-sell-price').value = p.sellingPrice || 0; form.querySelector('#edit-product-stock').value = p.stock || 0; form.querySelector('#edit-product-expiry').value = p.expiryDate || ''; document.getElementById('edit-product-modal').classList.add('visible'); },
            showInvoice: (saleId) => { const sale = state.sales.find(s => s.id === saleId); displayInvoice(sale); },
            showReturnModal: (saleId) => {
                const sale = state.sales.find(s => s.id === saleId);
                if (!sale) return;
                const modal = document.getElementById('return-sale-modal');
                modal.querySelector('#return-invoice-id').textContent = sale.id;
                const listEl = modal.querySelector('#return-items-list');
                listEl.innerHTML = sale.items.map(item => {
                    const maxReturn = item.quantity - (item.returnedQty || 0);
                    if (maxReturn <= 0) return '';
                    return `<div class="grid grid-cols-3 gap-4 items-center">
                                <span class="col-span-1">${item.name} (Sold: ${item.quantity})</span>
                                <label class="text-sm">Qty to Return:</label>
                                <input type="number" data-item-id="${item.id}" data-max-return="${maxReturn}" class="input-field" value="0" min="0" max="${maxReturn}">
                            </div>`;
                }).join('');
                document.getElementById('return-sale-form').dataset.saleId = saleId;
                modal.classList.add('visible');
            },
            showSettleCreditModal: (creditId) => {
                const credit = state.credit.find(c => c.id === creditId);
                if (!credit) return;
                const modal = document.getElementById('settle-credit-modal');
                modal.querySelector('#settle-credit-id').value = credit.id;
                modal.querySelector('#settle-customer-name').textContent = credit.customerName;
                modal.querySelector('#settle-amount-due').textContent = formatCurrency(credit.total);
                const amountPaidInput = modal.querySelector('#settle-amount-paid');
                amountPaidInput.value = '';
                amountPaidInput.max = credit.total.toFixed(2);
                modal.querySelector('#settle-amount-remaining').textContent = formatCurrency(credit.total);
                modal.classList.add('visible');
            },
            deletePurchase: (purchaseId) => { if(confirm('Are you sure you want to delete this purchase record?')) { remove(ref(database, `data/${currentUserUID}/purchases/${purchaseId}`)); } }
        };

        // Render functions
        function renderCreditPage() { const tableBody = document.getElementById('credit-table-body'); if (!tableBody) return; tableBody.innerHTML = state.credit.sort((a, b) => new Date(b.date) - new Date(a.date)).map(c => `<tr class="border-b dark:border-slate-700 hover:bg-slate-700 ${c.isPaid ? 'opacity-50' : ''}"><td class="p-3">${c.saleId}</td><td>${new Date(c.date).toLocaleString()}</td><td>${c.customerName}</td><td>${c.customerPhone}</td><td class="font-bold text-red-400">${formatCurrency(c.total)}</td><td class="text-center">${c.isPaid ? '<span class="text-green-400 font-bold px-3 py-1 rounded-full bg-green-900/50">Paid</span>' : `<button class="btn btn-sm btn-success" onclick="app.showSettleCreditModal('${c.id}')">Settle</button>`}</td></tr>`).join('') || `<tr><td colspan="6" class="text-center p-4">No credit history.</td></tr>`; }
        function renderProductsTable() { const tableBody = document.getElementById('products-table-body'); if (!tableBody) return; tableBody.innerHTML = state.products.sort((a,b) => a.name.localeCompare(b.name)).map(p => `<tr class="border-b dark:border-slate-700 hover:bg-slate-700"><td class="p-3">${p.name}</td><td>${p.batchNumber || '-'}</td><td>${p.category || 'N/A'}</td><td>${formatCurrency(p.costPrice)}</td><td>${formatCurrency(p.sellingPrice)}</td><td>${p.stock || 0}</td><td>${p.expiryDate || 'N/A'}</td><td class="p-2 whitespace-nowrap"><button class="btn btn-sm btn-info" onclick="app.showEditProductModal('${p.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger ml-1" onclick="app.deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="8" class="text-center p-4">No products found. Add one to get started.</td></tr>`; };
        function renderPurchasesPage() { const tableBody = document.getElementById('purchases-table-body'); if (!tableBody) return; tableBody.innerHTML = state.purchases.sort((a,b) => new Date(b.date) - new Date(a.date)).map(p => { const remaining = (p.totalAmount || 0) - (p.amountPaid || 0); return `<tr class="border-b dark:border-slate-700 hover:bg-slate-700"><td class="p-3">${p.date}</td><td>${p.supplierName}</td><td>${formatCurrency(p.totalAmount)}</td><td>${formatCurrency(p.amountPaid)}</td><td class="font-bold text-red-400">${formatCurrency(remaining)}</td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="app.deletePurchase('${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }).join('') || `<tr><td colspan="6" class="text-center p-4">No purchase history found.</td></tr>`; };
        function renderSalesReport(startDate, endDate, title) { if (!document.getElementById('report-total-sales')) return; startDate.setHours(0, 0, 0, 0); endDate.setHours(23, 59, 59, 999); const filteredSales = state.sales.filter(s => { const saleDate = new Date(s.date); return saleDate >= startDate && saleDate <= endDate; }); const netSales = filteredSales.reduce((s, c) => s + (c.total || 0), 0); const netProfit = filteredSales.reduce((s, c) => s + (c.profit || 0), 0); const totalBills = filteredSales.length; document.getElementById('report-title').textContent = title; document.getElementById('report-total-sales').textContent = formatCurrency(netSales); document.getElementById('report-total-profit').textContent = formatCurrency(netProfit); document.getElementById('report-total-bills').textContent = totalBills; document.getElementById('report-transactions-table').innerHTML = filteredSales.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => `<tr class="border-b border-slate-600"><td class="p-2">${s.id}</td><td>${new Date(s.date).toLocaleString()}</td><td>${s.customerName}</td><td class="text-right">${formatCurrency(s.total)}</td><td class="text-right text-green-400">${formatCurrency(s.profit)}</td></tr>`).join('') || `<tr><td colspan="5" class="text-center p-4">No sales in this period.</td></tr>`; };
        const renderCart = () => { document.getElementById('cart-items').innerHTML = state.cart.map(item => `<div class="flex justify-between items-center bg-slate-800 p-2 rounded-md"><div><p class="font-medium text-amber-400">${item.name}</p><p class="text-sm text-gray-400">${formatCurrency(item.sellingPrice)} x ${item.quantity}</p></div><div class="flex items-center gap-3"><button class="w-6 h-6 bg-slate-600 rounded" onclick="app.updateCartQuantity('${item.id}', -1)">-</button><span>${item.quantity}</span><button class="w-6 h-6 bg-slate-600 rounded" onclick="app.updateCartQuantity('${item.id}', 1)">+</button><button class="text-red-500 ml-2" onclick="app.removeFromCart('${item.id}')"><i class="fas fa-times-circle"></i></button></div></div>`).join('') || '<p class="text-center mt-16 text-gray-400">Cart is empty.</p>'; updateCartTotals(); renderPosProducts(); };
        const updateCartTotals = () => { const subtotal = state.cart.reduce((sum, item) => sum + item.sellingPrice * item.quantity, 0); const discountValue = parseFloat(document.getElementById('cart-discount-value').value) || 0; let calculatedDiscount = 0; if (state.discountType === 'percent') { calculatedDiscount = (subtotal * discountValue) / 100; } else { calculatedDiscount = discountValue; } document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal); document.getElementById('cart-total').textContent = formatCurrency(Math.max(0, subtotal - calculatedDiscount)); };
        const resetPOS = () => { state.cart = []; document.getElementById('customer-name').value = ''; document.getElementById('cart-discount-value').value = 0; renderCart(); document.getElementById('cart-sidebar').classList.remove('open'); document.getElementById('app-layout').classList.remove('cart-open');};
        
        // Event listeners
        document.getElementById('cart-close-btn').addEventListener('click', () => { document.getElementById('cart-sidebar').classList.remove('open'); document.getElementById('app-layout').classList.remove('cart-open'); });
        document.getElementById('product-search').addEventListener('input', renderPosProducts);
        document.getElementById('cart-discount-value').addEventListener('input', updateCartTotals);
        const amountBtn = document.getElementById('discount-type-amount'), percentBtn = document.getElementById('discount-type-percent');
        amountBtn.addEventListener('click', () => { state.discountType = 'amount'; amountBtn.classList.replace('bg-slate-600', 'bg-blue-600'); percentBtn.classList.replace('bg-blue-600', 'bg-slate-600'); updateCartTotals(); });
        percentBtn.addEventListener('click', () => { state.discountType = 'percent'; percentBtn.classList.replace('bg-slate-600', 'bg-blue-600'); amountBtn.classList.replace('bg-blue-600', 'bg-slate-600'); updateCartTotals(); });
        document.getElementById('close-invoice-btn').addEventListener('click', () => { document.getElementById('invoice-modal').classList.remove('visible'); resetPOS(); });

        document.getElementById('print-invoice-btn').addEventListener('click', (e) => {
            if (invoiceActionTaken && !confirm("Are you sure you want to print this invoice again?")) return;
            const btn = e.currentTarget; btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Printing...`;
            document.body.classList.add('printing');
            setTimeout(() => { try { window.print(); } finally { document.body.classList.remove('printing'); btn.disabled = false; btn.innerHTML = `<i class="fas fa-print mr-2"></i>Print`; invoiceActionTaken = true; } }, 300);
        });

        document.getElementById('download-invoice-pdf-btn').addEventListener('click', async (e) => {
            if (invoiceActionTaken && !confirm("Are you sure you want to download this PDF again?")) return;
            const btn = e.currentTarget; btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Downloading...`;
            const el = document.getElementById('invoice-print-area-wrapper');
            el.classList.add('force-black-text'); // Force black text for PDF
            try {
                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(el, { scale: 3, useCORS: true, backgroundColor: '#ffffff'});
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: [80, 200] });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
                pdf.save(`invoice-${document.getElementById('invoice-id').textContent}.pdf`);
                invoiceActionTaken = true;
            } catch(err) { console.error("PDF download failed:", err); alert("Could not download PDF.");
            } finally { 
                el.classList.remove('force-black-text'); // Clean up class
                btn.disabled = false; btn.innerHTML = `<i class="fas fa-file-pdf mr-2"></i>Download PDF`; 
            }
        });

        // Report page buttons
        document.getElementById('report-daily-btn').addEventListener('click', () => { const today = new Date(); const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()); renderSalesReport(startOfDay, today, 'Today\'s Sales Report'); });
        document.getElementById('report-weekly-btn').addEventListener('click', () => { const today = new Date(); const dayOfWeek = today.getDay(); const startDate = new Date(today); startDate.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); startDate.setHours(0,0,0,0); renderSalesReport(startDate, new Date(), 'This Week\'s Sales Report'); });
        document.getElementById('report-monthly-btn').addEventListener('click', () => { const today = new Date(); const startDate = new Date(today.getFullYear(), today.getMonth(), 1); renderSalesReport(startDate, today, 'This Month\'s Sales Report'); });
        document.getElementById('report-filter-btn').addEventListener('click', () => { const start = document.getElementById('report-start-date').value; const end = document.getElementById('report-end-date').value; if(start && end) { renderSalesReport(new Date(start), new Date(end), `Report from ${start} to ${end}`); } else { alert('Please select both start and end dates.'); }});
        document.getElementById('print-report-btn').addEventListener('click', (e) => { const btn = e.currentTarget; btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Printing...`; document.body.classList.add('printing'); setTimeout(() => { try { window.print(); } finally { document.body.classList.remove('printing'); btn.disabled = false; btn.innerHTML = `<i class="fas fa-print mr-2"></i>Print Report`; } }, 300); });
        document.getElementById('download-report-pdf-btn').addEventListener('click', async (e) => { const btn = e.currentTarget; btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Downloading...`; try { const { jsPDF } = window.jspdf; const el = document.getElementById('report-print-area'); const canvas = await html2canvas(el, { scale: 2, useCORS: true }); const pdf = new jsPDF('p', 'mm', 'a4'); const imgWidth = 210; const pageHeight = 295; const imgHeight = canvas.height * imgWidth / canvas.width; let heightLeft = imgHeight; let position = 0; pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; while (heightLeft >= 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; } pdf.save(`sales-report-${new Date().toISOString().split('T')[0]}.pdf`); } catch(err) { console.error("Report PDF download failed:", err); alert("Could not download report PDF."); } finally { btn.disabled = false; btn.innerHTML = `<i class="fas fa-file-pdf mr-2"></i>Download PDF`; }});
        
        // Other Modals' cancel buttons
        document.getElementById('cancel-return-btn').onclick = () => document.getElementById('return-sale-modal').classList.remove('visible');
        document.getElementById('cancel-edit-product-btn').onclick = () => document.getElementById('edit-product-modal').classList.remove('visible');
        document.getElementById('cancel-credit-btn').onclick = () => document.getElementById('credit-modal').classList.remove('visible');
        document.getElementById('cancel-purchase-btn').onclick = () => document.getElementById('purchase-modal').classList.remove('visible');
        document.getElementById('cancel-settle-credit-btn').onclick = () => document.getElementById('settle-credit-modal').classList.remove('visible');
        document.getElementById('settings-form').addEventListener('submit', (e) => { e.preventDefault(); const settingsData = { contact: document.getElementById('setting-contact-number').value, email: document.getElementById('setting-email').value }; set(dbRefs.settings, settingsData).then(() => alert('Settings saved!')).catch(e => alert(e.message)); });
        
        // FIX: Supplier Purchase Logic
        document.getElementById('add-purchase-btn').addEventListener('click', () => { document.getElementById('purchase-modal').classList.add('visible'); document.getElementById('purchase-form').reset(); document.getElementById('purchase-amount-remaining').textContent = formatCurrency(0); });
        const purchaseTotal = document.getElementById('purchase-total-amount'); const purchasePaid = document.getElementById('purchase-amount-paid');
        const calculateRemaining = () => { const remaining = (parseFloat(purchaseTotal.value) || 0) - (parseFloat(purchasePaid.value) || 0); document.getElementById('purchase-amount-remaining').textContent = formatCurrency(remaining); };
        purchaseTotal.addEventListener('input', calculateRemaining); purchasePaid.addEventListener('input', calculateRemaining);
        document.getElementById('purchase-form').addEventListener('submit', (e) => { e.preventDefault(); const form = e.target; const newPurchaseKey = push(dbRefs.purchases).key; const newPurchase = { id: newPurchaseKey, supplierName: form['purchase-supplier-name'].value, contact: form['purchase-supplier-contact'].value, date: form['purchase-date'].value, totalAmount: parseFloat(form['purchase-total-amount'].value), amountPaid: parseFloat(form['purchase-amount-paid'].value) }; set(ref(database, `data/${currentUserUID}/purchases/${newPurchaseKey}`), newPurchase).then(() => { document.getElementById('purchase-modal').classList.remove('visible'); }).catch(e => alert('Error: ' + e.message)); });
        
        // Sale and Credit Logic
        async function handleSale(isCredit) {
            if (state.cart.length === 0) { alert('Cart is empty.'); return; }
            const saleBtn = document.getElementById('complete-sale-btn'); const creditBtn = document.getElementById('add-to-credit-btn');
            const originalSaleText = saleBtn.innerHTML; const originalCreditText = creditBtn.innerHTML;
            try {
                saleBtn.disabled = true; creditBtn.disabled = true;
                const loadingSpinner = `<i class="fas fa-spinner fa-spin mr-2"></i>`;
                saleBtn.innerHTML = `${loadingSpinner}Processing...`; creditBtn.innerHTML = `${loadingSpinner}Processing...`;
                const subtotal = state.cart.reduce((s, i) => s + (i.sellingPrice || 0) * i.quantity, 0); const discountValue = parseFloat(document.getElementById('cart-discount-value').value) || 0; let calculatedDiscount = (state.discountType === 'percent') ? (subtotal * discountValue) / 100 : discountValue; const total = Math.max(0, subtotal - calculatedDiscount); const profit = state.cart.reduce((s, i) => s + ((i.sellingPrice || 0) - (i.costPrice || 0)) * i.quantity, 0) - calculatedDiscount; const saleId = 'INV-' + Date.now();
                let customerName, customerPhone, saleStatus;
                if (isCredit) { const creditForm = document.getElementById('credit-form'); customerName = creditForm['credit-customer-name'].value; if (!customerName) { throw new Error('Customer Name is required for credit.'); } customerPhone = creditForm['credit-customer-phone'].value; saleStatus = 'Credit'; } else { customerName = document.getElementById('customer-name').value.trim() || 'Walk-in Customer'; saleStatus = 'Completed'; }
                const sale = { id: saleId, date: new Date().toISOString(), customerName, items: state.cart.map(i => ({...i})), subtotal, discount: calculatedDiscount, total, profit, status: saleStatus };
                const updates = {}; updates[`data/${currentUserUID}/sales/${sale.id}`] = sale;
                sale.items.forEach(item => { const p = state.products.find(p => p.id === item.id); if (p) { updates[`data/${currentUserUID}/products/${p.id}/stock`] = p.stock - item.quantity; } });
                if (isCredit) { const creditRecord = { id: push(dbRefs.credit).key, saleId: sale.id, date: sale.date, customerName: sale.customerName, customerPhone: customerPhone, total: sale.total, isPaid: false }; updates[`data/${currentUserUID}/credit/${creditRecord.id}`] = creditRecord; }
                await update(ref(database), updates);
                if (isCredit) { alert('Sale added to credit successfully!'); document.getElementById('credit-modal').classList.remove('visible'); resetPOS(); } else { displayInvoice(sale); }
            } catch (err) { alert('Error: ' + err.message); console.error(err);
            } finally { saleBtn.disabled = false; creditBtn.disabled = false; saleBtn.innerHTML = originalSaleText; creditBtn.innerHTML = originalCreditText; }
        }
        document.getElementById('complete-sale-btn').addEventListener('click', () => handleSale(false));
        document.getElementById('add-to-credit-btn').addEventListener('click', () => { if (state.cart.length === 0) { alert('Cart is empty.'); return; } const modal = document.getElementById('credit-modal'); document.getElementById('credit-customer-name').value = document.getElementById('customer-name').value; document.getElementById('credit-modal-total').textContent = document.getElementById('cart-total').textContent; modal.classList.add('visible'); });
        document.getElementById('credit-form').addEventListener('submit', (e) => { e.preventDefault(); handleSale(true); });
        
        // Product Management Logic
        document.getElementById('add-product-form').addEventListener('submit', e => { e.preventDefault(); const form = e.target; const newProductKey = push(dbRefs.products).key; const newProduct = { id: newProductKey, name: form['product-name'].value, batchNumber: form['product-batch-number'].value, category: form['product-category'].value, costPrice: parseFloat(form['product-cost-price'].value), sellingPrice: parseFloat(form['product-sell-price'].value), stock: parseInt(form['product-stock'].value), expiryDate: form['product-expiry'].value }; set(ref(database, `data/${currentUserUID}/products/${newProductKey}`), newProduct).then(() => { form.reset(); }).catch(e => alert('Error: ' + e.message)); });
        document.getElementById('edit-product-form').addEventListener('submit', (e) => { e.preventDefault(); const productId = e.target.dataset.productId; const updatedData = { name: document.getElementById('edit-product-name').value, batchNumber: document.getElementById('edit-product-batch-number').value, category: document.getElementById('edit-product-category').value, costPrice: parseFloat(document.getElementById('edit-product-cost-price').value), sellingPrice: parseFloat(document.getElementById('edit-product-sell-price').value), stock: parseInt(document.getElementById('edit-product-stock').value), expiryDate: document.getElementById('edit-product-expiry').value }; update(ref(database, `data/${currentUserUID}/products/${productId}`), updatedData).then(() => { document.getElementById('edit-product-modal').classList.remove('visible'); }).catch(e => alert('Error: ' + e.message)); });
        
        // Return & Settle Logic
        document.getElementById('return-sale-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target; const saleId = form.dataset.saleId; const saleRef = ref(database, `data/${currentUserUID}/sales/${saleId}`);
            const itemsToReturn = Array.from(form.querySelectorAll('input[type="number"]')).map(input => ({ id: input.dataset.itemId, qty: parseInt(input.value, 10) })).filter(item => item.qty > 0);
            if (itemsToReturn.length === 0) { alert('Please enter a quantity to return.'); return; }
            let totalReturnAmountGlobal = 0;
            try {
                await runTransaction(saleRef, (sale) => {
                    if (sale) { let totalReturnAmount = 0; let totalReturnProfit = 0;
                        itemsToReturn.forEach(returnItem => { const saleItem = sale.items.find(i => i.id === returnItem.id);
                            if (saleItem) { const returnedQty = saleItem.returnedQty || 0;
                                if (returnItem.qty > 0 && returnItem.qty <= (saleItem.quantity - returnedQty)) {
                                    saleItem.returnedQty = returnedQty + returnItem.qty; totalReturnAmount += returnItem.qty * saleItem.sellingPrice; totalReturnProfit += returnItem.qty * (saleItem.sellingPrice - saleItem.costPrice);
                                    const productRef = ref(database, `data/${currentUserUID}/products/${saleItem.id}/stock`); runTransaction(productRef, (currentStock) => (currentStock || 0) + returnItem.qty);
                                } } });
                        totalReturnAmountGlobal = totalReturnAmount; sale.total -= totalReturnAmount; sale.profit -= totalReturnProfit;
                        const allItemsReturned = sale.items.every(item => (item.returnedQty || 0) === item.quantity);
                        sale.status = allItemsReturned ? 'Returned' : 'Partially Returned';
                    } return sale;
                });
                if (totalReturnAmountGlobal > 0) { const creditRecord = state.credit.find(c => c.saleId === saleId);
                    if (creditRecord && !creditRecord.isPaid) { const creditRef = ref(database, `data/${currentUserUID}/credit/${creditRecord.id}`);
                        await runTransaction(creditRef, (credit) => { if (credit) { credit.total -= totalReturnAmountGlobal; if (credit.total <= 0.009) { credit.total = 0; credit.isPaid = true; } } return credit; });
                    } }
                alert('Return processed successfully!'); document.getElementById('return-sale-modal').classList.remove('visible');
            } catch (error) { console.error("Return failed: ", error); alert("An error occurred during the return process."); }
        });
        
        document.getElementById('settle-credit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target; const creditId = form['settle-credit-id'].value; const amountPaid = parseFloat(form['settle-amount-paid'].value);
            if(isNaN(amountPaid) || amountPaid <= 0) { alert("Please enter a valid amount."); return; }
            const creditRef = ref(database, `data/${currentUserUID}/credit/${creditId}`);
            try {
                await runTransaction(creditRef, (credit) => {
                    if (credit) { if (amountPaid > credit.total + 0.009) { return; } // Abort
                        credit.total -= amountPaid; if (credit.total <= 0.009) { credit.total = 0; credit.isPaid = true; }
                        if (!credit.payments) { credit.payments = []; } credit.payments.push({ amount: amountPaid, date: new Date().toISOString() });
                    } return credit;
                });
                alert("Payment saved successfully!"); document.getElementById('settle-credit-modal').classList.remove('visible');
            } catch (error) { console.error("Payment failed: ", error); alert("An error occurred while saving payment."); }
        });

        // Initialize listeners
        cleanupListeners();
        populateCategorySelects();
        const listenersToAttach = [
            { path: dbRefs.products, handler: (snap) => { state.products = snap.exists() ? Object.values(snap.val()) : []; }},
            { path: dbRefs.sales, handler: (snap) => { state.sales = snap.exists() ? Object.values(snap.val()) : []; }},
            { path: dbRefs.credit, handler: (snap) => { state.credit = snap.exists() ? Object.values(snap.val()) : []; }},
            { path: dbRefs.purchases, handler: (snap) => { state.purchases = snap.exists() ? Object.values(snap.val()) : []; }},
            { path: dbRefs.settings, handler: (snap) => { state.settings = snap.exists() ? snap.val() : {}; }}
        ];
        listenersToAttach.forEach(l => {
            const listener = onValue(l.path, (snapshot) => {
                l.handler(snapshot); updateAllPages();
                if (l.path === dbRefs.settings) {
                    document.getElementById('setting-contact-number').value = state.settings.contact || '';
                    document.getElementById('setting-email').value = state.settings.email || '';
                    document.getElementById('receipt-store-contact').textContent = state.settings.contact || '';
                    document.getElementById('receipt-store-email').textContent = state.settings.email || '';
                }
            });
            dbListeners.push({ ref: l.path, type: 'value', func: listener });
        });
        showPage('dashboard');
    }
});
</script>
</body>
</html>
