<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="KP SOFTWARE POS">
    <meta name="apple-mobile-web-app-title" content="KP SOFTWARE POS">
    <meta name="theme-color" content="#ffffff">
    <meta name="msapplication-navbutton-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-starturl" content="/">
    <link rel="icon" type="image/png" href="icons/icon-192.png"> 
    <link rel="apple-touch-icon" href="icons/icon-192.png"> 
    <link rel="manifest" href="manifest.json">

    <title>KP SOFTWARE - POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --bg-main: #f8fafc;
            --bg-content: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --bg-modal: #ffffff;
            --bg-modal-darker: #f3f4f6;

            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-input: #1e293b;
            --text-modal: #1e293b;
            
            --border-color: #e2e8f0;
        }

        body.dark {
            --bg-main: #0f172a;
            --bg-content: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --bg-modal: #1e293b;
            --bg-modal-darker: #334155;

            --text-primary: #e2e8f0;
            --text-secondary: #9ca3af;
            --text-input: #e2e8f0;
            --text-modal: #e2e8f0;
            
            --border-color: #4b5563;
        }
        
        body.light-pink {
            --bg-main: #fff0f5;
            --bg-content: #fff0f5;
            --bg-card: #ffffff;
            --bg-input: #faf7f7;
            --bg-modal: #ffffff;
            --bg-modal-darker: #fde6ea;

            --text-primary: #5c2c33;
            --text-secondary: #8c5b63;
            --text-input: #5c2c33;
            --text-modal: #5c2c33;

            --border-color: #fbc2c9;
        }
        
        body { font-family: 'Inter', 'Noto Nastaliq Urdu', sans-serif; background-color: var(--bg-main); color: var(--text-primary); overflow: hidden; }
        .main-layout { display: flex; flex-direction: column; min-height: 100vh; }
        
        .header-container {
            background-color: var(--bg-card);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .top-bar {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .top-nav { 
            padding: 0.5rem; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            overflow-x: auto;
            white-space: nowrap;
        }
        .top-nav::-webkit-scrollbar { height: 5px; }
        .top-nav::-webkit-scrollbar-track { background: transparent; }
        .top-nav::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        body.dark .top-nav::-webkit-scrollbar-thumb { background-color: #4b5563; }


        .nav-button { 
            display: inline-flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 0.5rem; 
            border-radius: 8px; 
            background-color: #f1f5f9; 
            border: 1px solid #e2e8f0; 
            transition: all 0.2s ease; 
            cursor: pointer; 
            min-width: 95px; 
            flex-shrink: 0;
        }
        body.dark .nav-button { background-color: #334155; border-color: #4b5563; }
        .nav-button:hover { background-color: #e2e8f0; border-color: #cbd5e1; transform: translateY(-2px); }
        body.dark .nav-button:hover { background-color: #475569; }
        .nav-button.active { background-color: #2563eb; border-color: #1d4ed8; }
        .nav-button.active span { color: white; }
        body.dark .nav-button.active { background-color: #2563eb; border-color: #3b82f6; }
        
        .nav-button i { font-size: 1.31rem; margin-bottom: 0.25rem; }
        .nav-button span { font-weight: 600; font-size: 0.75rem; text-align: center; color: #1e293b; }
        body.dark .nav-button span { color: #cbd5e1; }

        .main-content { flex-grow: 1; padding: 1.5rem; height: calc(100vh - 125px); overflow-y: auto; background-color: var(--bg-content); }
        
        #cart-sidebar {
            width: 400px; position: fixed; top: 0; right: 0; height: 100%; background-color: #1e293b;
            color: #e2e8f0; border-left: 1px solid #334155; transform: translateX(100%); 
            transition: transform 0.3s ease; z-index: 100; display: flex; flex-direction: column;
        }
        #cart-sidebar.open { transform: translateX(0); }
        .main-layout.cart-open .main-content { margin-right: 400px; transition: margin-right 0.3s ease; }
        .main-layout.cart-open .header-container { margin-right: 400px; transition: margin-right 0.3s ease; }


        .card { background-color: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); padding: 1.5rem; border: 1px solid var(--border-color); overflow-wrap: break-word; word-wrap: break-word; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.5px; border: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn:disabled { background-color: #94a3b8 !important; color: #e2e8f0 !important; cursor: not-allowed; opacity: 0.7; }
        body.dark .btn:disabled { background-color: #4b5563 !important; color: #9ca3af !important; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-info { background-color: #0ea5e9; color: white; }
        .btn-secondary { background-color: #64748b; color: white; }

        .input-field { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; background-color: var(--bg-input); color: var(--text-input); }
        .input-field:focus { box-shadow: 0 0 0 2px #2563eb; border-color: #2563eb; }
        .page { display: none; height: 100%; }
        .page.active { display: flex; flex-direction: column; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #product-card-view {
            column-gap: 0.75rem;
            column-count: 2;
        }
        @media (min-width: 640px) { #product-card-view { column-count: 3; } }
        @media (min-width: 768px) { #product-card-view { column-count: 4; } }
        @media (min-width: 1024px) { #product-card-view { column-count: 5; } }
        @media (min-width: 1280px) { #product-card-view { column-count: 6; } }
        @media (min-width: 1536px) { #product-card-view { column-count: 8; } }

        .product-card-pos { 
            position: relative; display: flex; flex-direction: column; justify-content: flex-end; 
            height: auto; width: 100%;
            min-height: 120px;
            border-radius: 8px; text-align: center; cursor: pointer; 
            transition: all 0.2s ease-in-out; background-size: cover; background-position: center;
            overflow: hidden;
            margin-bottom: 0.75rem;
            break-inside: avoid;
            border: 1px solid var(--border-color);
        }
        .product-card-pos:not(.disabled):hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .product-card-pos.disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(80%); }
        .product-card-pos.disabled:hover { transform: none; box-shadow: none; }
        .product-card-pos .info-overlay {
            color: white;
            padding: 0.75rem 0.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            background-color: rgba(0, 0, 0, 0.5);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .product-card-pos .product-name { 
            font-weight: 700; font-size: 0.875rem; line-height: 1.25rem; color: #FFFFFF;
        }
        .product-card-pos .product-formula { 
            font-size: 0.7rem; opacity: 0.9; line-height: 1rem; color: #FFFFFF;
        }
        .product-card-pos .product-details { 
            font-size: 0.75rem; line-height: 1rem; display: flex; justify-content: space-between; color: #FFFFFF;
        }
        .product-card-pos .product-details .stock-text { font-weight: 600; }

        #product-list-view .product-list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        #product-list-view .product-list-item:not(.disabled):hover {
            background-color: var(--bg-modal-darker);
            cursor: pointer;
        }
        #product-list-view .product-list-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .category-filter-btn { padding: 0.5rem 1rem; border-radius: 9999px; color: black; font-weight: 600; border: 2px solid transparent; transition: all 0.2s ease; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .category-filter-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .category-filter-btn.active { border-color: #1e293b; box-shadow: 0 0 10px rgba(30, 41, 59, 0.3); transform: scale(1.05); }
        body.dark .category-filter-btn.active { border-color: #ffffff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }


        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-overlay-top { z-index: 1010; }
        .modal-content { background-color: var(--bg-modal); color: var(--text-modal); padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 600px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-content.max-w-sm { max-width: 448px; }
        .modal-content.max-w-2xl { max-width: 768px; }
        .modal-content.max-w-4xl { max-width: 900px; }
        .modal-content.max-w-6xl { max-width: 1200px; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        .card *:not(i):not(button) { color: var(--text-primary); } 
        table, table *:not(i):not(button) { color: var(--text-primary); }
        table { width: 100%; } 
        td, th { word-wrap: break-word; overflow-wrap: break-word; }
        .overflow-x-auto table { table-layout: auto; }
        .overflow-x-auto th, .overflow-x-auto td { white-space: nowrap; }

        .card .text-gray-400 { color: var(--text-secondary) !important; }
        .text-red-400 { color: #f87171 !important; } 
        .text-red-500 { color: #ef4444 !important; }
        .text-red-700 { color: #b91c1c !important; }
        .text-green-500 { color: #22c55e !important; }
        .text-green-600 { color: #16a34a !important; }
        .text-yellow-500 { color: #eab308 !important; }
        .text-blue-500 { color: #3b82f6 !important; }
        .text-orange-500 { color: #f97316 !important; }
        .text-cyan-500 { color: #06b6d4 !important; }
        .text-purple-500 { color: #a855f7 !important; }
        .text-indigo-500 { color: #6366f1 !important; }
        .text-teal-500 { color: #14b8a6 !important; }
        .text-slate-500 { color: #64748b !important; }
        .text-fuchsia-500 { color: #d946ef !important; }
        .text-rose-500 { color: #f43f5e !important; }
        
        kbd {
            background-color: var(--bg-modal-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.1rem 0.4rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85em;
            font-weight: 700;
            box-shadow: 1px 1px 1px rgba(0,0,0,0.1);
        }

        .receipt-watermark {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10pt;
            font-weight: bold;
            color: var(--text-modal);
            opacity: 0.15;
            z-index: -1;
        }
        
        .modal-actions .btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; letter-spacing: normal; }
        .force-black-text, .force-black-text * { color: black !important; opacity: 1 !important; }
        .pdf-export-prepare { background: white !important; padding: 20px !important; width: 100% !important; box-sizing: border-box; }
        .pdf-export-prepare, .pdf-export-prepare * { color: black !important; background-color: transparent !important; text-shadow: none !important; box-shadow: none !important; border-color: #ddd !important; line-height: 1.4 !important; }
        .pdf-export-prepare h1, .pdf-export-prepare h2, .pdf-export-prepare h3 { font-size: 14pt !important; font-weight: bold !important; text-align: center !important; margin-bottom: 15px !important; margin-top: 10px !important; }
        .pdf-export-prepare .grid { display: flex !important; flex-wrap: wrap !important; justify-content: space-around !important; gap: 10px !important; margin-bottom: 20px !important; }
        .pdf-export-prepare .card { border: 1px solid #ccc !important; box-shadow: none !important; background-color: #f9f9f9 !important; padding: 8px !important; flex: 1; min-width: 150px; }
        .pdf-export-prepare .card p { font-size: 9pt !important; margin: 2px 0 !important; }
        .pdf-export-prepare .card .text-2xl, .pdf-export-prepare .card .text-3xl { font-size: 11pt !important; font-weight: bold; }
        .pdf-export-prepare table { width: 100% !important; border-collapse: collapse !important; margin-top: 15px !important; table-layout: auto !important; }
        .pdf-export-prepare th, .pdf-export-prepare td { border: 1px solid #ccc !important; padding: 5px 8px !important; font-size: 8pt !important; text-align: left !important; white-space: nowrap !important; }
        .pdf-export-prepare th { background-color: #eee !important; font-weight: bold !important; }
        .pdf-export-prepare .text-right { text-align: right !important; }
        .pdf-export-prepare .text-green-600 { color: #006400 !important; }
        .pdf-export-prepare .text-red-500 { color: #b22222 !important; }
        .pdf-export-prepare .overflow-y-auto, .pdf-export-prepare .overflow-auto, .pdf-export-prepare .overflow-x-auto { overflow: visible !important; height: auto !important; max-height: none !important; }
        .pdf-export-prepare table thead { display: table-header-group; }
        .pdf-export-prepare .sticky { position: static !important; }

        @media print {
            body > *:not(.printing-container) { display: none !important; }
            .printing-container { display: block !important; visibility: visible !important; position: absolute !important; left: 0 !important; top: 0 !important; margin: 0 !important; width: 100% !important; height: auto !important; background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .printing-container, .printing-container * { visibility: visible !important; color: black !important; background: transparent !important; box-shadow: none !important; text-shadow: none !important; border-color: #666 !important; }
            .no-print { display: none !important; }
            .printable-area { position: relative; z-index: 1; padding-bottom: 25px !important; }
            .printable-area::after { content: "KP SOFTWARE | 03139071038 | For software, contact on WhatsApp"; position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); opacity: 0.4; color: #4a5568; font-size: 8pt; z-index: 9999; max-width: 90%; text-align: center; }
            .printable-wrapper { width: 80mm !important; padding: 3mm !important; box-sizing: border-box !important; }
            .printable-wrapper h2 { font-size: 12pt !important; margin-bottom: 3px !important; }
            .printable-wrapper p, .printable-wrapper div, .printable-wrapper span, .printable-wrapper strong { font-size: 8pt !important; }
            .printable-wrapper table th, .printable-wrapper table td { padding: 1.5px 0 !important; font-size: 7.5pt !important; word-break: break-all !important; }
            .printable-wrapper hr { border-style: dashed !important; border-color: black !important; }
            .printable-full-page { padding: 10mm !important; }
            .printable-full-page h1, .printable-full-page h2, .printable-full-page h3 { text-align: center; }
            .printable-full-page h1 { font-size: 18pt !important; }
            .printable-full-page h2 { font-size: 15pt !important; }
            .printable-full-page h3 { font-size: 12pt !important; }
            .printable-full-page .card { border: 1px solid #ccc !important; background-color: #f9f9f9 !important; padding: 10px !important; box-shadow: none !important; page-break-inside: avoid; }
            .printable-full-page .overflow-y-auto, .printable-full-page .overflow-x-auto { overflow: visible !important; height: auto !important; max-height: none !important; }
            .printable-full-page table { width: 100% !important; border-collapse: collapse !important; page-break-inside: auto !important; table-layout: auto !important; }
            .printable-full-page tr { page-break-inside: avoid !important; page-break-after: auto !important; }
            .printable-full-page th, .printable-full-page td { border: 1px solid #ccc !important; padding: 6px !important; font-size: 9pt !important; white-space: normal !important; word-break: break-word; }
            .printable-full-page thead { display: table-header-group !important; }
            #barcode-print-area { text-align: center; }
            #barcode-print-area * { color: black !important; }
        }
    </style>
</head>
<body>

<div id="login-container" class="flex items-center justify-center min-h-screen" style="background-color: var(--bg-content);">
    <div class="w-full max-w-sm p-8 space-y-6 rounded-2xl shadow-2xl" style="background-color: var(--bg-card);">
        <div class="text-center">
            <i class="fas fa-laptop-code text-blue-500 text-6xl"></i>
            <h1 class="mt-5 text-3xl font-bold tracking-tight" style="color: var(--text-primary);">KP SOFTWARE</h1>
            <p class="mt-2" style="color: var(--text-secondary);">Welcome to the POS Software</p>
        </div>
        <form id="login-form" class="space-y-6">
            <div class="space-y-4">
                <div>
                    <label for="email-address" class="text-sm font-medium" style="color: var(--text-secondary);">Email Address</label>
                    <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field mt-1" placeholder="user@example.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium" style="color: var(--text-secondary);">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field mt-1" placeholder="••••••••">
                </div>
            </div>
            <p id="login-error" class="text-red-500 text-sm text-center h-4"></p>
            <div>
                <button type="submit" class="btn btn-primary w-full group text-base py-3">
                    <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                </button>
            </div>
        </form>
    </div>
</div>

<div id="app-layout" class="main-layout hidden">
    <header class="header-container no-print">
        <div class="top-bar">
            <i class="fas fa-laptop-code text-blue-500 text-3xl mr-4"></i>
            <h1 class="text-2xl font-bold" style="color: var(--text-primary);">KP SOFTWARE</h1>
        </div>
        <nav class="top-nav">
            <a href="#" class="nav-button" data-page="dashboard"><i class="fas fa-tachometer-alt text-blue-500"></i><span>DASHBOARD</span></a>
            <a href="#" class="nav-button" data-page="pos"><i class="fas fa-cash-register text-green-500"></i><span>SALE</span></a>
            <a href="#" class="nav-button" data-page="transactions"><i class="fas fa-history text-teal-500"></i><span>SALES HISTORY</span></a>
            <a href="#" class="nav-button" data-page="returned-bills"><i class="fas fa-undo text-orange-500"></i><span>SALE RETURN</span></a>
            <a href="#" class="nav-button" data-page="products"><i class="fas fa-box-open text-purple-500"></i><span>PRODUCTS</span></a>
            <a href="#" class="nav-button" data-page="suppliers"><i class="fas fa-truck text-indigo-500"></i><span>PURCHASE</span></a>
            <a href="#" class="nav-button" data-page="expenses"><i class="fas fa-wallet text-rose-500"></i><span>EXPENSE</span></a>
            <a href="#" class="nav-button" data-page="customers"><i class="fas fa-users text-cyan-500"></i><span>CUSTOMERS</span></a>
            <a href="#" class="nav-button" data-page="staff"><i class="fas fa-id-card-alt text-slate-500"></i><span>STAFF</span></a>
            <a href="#" class="nav-button" data-page="master-data"><i class="fas fa-database text-gray-500"></i><span>MASTER</span></a>
            <a href="#" class="nav-button" data-page="reports"><i class="fas fa-chart-pie text-fuchsia-500"></i><span>REPORTS</span></a>
            <a href="#" class="nav-button" data-page="day-end-report"><i class="fas fa-file-invoice-dollar text-yellow-500"></i><span>DAY-END</span></a>
            <a href="#" class="nav-button" data-page="settings"><i class="fas fa-cogs text-gray-600"></i><span>SETTINGS</span></a>
            <button id="logout-btn" class="nav-button !bg-red-500 hover:!bg-red-700">
                <i class="fas fa-sign-out-alt text-white"></i><span>LOGOUT</span>
            </button>
        </nav>
    </header>

    <main id="main-content" class="main-content">
        
        <div id="dashboard" class="page overflow-y-auto">
             <div class="flex-shrink-0 mb-6 card">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h2 class="text-xl font-bold">DASHBOARD</h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button class="btn btn-secondary btn-sm" id="db-today-btn">Today</button>
                        <button class="btn btn-secondary btn-sm" id="db-week-btn">This Week</button>
                        <button class="btn btn-secondary btn-sm" id="db-month-btn">This Month</button>
                        <span class="border-l h-8 mx-2" style="border-color: var(--border-color);"></span>
                        <label for="db-start-date" class="font-medium text-sm">From:</label>
                        <input type="date" id="db-start-date" class="input-field p-2 text-sm w-40">
                        <label for="db-end-date" class="font-medium text-sm">To:</label>
                        <input type="date" id="db-end-date" class="input-field p-2 text-sm w-40">
                        <button class="btn btn-primary btn-sm" id="db-filter-btn">Filter</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-4">
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">TOTAL SALES</h3><p id="dashboard-total-sales" class="text-2xl font-bold text-blue-500 mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">TOTAL PURCHASE</h3><p id="dashboard-total-purchase" class="text-2xl font-bold text-orange-500 mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">CREDIT RECEIVED</h3><p id="dashboard-credit-received" class="text-2xl font-bold text-cyan-500 mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">TOTAL EXPENSE</h3><p id="dashboard-total-expense" class="text-2xl font-bold text-purple-500 mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">TOTAL PROFIT</h3><p id="dashboard-total-profit" class="text-2xl font-bold text-green-500 mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">TOTAL VISITS</h3><p id="dashboard-total-visits" class="text-2xl font-bold text-indigo-500 mt-1">0</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">TOTAL RETURNS</h3><p id="dashboard-total-returns" class="text-2xl font-bold text-red-500 mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">CREDIT GIVEN</h3><p id="dashboard-credit-given" class="text-2xl font-bold text-yellow-500 mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">TOTAL PRODUCTS</h3><p id="dashboard-total-products" class="text-2xl font-bold mt-1">0</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">STOCK VALUE (COST)</h3><p id="dashboard-stock-value" class="text-2xl font-bold mt-1">Rs0.00</p></div>
                <div class="card p-4 text-center flex-grow basis-44"><h3 class="text-gray-400 text-sm font-semibold">EXPIRED LOSS</h3><p id="dashboard-expired-loss" class="text-2xl font-bold text-red-700 mt-1">Rs0.00</p></div>
             </div>
             
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <div class="card"><h3 class="text-xl font-semibold mb-4 text-red-500">Low Stock Alerts</h3><div id="low-stock-alerts" class="space-y-2 max-h-96 overflow-y-auto"></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4 text-yellow-500">Expiring Soon (Next 30 Days)</h3><div id="expiring-soon-alerts" class="space-y-2 max-h-96 overflow-y-auto"></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4 text-red-700">Already Expired Products</h3><div id="expired-alerts" class="space-y-2 max-h-96 overflow-y-auto"></div></div>
             </div>
             <div class="grid grid-cols-1 gap-6 mt-6">
                <div class="card"><h3 class="text-xl font-semibold mb-4">Top Selling Products</h3><div id="top-selling-products" class="space-y-3 max-h-96 overflow-y-auto"></div></div>
             </div>
        </div>

        <!-- POS Page -->
        <div id="pos" class="page flex-col">
            <div class="card flex flex-col flex-grow overflow-hidden">
                <div class="flex-shrink-0 mb-4">
                    <input type="text" id="product-search" placeholder="Search by Product Name, Barcode, Batch, or Formula..." class="input-field w-full mb-3">
                    <div class="flex justify-between items-center gap-4 flex-wrap">
                        <div id="category-filters" class="flex flex-wrap gap-2"></div>
                        <div class="flex gap-2 flex-wrap">
                           <select id="formula-filter-dropdown" class="input-field py-2 pr-8" style="min-width: 180px;"><option value="All">All Formulas</option></select>
                           <select id="group-filter-dropdown" class="input-field py-2 pr-8" style="min-width: 180px;"><option value="All">All Groups</option></select>
                        </div>
                    </div>
                </div>
                <div id="product-list-container" class="flex-grow overflow-y-auto p-1">
                    <div id="product-card-view"></div>
                    <div id="product-list-view" class="hidden"></div>
                </div>
            </div>
        </div>
        
        <!-- Hold Bills Page -->
        <div id="hold-bills" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Hold Bills</h1>
            <div id="hold-bills-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-grow overflow-y-auto p-1"></div>
        </div>
        
        <!-- Transactions Page -->
        <div id="transactions" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">All Transactions (Sales History)</h1>
            <div class="card flex-grow flex flex-col overflow-hidden">
                 <div class="mb-4 flex-shrink-0">
                    <input type="text" id="transaction-search" placeholder="Search by Invoice ID or Customer Name..." class="input-field w-full md:w-1/2">
                </div>
                 <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);">
                            <tr>
                                <th class="p-3">Invoice ID</th>
                                <th class="p-3">Date</th>
                                <th class="p-3">Customer</th>
                                <th class="p-3">Status</th>
                                <th class="p-3 text-right">Total</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
         <!-- Returned Bills Page -->
        <div id="returned-bills" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Returned Bills</h1>
            <div class="card flex-grow flex flex-col overflow-hidden">
                <div class="mb-4 flex-shrink-0">
                    <input type="text" id="returned-bills-search" placeholder="Search by Invoice ID..." class="input-field w-full md:w-1/2">
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);">
                            <tr>
                                <th class="p-3">Invoice ID</th>
                                <th class="p-3">Date</th>
                                <th class="p-3">Customer</th>
                                <th class="p-3 text-orange-400">Status</th>
                                <th class="p-3">Returned Items Value</th>
                                <th class="p-3 text-center">View Invoice</th>
                            </tr>
                        </thead>
                        <tbody id="returned-bills-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Page -->
        <div id="products" class="page flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h1 class="text-3xl font-bold">Product Management</h1>
                <div class="flex items-center gap-4">
                    <input type="text" id="product-table-search" placeholder="Search by Name, Barcode, Formula, Batch..." class="input-field w-80">
                    <button id="show-add-product-modal-btn" class="btn btn-primary whitespace-nowrap"><i class="fas fa-plus mr-2"></i>Add New Product</button>
                </div>
            </div>
            <div class="card flex-grow flex flex-col overflow-hidden">
                 <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);">
                            <tr>
                                <th class="p-3">Image</th>
                                <th class="p-3">Name</th>
                                <th class="p-3">Barcode</th>
                                <th class="p-3">Generic Name</th>
                                <th class="p-3">Batch</th>
                                <th class="p-3">Category</th>
                                <th class="p-3 text-right">Cost</th>
                                <th class="p-3 text-right">Sell</th>
                                <th class="p-3 text-center">Stock</th>
                                <th class="p-3">Expiry</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body"></tbody>
                    </table>
                 </div>
            </div>
        </div>

        <!-- Master Data Page -->
        <div id="master-data" class="page flex-col overflow-y-auto">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Master Data Management</h1>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="flex flex-col gap-6">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Group Management</h2>
                        <form id="add-group-form" class="flex items-end gap-4">
                            <div class="flex-grow"><label class="font-medium">Group Name</label><input type="text" id="group-name" class="input-field" required></div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add</button>
                        </form>
                         <div class="mt-6 max-h-60 overflow-y-auto">
                            <table class="w-full text-left">
                                <thead><tr style="background-color: var(--bg-modal-darker);"><th class="p-3">Name</th><th class="p-3 text-center">Actions</th></tr></thead>
                                <tbody id="groups-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Expense Category Management</h2>
                        <form id="add-expense-category-form" class="flex items-end gap-4">
                            <div class="flex-grow"><label class="font-medium">Category Name</label><input type="text" id="expense-category-name" class="input-field" placeholder="e.g., Utility Bills, Food" required></div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add</button>
                        </form>
                        <div class="mt-6 max-h-60 overflow-y-auto">
                             <table class="w-full text-left">
                                <thead><tr style="background-color: var(--bg-modal-darker);"><th class="p-3">Name</th><th class="p-3 text-center">Actions</th></tr></thead>
                                <tbody id="expense-categories-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-6">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Product Category Management</h2>
                        <form id="add-product-category-form" class="grid grid-cols-3 gap-4 items-end">
                            <div class="col-span-2"><label class="font-medium">Category Name</label><input type="text" id="product-category-name" class="input-field" placeholder="e.g., Cosmetics" required></div>
                            <div><label class="font-medium">Color</label><input type="color" id="product-category-color" class="input-field p-1 h-12" value="#BEF264"></div>
                            <button type="submit" class="btn btn-primary col-span-3"><i class="fas fa-plus mr-2"></i>Add Category</button>
                        </form>
                        <div class="mt-6 max-h-60 overflow-y-auto">
                             <table class="w-full text-left">
                                <thead><tr style="background-color: var(--bg-modal-darker);"><th class="p-3">Name</th><th class="p-3 text-center">Actions</th></tr></thead>
                                <tbody id="product-categories-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customers (Khata) Page -->
        <div id="customers" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Customer Management (Khata)</h1>
            <div class="card flex-grow flex flex-col overflow-hidden"> 
                <div class="flex justify-between items-center mb-4 flex-shrink-0"> 
                    <h2 class="text-xl font-bold">All Customers</h2> 
                    <button id="add-customer-btn" class="btn btn-primary"><i class="fas fa-user-plus mr-2"></i>Add New Customer</button> 
                </div> 
                <div class="overflow-x-auto flex-grow"> 
                    <table class="w-full text-left"> 
                        <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"> 
                            <tr> 
                                <th class="p-3">Name</th> 
                                <th class="p-3">Phone</th> 
                                <th class="p-3 text-red-400">Balance</th> 
                                <th class="p-3 text-center">Actions</th> 
                            </tr> 
                        </thead> 
                        <tbody id="customers-table-body"></tbody> 
                    </table> 
                </div> 
            </div> 
        </div>

        <!-- Suppliers Page (Purchase) -->
        <div id="suppliers" class="page flex-col"> 
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Supplier Purchases</h1>
            <div class="card flex-grow flex flex-col overflow-hidden"> 
                <div class="flex justify-between items-center mb-4 flex-shrink-0"> 
                    <h2 class="text-xl font-bold">Purchase History</h2> 
                    <button id="add-purchase-btn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add New Purchase</button> 
                </div> 
                <div class="overflow-x-auto flex-grow"> 
                    <table class="w-full text-left"> 
                        <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"> 
                            <tr> 
                                <th class="p-3">Supplier</th> 
                                <th class="p-3">Date</th>
                                <th class="p-3">Purchase ID</th>
                                <th class="p-3 text-right">Total Bill</th> 
                                <th class="p-3 text-right">Paid</th> 
                                <th class="p-3 text-red-400 text-right">Remaining</th> 
                                <th class="p-3 text-center">Actions</th> 
                            </tr> 
                        </thead> 
                        <tbody id="purchases-table-body"></tbody> 
                    </table> 
                </div> 
            </div> 
        </div>
        
        <!-- Staff Management Page -->
        <div id="staff" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Staff Management</h1>
            <div class="card flex-grow flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h2 class="text-xl font-bold">All Staff Members</h2>
                    <div class="flex gap-2">
                        <button id="show-staff-history-btn" class="btn btn-info"><i class="fas fa-history mr-2"></i>Transaction History</button>
                        <button id="add-staff-btn" class="btn btn-primary"><i class="fas fa-user-plus mr-2"></i>Add New Staff</button>
                    </div>
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);">
                            <tr>
                                <th class="p-3">Name</th>
                                <th class="p-3">Phone</th>
                                <th class="p-3">Role</th>
                                <th class="p-3 text-right">Salary</th>
                                <th class="p-3 text-yellow-400 text-right">Current Balance</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staff-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses Page -->
        <div id="expenses" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Expense Management</h1>
            <div class="card mb-6 flex-shrink-0">
                <h2 class="text-xl font-bold mb-4">Add New Expense</h2>
                <form id="add-expense-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="expense-category-select" class="font-medium">Category</label>
                        <select id="expense-category-select" class="input-field" required><option value="">-- Select Category --</option></select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="expense-description" class="font-medium">Description</label>
                        <input type="text" id="expense-description" class="input-field" placeholder="e.g., June Bill" required>
                    </div>
                    <div>
                        <label for="expense-amount" class="font-medium">Amount (₨)</label>
                        <input type="number" id="expense-amount" class="input-field" required min="0" step="0.01">
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary w-full"><i class="fas fa-plus mr-2"></i>Add Expense</button>
                    </div>
                </form>
            </div>
            <div class="card flex-grow flex flex-col overflow-hidden">
                <h2 class="text-xl font-bold mb-4 flex-shrink-0">All Expenses</h2>
                <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);">
                            <tr>
                                <th class="p-3">Date</th>
                                <th class="p-3">Category</th>
                                <th class="p-3">Description</th>
                                <th class="p-3 text-right">Amount</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="reports" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Sales Reports</h1>
            <div class="card flex-grow flex flex-col overflow-hidden">
                <div class="flex flex-wrap justify-between items-center mb-4 no-print gap-4 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-info" id="report-daily-btn">Today</button>
                        <button class="btn btn-sm btn-info" id="report-weekly-btn">This Week</button>
                        <button class="btn btn-sm btn-info" id="report-monthly-btn">This Month</button>
                    </div>
                    <div class="flex items-center gap-4">
                        <div><label for="report-start-date" class="text-sm">Start</label><input type="date" id="report-start-date" class="input-field p-2 text-sm"></div>
                        <div><label for="report-end-date" class="text-sm">End</label><input type="date" id="report-end-date" class="input-field p-2 text-sm"></div>
                        <button class="btn btn-primary btn-sm" id="report-filter-btn">Filter</button>
                    </div>
                     <div class="flex items-center gap-2">
                        <label for="report-type-select" class="text-sm">Report by:</label>
                        <select id="report-type-select" class="input-field p-2 text-sm">
                            <option value="invoice">Invoice</option>
                            <option value="formula">Generic Name</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="print-report-btn" class="btn bg-gray-600"><i class="fas fa-print mr-2"></i>Print</button>
                        <button id="download-report-pdf-btn" class="btn bg-blue-700"><i class="fas fa-file-pdf mr-2"></i>Download</button>
                    </div>
                </div>
                <div id="report-print-area" class="flex-grow overflow-y-auto printable-area">
                    <h2 id="report-title" class="text-center text-3xl font-bold my-4">Sales Summary Report</h2>
                    <div class="grid grid-cols-3 gap-4 my-6">
                        <div class="card text-center"><p>Net Sales</p><p id="report-total-sales" class="text-2xl font-bold">₨0.00</p></div>
                        <div class="card text-center"><p>Net Profit</p><p id="report-total-profit" class="text-2xl font-bold text-green-600">₨0.00</p></div>
                        <div class="card text-center"><p>Total Bills/Items</p><p id="report-total-bills" class="text-2xl font-bold">0</p></div>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead id="report-table-head" class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"></thead><tbody id="report-transactions-table"></tbody></table></div>
                </div>
            </div>
        </div>
        
        <!-- Day-End Report Page -->
        <div id="day-end-report" class="page flex-col">
            <h1 class="text-3xl font-bold mb-6 flex-shrink-0">Day-End Summary Report</h1>
            <div class="card flex-grow flex flex-col overflow-hidden">
                <div class="flex flex-wrap justify-between items-center mb-4 no-print gap-4 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <div><label for="dayend-start-date" class="text-sm">Start Date</label><input type="date" id="dayend-start-date" class="input-field p-2 text-sm"></div>
                        <div><label for="dayend-end-date" class="text-sm">End Date</label><input type="date" id="dayend-end-date" class="input-field p-2 text-sm"></div>
                        <button class="btn btn-primary btn-sm" id="dayend-filter-btn">Generate Report</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="print-dayend-report-btn" class="btn bg-gray-600"><i class="fas fa-print mr-2"></i>Print</button>
                        <button id="download-dayend-report-pdf-btn" class="btn bg-blue-700"><i class="fas fa-file-pdf mr-2"></i>Download</button>
                    </div>
                </div>
                <div id="dayend-report-print-area" class="flex-grow overflow-y-auto printable-area">
                    <h2 id="dayend-report-title" class="text-center text-3xl font-bold my-4">Day-End Report</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 my-6">
                        <div class="card text-center"><p>Total Sales</p><p id="dayend-total-sales" class="text-2xl font-bold text-blue-500">₨0.00</p></div>
                        <div class="card text-center"><p>Total Profit</p><p id="dayend-total-profit" class="text-2xl font-bold text-green-600">₨0.00</p></div>
                        <div class="card text-center"><p>Credit Given</p><p id="dayend-credit-given" class="text-2xl font-bold text-red-500">₨0.00</p></div>
                        <div class="card text-center"><p>Credit Received</p><p id="dayend-credit-received" class="text-2xl font-bold text-cyan-500">₨0.00</p></div>
                        <div class="card text-center"><p>Total Expenses</p><p id="dayend-total-expenses" class="text-2xl font-bold text-purple-500">₨0.00</p></div>
                        <div class="card text-center"><p>Cash In Hand</p><p id="dayend-cash-in-hand" class="text-2xl font-bold text-yellow-500">₨0.00</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6 mt-6">
                        <div class="lg:col-span-1">
                            <h3 class="text-xl font-semibold mb-2">Sales of the Day</h3>
                            <div class="overflow-x-auto max-h-80"><table class="w-full text-left"><thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"><tr><th class="p-2">Invoice</th><th>Customer</th><th class="text-right">Total</th></tr></thead><tbody id="dayend-sales-table"></tbody></table></div>
                        </div>
                        <div class="lg:col-span-1">
                            <h3 class="text-xl font-semibold mb-2">Purchases of the Day</h3>
                            <div class="overflow-x-auto max-h-80"><table class="w-full text-left"><thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"><tr><th class="p-2">Supplier</th><th>ID</th><th class="text-right">Total</th></tr></thead><tbody id="dayend-purchases-table"></tbody></table></div>
                        </div>
                         <div class="lg:col-span-1">
                            <h3 class="text-xl font-semibold mb-2">Expenses of the Day</h3>
                            <div class="overflow-x-auto max-h-80"><table class="w-full text-left"><thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"><tr><th class="p-2">Description</th><th class="text-right">Amount</th></tr></thead><tbody id="dayend-expenses-table"></tbody></table></div>
                        </div>
                         <div class="lg:col-span-1">
                            <h3 class="text-xl font-semibold mb-2">Expired Products in Period</h3>
                            <div class="overflow-x-auto max-h-80"><table class="w-full text-left"><thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"><tr><th class="p-2">Product</th><th>Stock</th><th class="text-right">Cost Loss</th></tr></thead><tbody id="dayend-expired-table"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings" class="page overflow-y-auto">
            <h1 class="text-3xl font-bold mb-6">Settings</h1>
            <div class="card max-w-4xl mx-auto">
                <div class="mb-6 p-4 rounded-lg" style="background-color: var(--bg-modal-darker);">
                    <p class="text-sm" style="color: var(--text-secondary);">Logged in as:</p>
                    <p id="logged-in-email" class="text-lg font-semibold"></p>
                </div>
                <form id="settings-form" class="space-y-6">
                    <div><label for="setting-store-name" class="font-medium">Store Name (for receipts)</label><input type="text" id="setting-store-name" class="input-field mt-1" placeholder="Inam Medical Store"></div>
                    <div><label for="setting-store-address" class="font-medium">Store Address (for receipts)</label><input type="text" id="setting-store-address" class="input-field mt-1" placeholder="123 Main Street, City"></div>
                    <div><label for="setting-contact-number" class="font-medium">Store Contact</label><input type="text" id="setting-contact-number" class="input-field mt-1"></div>
                    <div><label for="setting-email" class="font-medium">Store Email</label><input type="email" id="setting-email" class="input-field mt-1"></div>
                    
                    <div class="pt-4 border-t" style="border-color: var(--border-color);">
                         <h3 class="text-lg font-semibold mb-2">Financial Settings</h3>
                        <div>
                            <label for="setting-discount-type" class="font-medium">Default Discount Type</label>
                            <select id="setting-discount-type" class="input-field mt-1">
                                <option value="amount">Amount (₨)</option>
                                <option value="percent">Percentage (%)</option>
                            </select>
                        </div>
                        <div class="mt-4 flex items-center gap-4">
                           <input type="checkbox" id="setting-tax-enabled" class="h-5 w-5 rounded">
                           <label for="setting-tax-enabled" class="font-medium">Enable Sales Tax</label>
                           <input type="number" id="setting-tax-rate" class="input-field w-24" min="0" placeholder="e.g., 5">
                           <label for="setting-tax-rate" class="font-medium">%</label>
                        </div>
                         <div class="mt-4 flex items-center gap-4">
                           <input type="checkbox" id="setting-service-charge-enabled" class="h-5 w-5 rounded">
                           <label for="setting-service-charge-enabled" class="font-medium">Enable Service Charge</label>
                           <input type="number" id="setting-service-charge-rate" class="input-field w-24" min="0" placeholder="e.g., 3">
                           <label for="setting-service-charge-rate" class="font-medium">%</label>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t" style="border-color: var(--border-color);">
                        <h3 class="text-lg font-semibold mb-2">POS & Printer Settings</h3>
                        <div>
                            <label for="setting-pos-view" class="font-medium">Sale Screen View</label>
                            <select id="setting-pos-view" class="input-field mt-1">
                                <option value="card">Card View (Images)</option>
                                <option value="list">List View (Table)</option>
                            </select>
                        </div>
                        <div class="mt-4">
                            <label for="setting-printer-type" class="font-medium">Default Printer Type</label>
                            <select id="setting-printer-type" class="input-field mt-1">
                                <option value="thermal">Thermal Receipt (80mm)</option>
                                <option value="a4">A4 / Full Page</option>
                            </select>
                        </div>
                    </div>

                    <div class="pt-4 flex items-center gap-4">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Save Settings</button>
                        <button type="button" id="show-help-modal-btn" class="btn btn-info"><i class="fas fa-question-circle mr-2"></i>View Help & Shortcuts</button>
                    </div>
                </form>

                <div class="mt-8 pt-6 border-t" style="border-color: var(--border-color);">
                    <h3 class="text-lg font-semibold mb-4 text-center" style="color: var(--text-primary);">Appearance</h3>
                    <div id="theme-buttons-container" class="flex justify-center items-center gap-4">
                        <button data-theme="light" class="theme-setting-btn btn btn-sm" style="background-color: #f1f5f9; color: #0f172a; border: 1px solid #0f172a;">Light</button>
                        <button data-theme="dark" class="theme-setting-btn btn btn-sm" style="background-color: #1e293b; color: #e2e8f0; border: 1px solid #e2e8f0;">Dark</button>
                        <button data-theme="light-pink" class="theme-setting-btn btn btn-sm" style="background-color: #fff0f5; color: #5c2c33; border: 1px solid #5c2c33;">Light Pink</button>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t text-center" style="border-color: var(--border-color);">
                    <p class="mb-3" style="color: var(--text-secondary);">For software updates or support, contact the developer:</p>
                    <a href="https://wa.me/923139071038" target="_blank" class="btn btn-success">
                        <i class="fab fa-whatsapp mr-2"></i>Contact on WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Right Cart Sidebar -->
    <aside id="cart-sidebar" class="no-print">
        <div class="p-4 flex justify-between items-center h-20 border-b" style="border-color: #334155;"> <h2 class="text-2xl font-bold">Current Sale</h2> <button id="cart-close-btn" class="text-2xl hover:text-red-500 transition-colors">&times;</button> </div>
        <div id="cart-items" class="p-4 space-y-3 flex-grow overflow-y-auto"></div>
        <div class="p-4 border-t space-y-3" style="border-color: #334155;">
            <div class="flex justify-between font-medium"><span>Subtotal</span><span id="cart-subtotal">₨0.00</span></div>
            <div class="flex justify-between items-center font-medium">
                <label for="cart-discount-value" id="cart-discount-label">Discount</label>
                <input type="number" id="cart-discount-value" value="0" class="input-field w-28 text-right bg-transparent !text-white" min="0">
            </div>
            <div id="cart-tax-row" class="flex justify-between font-medium" style="display: none;"><span>Tax</span><span id="cart-tax">₨0.00</span></div>
            <div id="cart-service-charge-row" class="flex justify-between font-medium" style="display: none;"><span>Service Charge</span><span id="cart-service-charge">₨0.00</span></div>
            <div class="flex justify-between font-bold text-2xl border-t pt-2 mt-2" style="border-color: #334155;"><span>Total</span><span id="cart-total">₨0.00</span></div>
            <div class="mt-4"><label for="pos-customer-input" class="font-medium">Customer Name</label><input type="text" id="pos-customer-input" placeholder="Walk-in Customer" class="input-field mt-1 bg-transparent !text-white"></div>
        </div>
        <div class="grid grid-cols-2 gap-3 p-4">
            <button id="hold-sale-btn" class="btn btn-info w-full text-lg"><i class="fas fa-pause mr-2"></i>Hold</button>
            <button id="cancel-sale-btn" class="btn btn-danger w-full text-lg"><i class="fas fa-times mr-2"></i>Cancel</button>
            <button id="credit-sale-btn" class="btn btn-warning w-full text-lg"><i class="fas fa-book mr-2"></i>Credit</button>
            <button id="complete-sale-btn" class="btn btn-success w-full text-lg"><i class="fas fa-check-circle mr-2"></i>Finalize</button>
        </div>
    </aside>
</div>

<!-- All Modals -->
<div id="invoice-modal" class="modal-overlay modal-overlay-top no-print"> 
    <div class="modal-content max-w-sm w-full">
        <div id="invoice-print-area-wrapper" class="p-4">
            <div id="invoice-print-area" class="printable-area">
                <div class="receipt-watermark">KP SOFTWARE</div>
                <div class="text-center mb-4"> 
                    <i class="fas fa-clinic-medical text-blue-500 text-3xl mb-1"></i>
                    <h2 id="receipt-store-name" class="text-xl font-extrabold tracking-wider">Store Name</h2> 
                    <p id="receipt-store-address" class="text-xs"></p>
                    <p id="receipt-store-contact" class="text-xs"></p> 
                    <p id="receipt-store-email" class="text-xs"></p> 
                </div> 
                <hr class="my-2 border-dashed"> 
                <div class="text-xs mb-2 space-y-1"> 
                    <div class="flex justify-between"><strong>Invoice:</strong> <span id="invoice-id"></span></div> 
                    <div class="flex justify-between"><strong>Customer:</strong> <span id="invoice-customer-name"></span></div> 
                    <div class="flex justify-between"><strong>Date:</strong> <span id="invoice-date"></span></div> 
                </div> 
                <hr class="my-2 border-dashed"> 
                <table class="w-full text-xs mb-2"> 
                    <thead> 
                        <tr class="border-b-2 border-dashed"> 
                            <th class="text-left py-1">ITEM</th> 
                            <th class="text-center">QTY</th> 
                            <th class="text-right">PRICE</th> 
                            <th class="text-right">TOTAL</th> 
                        </tr> 
                    </thead> 
                    <tbody id="invoice-items" class="divide-y divide-dashed"></tbody> 
                </table> 
                <hr class="my-2 border-dashed"> 
                <div class="text-xs space-y-1"> 
                    <div class="flex justify-between"><span>Subtotal:</span><span id="invoice-subtotal"></span></div> 
                    <div class="flex justify-between"><span>Discount:</span><span id="invoice-discount"></span></div> 
                    <div id="invoice-tax-row" style="display: none;" class="flex justify-between"><span>Tax:</span><span id="invoice-tax"></span></div> 
                    <div id="invoice-service-charge-row" style="display: none;" class="flex justify-between"><span>Service Charge:</span><span id="invoice-service-charge"></span></div> 
                    <div class="flex justify-between font-bold text-base border-t-2 border-dashed mt-1 pt-1"><span>Grand Total:</span><span id="invoice-total"></span></div> 
                </div> 
                <p class="text-center text-xs mt-4 mb-8">Thank you for your visit!</p> 
            </div>
        </div>
        <div class="flex justify-end gap-3 p-4 rounded-b-lg no-print modal-actions" style="background-color: var(--bg-modal-darker);"> 
            <button id="print-invoice-btn" class="btn bg-gray-600 text-white"><i class="fas fa-print mr-2"></i>Print</button> 
            <button id="download-invoice-pdf-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button> 
            <button id="close-invoice-btn" class="btn btn-danger"><i class="fas fa-times mr-2"></i>Close</button> 
        </div> 
    </div> 
</div>

<!-- Add Product Modal -->
<div id="add-product-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-4xl">
        <h2 class="text-2xl font-bold mb-4">Add New Product</h2>
        <form id="add-product-form">
            <input type="hidden" id="add-product-new-id">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div><label class="font-medium">Product Name</label><input type="text" id="add-product-name" class="input-field" required></div>
                <div><label class="font-medium">Generic Name / Formula</label><input type="text" id="add-product-generic-name" class="input-field"></div>
                <div><label class="font-medium">Batch Number</label><input type="text" id="add-product-batch-number" class="input-field"></div>
                <div>
                    <label class="font-medium">Barcode</label>
                    <div class="flex">
                        <input type="text" id="add-product-barcode" class="input-field rounded-r-none" placeholder="Scan or generate...">
                        <button type="button" data-target-input="add-product-barcode" class="scan-barcode-btn btn btn-secondary rounded-l-none !px-3" title="Scan with Camera"><i class="fas fa-camera"></i></button>
                        <button type="button" id="add-generate-barcode-btn" class="btn btn-info rounded-l-none !px-3" title="Generate Barcode"><i class="fas fa-barcode"></i></button>
                    </div>
                </div>
                <div><label class="font-medium">Category</label><select id="add-product-category" class="input-field" required><option value="">-- Select Category --</option></select></div>
                <div><label class="font-medium">Group</label><select id="add-product-group" class="input-field"><option value="">-- No Group --</option></select></div>
                <div><label class="font-medium">Cost Price</label><input type="number" id="add-product-cost-price" class="input-field" required min="0" step="0.01"></div>
                <div><label class="font-medium">Sell Price</label><input type="number" id="add-product-sell-price" class="input-field" required min="0" step="0.01"></div>
                <div><label class="font-medium">Stock</label><input type="number" id="add-product-stock" class="input-field" required min="0"></div>
                <div><label class="font-medium">Low Stock Threshold</label><input type="number" id="add-product-low-stock" class="input-field" required min="0" value="10"></div>
                <div><label class="font-medium">Expiry Date</label><input type="date" id="add-product-expiry" class="input-field" required></div>
                <div class="lg:col-span-3 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div><label class="font-medium">Product Image (Upload)</label><input type="file" id="add-product-image" class="input-field" accept="image/*"></div>
                    <div><label class="font-medium">Product Image (URL)</label><input type="url" id="add-product-image-url" class="input-field" placeholder="https://example.com/image.jpg"></div>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t modal-actions" style="border-color: var(--border-color);">
                <button type="button" id="cancel-add-product-btn" class="btn btn-danger">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="edit-product-modal" class="modal-overlay no-print"> 
    <div class="modal-content max-w-4xl"> 
        <h2 class="text-2xl font-bold mb-4">Edit Product</h2> 
        <form id="edit-product-form"> 
            <input type="hidden" id="edit-product-id"> 
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div><label class="font-medium">Product Name</label><input type="text" id="edit-product-name" class="input-field" required></div>
                <div><label class="font-medium">Generic Name / Formula</label><input type="text" id="edit-product-generic-name" class="input-field"></div>
                <div><label class="font-medium">Batch No.</label><input type="text" id="edit-product-batch-number" class="input-field"></div> 
                 <div>
                    <label class="font-medium">Barcode</label>
                    <div class="flex">
                        <input type="text" id="edit-product-barcode" class="input-field rounded-r-none">
                        <button type="button" data-target-input="edit-product-barcode" class="scan-barcode-btn btn btn-secondary rounded-l-none !px-3" title="Scan with Camera"><i class="fas fa-camera"></i></button>
                        <button type="button" id="edit-generate-barcode-btn" class="btn btn-info rounded-l-none !px-3" title="Generate Barcode"><i class="fas fa-barcode"></i></button>
                    </div>
                </div>
                <div><label class="font-medium">Category</label><select id="edit-product-category" class="input-field" required><option value="">-- Select Category --</option></select></div> 
                <div><label class="font-medium">Group</label><select id="edit-product-group" class="input-field"><option value="">-- No Group --</option></select></div> 
                <div><label class="font-medium">Cost Price</label><input type="number" id="edit-product-cost-price" class="input-field" required min="0" step="0.01"></div> 
                <div><label class="font-medium">Sell Price</label><input type="number" id="edit-product-sell-price" class="input-field" required min="0" step="0.01"></div> 
                <div><label class="font-medium">Stock</label><input type="number" id="edit-product-stock" class="input-field" required min="0"></div> 
                <div><label class="font-medium">Low Stock Threshold</label><input type="number" id="edit-product-low-stock" class="input-field" required min="0"></div>
                <div><label class="font-medium">Expiry Date</label><input type="date" id="edit-product-expiry" class="input-field" required></div> 
                <div class="lg:col-span-3 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div><label class="font-medium">Change Image (Upload)</label><input type="file" id="edit-product-image" class="input-field" accept="image/*"></div>
                    <div><label class="font-medium">Product Image (URL)</label><input type="url" id="edit-product-image-url" class="input-field" placeholder="https://example.com/image.jpg"></div>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 modal-actions border-t" style="border-color: var(--border-color);"> 
                <button type="button" id="cancel-edit-product-btn" class="btn btn-danger">Cancel</button> 
                <button type="submit" class="btn btn-success">Save Changes</button> 
            </div> 
        </form> 
    </div> 
</div>

<!-- Edit Category Modal -->
<div id="edit-category-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-sm">
        <h2 class="text-2xl font-bold mb-4">Edit Product Category</h2>
        <form id="edit-category-form">
            <input type="hidden" id="edit-category-id">
            <div class="space-y-4">
                <div>
                    <label class="font-medium">Category Name</label>
                    <input type="text" id="edit-category-name" class="input-field" required>
                </div>
                <div>
                    <label class="font-medium">Color</label>
                    <input type="color" id="edit-category-color" class="input-field p-1 h-12">
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 mt-4 border-t modal-actions" style="border-color: var(--border-color);">
                <button type="button" id="cancel-edit-category-btn" class="btn btn-danger">Cancel</button>
                <button type="submit" class="btn btn-success">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Barcode Print Modal -->
<div id="barcode-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-sm">
        <h2 class="text-2xl font-bold mb-4">Print Barcode</h2>
        <div id="barcode-print-area" class="text-center p-4 printable-area">
            <p id="barcode-product-name" class="font-bold text-lg"></p>
            <svg id="barcode-svg" class="mx-auto"></svg>
            <p id="barcode-product-price" class="font-bold text-lg mt-1"></p>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t modal-actions" style="border-color: var(--border-color);">
            <button type="button" id="cancel-barcode-print-btn" class="btn btn-danger">Cancel</button>
            <button type="button" id="print-barcode-btn" class="btn btn-success"><i class="fas fa-print mr-2"></i>Print</button>
        </div>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div id="barcode-scanner-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-lg">
        <h2 class="text-2xl font-bold mb-4">Scan Barcode</h2>
        <div id="scanner-container" style="width: 100%; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
            <div id="reader"></div>
        </div>
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t modal-actions" style="border-color: var(--border-color);">
            <button type="button" id="close-scanner-btn" class="btn btn-danger">Close Scanner</button>
        </div>
    </div>
</div>


<!-- Customer Modal (for Add/Edit) -->
<div id="customer-modal" class="modal-overlay no-print">
    <div class="modal-content">
        <h2 id="customer-modal-title" class="text-2xl font-bold mb-4">Add New Customer</h2>
        <form id="customer-form" class="space-y-4">
            <input type="hidden" id="edit-customer-id">
            <div><label class="font-medium">Customer Name</label><input type="text" id="customer-name-input" class="input-field" required></div>
            <div><label class="font-medium">Phone</label><input type="tel" id="customer-phone-input" class="input-field"></div>
            <div><label class="font-medium">CNIC</label><input type="text" id="customer-cnic-input" class="input-field"></div>
            <div><label class="font-medium">Address</label><input type="text" id="customer-address-input" class="input-field"></div>
            <div class="flex justify-end gap-3 pt-4 modal-actions">
                <button type="button" id="cancel-customer-btn" class="btn btn-danger">Cancel</button>
                <button type="submit" class="btn btn-success">Save Customer</button>
            </div>
        </form>
    </div>
</div>

<!-- Customer Selection Modal (for Credit Sale) -->
<div id="credit-customer-select-modal" class="modal-overlay no-print">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4">Select Customer for Credit</h2>
        <div id="credit-customer-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
        <div class="flex justify-end pt-4 mt-4 border-t modal-actions" style="border-color: var(--border-color);">
             <button type="button" id="cancel-credit-select-btn" class="btn btn-danger">Cancel</button>
        </div>
    </div>
</div>

<!-- Customer Ledger Modal -->
<div id="customer-ledger-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-4xl flex flex-col max-h-[90vh]">
        <div id="customer-ledger-printable-area" class="printable-area flex-grow flex flex-col overflow-hidden">
             <div class="flex-shrink-0">
                <div class="receipt-watermark">KP SOFTWARE</div>
                <h2 class="text-2xl font-bold mb-1">Customer Ledger</h2>
                <p class="mb-4"><strong>Customer:</strong> <span id="ledger-customer-name"></span></p>
            </div>
            <div class="flex-grow overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);">
                        <tr><th class="p-3">Date</th><th class="p-3">Description</th><th class="p-3 text-right">Debit</th><th class="p-3 text-right">Credit</th><th class="p-3 text-right">Balance</th><th class="p-3 text-center">Actions</th></tr>
                    </thead>
                    <tbody id="customer-ledger-table-body"></tbody>
                </table>
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t no-print flex-shrink-0 modal-actions" style="border-color: var(--border-color);">
            <button id="print-ledger-btn" class="btn bg-gray-600 text-white"><i class="fas fa-print mr-2"></i>Print Ledger</button>
            <button id="download-ledger-pdf-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button>
            <button type="button" id="cancel-ledger-btn" class="btn btn-danger">Close</button>
        </div>
    </div>
</div>

<!-- Purchase Modal -->
<div id="purchase-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-4xl flex flex-col max-h-[90vh]">
        <h2 id="purchase-modal-title" class="text-2xl font-bold mb-4 flex-shrink-0">Add Supplier Purchase</h2>
        <div class="flex-grow overflow-y-auto pr-2">
            <form id="purchase-form" class="space-y-4">
                <input type="hidden" id="editing-purchase-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4" style="border-color: var(--border-color);">
                    <div><label class="font-medium">Supplier Name</label><input type="text" id="purchase-supplier-name" class="input-field" required></div>
                    <div><label class="font-medium">Contact</label><input type="tel" id="purchase-supplier-contact" class="input-field"></div>
                    <div><label class="font-medium">Date</label><input type="date" id="purchase-date" class="input-field" required></div>
                </div>
                <h3 class="text-xl font-semibold mt-4">Products</h3>
                <div id="purchase-items-container" class="space-y-2 p-2 rounded" style="background-color: var(--bg-modal-darker);"></div>
                <div class="flex gap-2">
                    <button type="button" id="add-purchase-item-row" class="btn btn-info btn-sm mt-2"><i class="fas fa-plus mr-2"></i>Add Product Row</button>
                    <button type="button" id="open-new-product-submodal-btn" class="btn btn-warning btn-sm mt-2"><i class="fas fa-box mr-2"></i>Create New Product</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4 mt-4" style="border-color: var(--border-color);">
                    <div class="p-2 rounded-lg text-center" style="background-color: var(--bg-modal-darker);"><label class="font-medium">Total Bill</label><div id="purchase-total-amount" class="text-2xl font-bold mt-1">₨0.00</div></div>
                    <div><label class="font-medium">Amount Paid</label><input type="number" id="purchase-amount-paid" class="input-field" required value="0" min="0" step="0.01"></div>
                    <div class="p-2 rounded-lg text-center" style="background-color: var(--bg-modal-darker);"><label class="font-medium">Remaining</label><div id="purchase-amount-remaining" class="text-xl font-bold text-red-400 mt-1">₨0.00</div></div>
                </div>
            </form>
        </div>
        <div class="flex justify-end gap-3 pt-4 flex-shrink-0 modal-actions">
            <button type="button" id="cancel-purchase-btn" class="btn btn-danger">Cancel</button>
            <button type="submit" form="purchase-form" class="btn btn-success">Save Purchase</button>
        </div>
        <datalist id="products-datalist"></datalist>
    </div>
</div>

<!-- New Product Sub-Modal (for inside Purchase Modal) -->
<div id="new-product-submodal" class="modal-overlay no-print">
    <div class="modal-content max-w-lg">
        <h2 class="text-2xl font-bold mb-4">Add New Product to System</h2>
        <form id="new-product-subform" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div><label class="font-medium">Product Name</label><input type="text" id="sub-product-name" class="input-field" required></div>
                 <div><label class="font-medium">Generic Name / Formula</label><input type="text" id="sub-product-generic-name" class="input-field"></div>
                 <div><label class="font-medium">Selling Price</label><input type="number" id="sub-product-sell-price" class="input-field" required min="0" step="0.01"></div>
                 <div><label class="font-medium">Category</label><select id="sub-product-category" class="input-field" required><option value="">-- Select Category --</option></select></div>
                 <div><label class="font-medium">Expiry Date</label><input type="date" id="sub-product-expiry" class="input-field" required></div>
                 <div><label class="font-medium">Group</label><select id="sub-product-group" class="input-field"><option value="">-- No Group --</option></select></div>
                 <div><label class="font-medium">Low Stock Threshold</label><input type="number" id="sub-product-low-stock" class="input-field" required min="0" value="10"></div>
                 <div><label class="font-medium">Batch No.</label><input type="text" id="sub-product-batch-number" class="input-field"></div>
            </div>
             <div class="flex justify-end gap-3 pt-4 modal-actions">
                <button type="button" id="cancel-sub-product-btn" class="btn btn-danger">Cancel</button>
                <button type="submit" class="btn btn-primary">Create & Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Purchase Invoice Modal -->
<div id="purchase-invoice-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-sm w-full">
        <div id="purchase-invoice-print-area-wrapper">
            <div id="purchase-invoice-print-area" class="printable-area" style="padding: 15px; box-sizing: border-box;">
                <div class="receipt-watermark">KP SOFTWARE</div>
                <div class="text-center mb-4">
                    <i class="fas fa-store text-blue-500 text-3xl mb-1"></i>
                    <h2 id="purchase-receipt-store-name" class="text-xl font-extrabold tracking-wider">Store Name</h2>
                    <p id="purchase-receipt-store-address" class="text-xs"></p>
                    <p id="purchase-receipt-store-contact" class="text-xs"></p>
                    <p id="purchase-receipt-store-email" class="text-xs"></p>
                </div>
                <hr class="my-2 border-dashed">
                <div class="text-xs mb-2 space-y-1">
                    <div class="flex justify-between"><strong>Purchase ID:</strong> <span id="purchase-invoice-id"></span></div>
                    <div class="flex justify-between"><strong>Supplier:</strong> <span id="purchase-invoice-supplier-name"></span></div>
                    <div class="flex justify-between"><strong>Date:</strong> <span id="purchase-invoice-date"></span></div>
                </div>
                <hr class="my-2 border-dashed">
                <table class="w-full text-xs mb-2">
                    <thead>
                        <tr class="border-b-2 border-dashed">
                            <th class="text-left py-1">ITEM</th>
                            <th class="text-center">QTY</th>
                            <th class="text-right">COST</th>
                            <th class="text-right">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="purchase-invoice-items" class="divide-y divide-dashed"></tbody>
                </table>
                <hr class="my-2 border-dashed">
                <div class="text-xs space-y-1">
                    <div class="flex justify-between"><span>Total Bill:</span><span id="purchase-invoice-total"></span></div>
                    <div class="flex justify-between"><span>Amount Paid:</span><span id="purchase-invoice-paid"></span></div>
                    <div class="flex justify-between font-bold text-base border-t-2 border-dashed mt-1 pt-1"><span>Remaining:</span><span id="purchase-invoice-remaining"></span></div>
                </div>
                 <p class="text-center text-xs mt-4 mb-8">Purchase Record Summary</p> 
            </div>
        </div>
        <div class="flex justify-end gap-3 p-4 rounded-b-lg no-print modal-actions" style="background-color: var(--bg-modal-darker);">
            <button id="print-purchase-invoice-btn" class="btn bg-gray-600 text-white"><i class="fas fa-print mr-2"></i>Print</button>
            <button id="download-purchase-invoice-pdf-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button>
            <button id="close-purchase-invoice-btn" class="btn btn-danger"><i class="fas fa-times mr-2"></i>Close</button>
        </div>
    </div>
</div>


<div id="return-sale-modal" class="modal-overlay no-print"> <div class="modal-content max-w-2xl"> <h2 class="text-2xl font-bold mb-4">Return Items from Invoice <span id="return-invoice-id" class="text-yellow-400"></span></h2> <form id="return-sale-form"> <div id="return-items-list" class="space-y-3 max-h-72 overflow-y-auto mb-4 p-2 rounded-lg" style="background-color: var(--bg-modal-darker);"></div> <div class="flex justify-end gap-3 pt-4 border-t modal-actions" style="border-color: var(--border-color);"><button type="button" id="cancel-return-btn" class="btn btn-danger">Cancel</button> <button type="submit" class="btn btn-warning">Process Return</button> </div> </form> </div> </div>

<!-- Settle Credit Modal -->
<div id="settle-credit-modal" class="modal-overlay no-print">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-4">Settle Customer Account</h2>
    <form id="settle-credit-form" class="space-y-4">
      <input type="hidden" id="settle-customer-id">
      <div>Customer: <strong id="settle-customer-name"></strong></div>
      <div>Amount Due: <strong id="settle-amount-due" class="text-red-400"></strong></div>
      <hr style="border-color: var(--border-color);">
      <div><label class="font-medium">Amount Paid</label><input type="number" id="settle-amount-paid" class="input-field" required min="0.01" step="0.01"></div>
      <div>Remaining: <strong id="settle-amount-remaining" class="text-yellow-400"></strong></div>
      <div class="flex justify-end gap-3 pt-4 modal-actions">
        <button type="button" id="cancel-settle-credit-btn" class="btn btn-danger">Cancel</button>
        <button type="submit" class="btn btn-success">Save Payment</button>
      </div>
    </form>
  </div>
</div>

<!-- Staff Modals -->
<div id="staff-modal" class="modal-overlay no-print">
    <div class="modal-content">
        <h2 id="staff-modal-title" class="text-2xl font-bold mb-4">Add New Staff Member</h2>
        <form id="staff-form" class="space-y-4">
            <input type="hidden" id="edit-staff-id">
            <div><label class="font-medium">Staff Name</label><input type="text" id="staff-name-input" class="input-field" required></div>
            <div><label class="font-medium">Phone Number</label><input type="tel" id="staff-phone-input" class="input-field"></div>
            <div><label class="font-medium">Role / Job</label><input type="text" id="staff-role-input" class="input-field" placeholder="e.g., Helper, Counter Man" required></div>
            <div><label class="font-medium">Monthly Salary (₨)</label><input type="number" id="staff-salary-input" class="input-field" required min="0"></div>
            <div><label class="font-medium">Joining Date</label><input type="date" id="staff-joining-date-input" class="input-field" required></div>
            <div class="flex justify-end gap-3 pt-4 modal-actions">
                <button type="button" id="cancel-staff-btn" class="btn btn-danger">Cancel</button>
                <button type="submit" class="btn btn-success">Save Staff</button>
            </div>
        </form>
    </div>
</div>
<div id="staff-ledger-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-4xl flex flex-col max-h-[90vh]">
        <div class="flex-shrink-0">
            <div class="receipt-watermark">KP SOFTWARE</div>
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold">Staff Ledger: <span id="ledger-staff-name" class="text-blue-400"></span></h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-center">
                <div class="card p-3"><h3 class="font-semibold text-gray-400">Base Salary</h3><p id="ledger-staff-base-salary" class="text-2xl font-bold"></p></div>
                <div class="card p-3"><h3 class="font-semibold text-gray-400">Current Balance</h3><p id="ledger-staff-current-balance" class="text-2xl font-bold text-red-400"></p></div>
                <div class="card p-3"><h3 class="font-semibold text-gray-400">Net Payable</h3><p id="ledger-staff-net-payable" class="text-2xl font-bold text-green-400"></p></div>
            </div>
            <div class="card p-4 mb-4">
                <form id="staff-ledger-entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="hidden" id="ledger-staff-id">
                    <div><label for="staff-entry-type" class="font-medium">Transaction Type</label><select id="staff-entry-type" class="input-field"><option value="Salary">Salary Payment</option><option value="Advance">Advance</option></select></div>
                    <div><label for="staff-entry-amount" class="font-medium">Amount (₨)</label><input type="number" id="staff-entry-amount" class="input-field" required min="1"></div>
                    <div><label for="staff-entry-notes" class="font-medium">Notes</label><input type="text" id="staff-entry-notes" class="input-field" placeholder="e.g., For personal use"></div>
                    <button type="submit" class="btn btn-primary">Add Entry</button>
                </form>
            </div>
        </div>
        <div class="flex-grow overflow-x-auto"><table class="w-full text-left text-sm"><thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"><tr><th class="p-3">Date</th><th class="p-3">Description</th><th class="p-3 text-right text-green-400">Payment (Credit)</th><th class="p-3 text-right text-red-400">Advance (Debit)</th><th class="p-3 text-right">Balance</th></tr></thead><tbody id="staff-ledger-table-body"></tbody></table></div>
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t no-print flex-shrink-0 modal-actions" style="border-color: var(--border-color);">
            <button id="generate-full-month-salary-btn" class="btn btn-success"><i class="fas fa-file-invoice-dollar mr-2"></i>Full Month Salary</button>
            <button type="button" id="cancel-staff-ledger-btn" class="btn btn-danger">Close</button>
        </div>
    </div>
</div>
<div id="staff-transactions-history-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-6xl flex flex-col max-h-[90vh]">
        <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Staff Transaction History</h2>
        <div class="flex-grow overflow-x-auto"><table class="w-full text-left text-sm"><thead class="sticky top-0 z-10" style="background-color: var(--bg-modal-darker);"><tr><th class="p-3">Date</th><th class="p-3">Staff Name</th><th class="p-3">Type</th><th class="p-3">Notes</th><th class="p-3 text-right">Amount</th><th class="p-3 text-center">Action</th></tr></thead><tbody id="staff-history-table-body"></tbody></table></div>
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t no-print flex-shrink-0 modal-actions" style="border-color: var(--border-color);"><button type="button" id="close-staff-history-btn" class="btn btn-danger">Close</button></div>
    </div>
</div>

<!-- Generic Staff Receipt / Advance Slip -->
<div id="staff-receipt-modal" class="modal-overlay no-print"> 
    <div class="modal-content max-w-sm w-full">
        <div id="staff-receipt-print-wrapper" class="p-4">
            <div id="staff-receipt-area" class="printable-area">
                <div class="receipt-watermark">KP SOFTWARE</div>
                <div class="text-center mb-4">
                    <h2 id="staff-receipt-store-name" class="text-xl font-extrabold tracking-wider">Store Name</h2>
                    <p id="staff-receipt-store-address" class="text-xs"></p>
                    <p id="staff-receipt-title" class="font-bold text-lg mt-2">Payment Receipt</p>
                </div> 
                <hr class="my-2 border-dashed">
                <div class="text-sm mb-2 space-y-1"> 
                    <div class="flex justify-between"><strong>Staff Name:</strong> <span id="staff-receipt-staff-name"></span></div> 
                    <div class="flex justify-between"><strong>Payment Date:</strong> <span id="staff-receipt-date"></span></div> 
                    <div class="flex justify-between"><strong>Notes:</strong> <span id="staff-receipt-notes"></span></div> 
                </div> 
                <hr class="my-2 border-dashed">
                <div class="flex justify-between font-bold text-xl my-4 p-2 rounded" style="background-color: var(--bg-modal-darker);"><span>Amount:</span><span id="staff-receipt-amount"></span></div>
                <div class="mt-16 text-sm"><div class="flex justify-between"><div class="text-center"><p class="border-t border-dashed pt-1" style="border-color: var(--text-modal);">Receiver Signature</p></div><div class="text-center"><p class="border-t border-dashed pt-1" style="border-color: var(--text-modal);">Manager Signature</p></div></div></div>
            </div>
        </div>
        <div class="flex justify-end gap-3 p-4 rounded-b-lg no-print modal-actions" style="background-color: var(--bg-modal-darker);"> 
            <button id="print-staff-receipt-btn" class="btn bg-gray-600 text-white"><i class="fas fa-print mr-2"></i>Print</button> 
            <button id="download-staff-receipt-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button> 
            <button id="close-staff-receipt-btn" class="btn btn-danger"><i class="fas fa-times mr-2"></i>Close</button> 
        </div> 
    </div> 
</div>

<!-- Monthly Salary Slip Modal -->
<div id="monthly-salary-slip-modal" class="modal-overlay no-print"> 
    <div class="modal-content max-w-sm w-full">
        <div id="monthly-salary-slip-wrapper" class="p-4">
            <div id="monthly-salary-slip-area" class="printable-area">
                <div class="receipt-watermark">KP SOFTWARE</div>
                <div class="text-center mb-4">
                    <h2 id="monthly-slip-store-name" class="text-xl font-extrabold tracking-wider">Store Name</h2>
                    <p id="monthly-slip-store-address" class="text-xs"></p>
                    <p class="font-bold text-lg mt-2">Monthly Salary Slip</p>
                </div> 
                <hr class="my-2 border-dashed">
                <div class="text-sm mb-2 space-y-1"> 
                    <div class="flex justify-between"><strong>Staff Name:</strong> <span id="monthly-slip-staff-name"></span></div> 
                    <div class="flex justify-between"><strong>Payment Date:</strong> <span id="monthly-slip-date"></span></div> 
                    <div class="flex justify-between"><strong>Salary Month:</strong> <span id="monthly-slip-month"></span></div> 
                </div> 
                <hr class="my-2 border-dashed">
                <div class="text-sm space-y-1">
                    <div class="flex justify-between"><span>Base Salary:</span><span id="monthly-slip-base-salary"></span></div>
                </div>
                <hr class="my-2 border-dashed">
                <p class="text-sm font-bold">Deductions (Advances):</p>
                <div id="monthly-slip-advances-list" class="text-xs my-2 space-y-1"></div>
                <div class="flex justify-between text-sm border-t border-dashed pt-1"><strong>Total Advances:</strong><strong id="monthly-slip-total-advances"></strong></div>
                <hr class="my-2 border-dashed">
                <div class="flex justify-between font-bold text-xl my-4 p-2 rounded" style="background-color: var(--bg-modal-darker);"><span>Net Payable:</span><span id="monthly-slip-net-payable"></span></div>
                <div class="mt-16 text-sm"><div class="flex justify-between"><div class="text-center"><p class="border-t border-dashed pt-1" style="border-color: var(--text-modal);">Receiver Signature</p></div><div class="text-center"><p class="border-t border-dashed pt-1" style="border-color: var(--text-modal);">Manager Signature</p></div></div></div>
            </div>
        </div>
        <div class="flex justify-end gap-3 p-4 rounded-b-lg no-print modal-actions" style="background-color: var(--bg-modal-darker);"> 
            <button id="print-monthly-slip-btn" class="btn bg-gray-600 text-white"><i class="fas fa-print mr-2"></i>Print</button> 
            <button id="download-monthly-slip-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button> 
            <button id="close-monthly-slip-btn" class="btn btn-danger"><i class="fas fa-times mr-2"></i>Close</button> 
        </div> 
    </div> 
</div>

<!-- Logout Confirmation Modal -->
<div id="logout-confirm-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-sm">
        <h2 class="text-2xl font-bold mb-4">Confirm Logout</h2>
        <p class="mb-4" style="color: var(--text-secondary);">For security, please enter your password to log out.</p>
        <form id="logout-confirm-form">
            <div>
                <label for="logout-password-confirm" class="font-medium">Password</label>
                <input type="password" id="logout-password-confirm" class="input-field mt-1" required>
            </div>
            <p id="logout-confirm-error" class="text-red-500 text-sm h-4 mt-2"></p>
            <div class="flex justify-end gap-3 pt-4 mt-4 border-t modal-actions" style="border-color: var(--border-color);">
                <button type="button" id="cancel-logout-confirm-btn" class="btn btn-danger">Cancel</button>
                <button type="submit" class="btn btn-success">Confirm & Logout</button>
            </div>
        </form>
    </div>
</div>

<!-- Help and Shortcuts Modal -->
<div id="help-modal" class="modal-overlay no-print">
    <div class="modal-content max-w-4xl">
        <h2 class="text-2xl font-bold mb-4">Help & Keyboard Shortcuts</h2>
        <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-4">
            <div class="p-4 rounded-lg" style="background-color: var(--bg-modal-darker);">
                <h3 class="font-bold mb-2 text-lg">General Shortcuts</h3>
                <ul class="list-disc list-inside space-y-2">
                    <li>Navigate to Dashboard: <kbd>Alt</kbd> + <kbd>D</kbd></li>
                    <li>Navigate to POS (Sale) Screen: <kbd>Alt</kbd> + <kbd>P</kbd></li>
                    <li>Navigate to Sales History: <kbd>Alt</kbd> + <kbd>T</kbd></li>
                    <li>Navigate to Customers: <kbd>Alt</kbd> + <kbd>C</kbd></li>
                    <li>Navigate to Reports: <kbd>Alt</kbd> + <kbd>R</kbd></li>
                    <li>Navigate to Master Data: <kbd>Alt</kbd> + <kbd>M</kbd></li>
                    <li>Navigate to Settings: <kbd>Alt</kbd> + <kbd>S</kbd></li>
                    <li>Open 'Add New' dialog on active page (Products, Customers, etc.): <kbd>Insert</kbd></li>
                    <li>Close any open pop-up window or the sale cart: <kbd>Esc</kbd></li>
                    <li>Submit the form in the currently open pop-up: <kbd>Ctrl</kbd> + <kbd>Enter</kbd></li>
                </ul>
            </div>
            <div class="p-4 rounded-lg" style="background-color: var(--bg-modal-darker);">
                <h3 class="font-bold mb-2 text-lg">POS (Sale Screen) Shortcuts</h3>
                <ul class="list-disc list-inside space-y-2">
                    <li>Focus on the Product Search bar: <kbd>F2</kbd></li>
                    <li>Focus on the Discount input field in the cart: <kbd>F4</kbd></li>
                    <li>Finalize and complete the current sale (Cash Sale): <kbd>End</kbd></li>
                    <li>Complete the sale as a Credit Sale: <kbd>F10</kbd></li>
                    <li>Put the current sale on Hold: <kbd>F11</kbd></li>
                    <li>Cancel the current sale: <kbd>F12</kbd></li>
                    <li>In the search bar, if the input is a full barcode, press <kbd>Enter</kbd> to add the product to the cart automatically.</li>
                </ul>
            </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t modal-actions" style="border-color: var(--border-color);">
            <button type="button" id="close-help-modal-btn" class="btn btn-danger">Close</button>
        </div>
    </div>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getDatabase, ref, onValue, off, set, push, update, remove, runTransaction, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  // --- Firebase Configuration ---
  const firebaseConfig = {
    apiKey: "AIzaSyBdm5Ot1bjCq6Ytrul9L2UQo61oSmSeaa0",
    authDomain: "student-program-e6ed4.firebaseapp.com",
    databaseURL: "https://student-program-e6ed4-default-rtdb.firebaseio.com",
    projectId: "student-program-e6ed4",
    storageBucket: "student-program-e6ed4.firebasestorage.app",
    messagingSenderId: "466600750135",
    appId: "1:466600750135:web:a5f034144278156ef0a3b2"
  };

  // --- Initialize Firebase ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase(app);
  
  // --- Global State ---
  let currentUserUID = null;
  let currentUserEmail = null;
  let dbRefs = {};
  let onInvoiceCloseCallback = null;
  let html5QrCode = null;
  let currentScannerTargetInput = null;
  let activeListeners = [];

document.addEventListener('DOMContentLoaded', () => {
    
    const loginContainer = document.getElementById('login-container');
    const appLayout = document.getElementById('app-layout');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserUID = user.uid;
            currentUserEmail = user.email;
            loginContainer.classList.add('hidden');
            appLayout.classList.remove('hidden');
            initAppForUser();
        } else {
            currentUserUID = null;
            currentUserEmail = null;
            loginContainer.classList.remove('hidden');
            appLayout.classList.add('hidden');
            cleanupListeners();
        }
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = loginForm['email-address'].value;
        const password = loginForm['password'].value;
        loginError.textContent = ''; 
        signInWithEmailAndPassword(auth, email, password)
            .catch((error) => {
                const errorCode = error.code;
                console.error("Login Error:", errorCode);
                if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password' || errorCode === 'auth/invalid-credential') {
                    loginError.textContent = 'Invalid email or password.';
                } else if (errorCode === 'auth/network-request-failed') {
                    loginError.textContent = 'Network error. Please check your connection.';
                }
                 else {
                    loginError.textContent = 'An error occurred during login.';
                }
            });
    });

    logoutBtn.addEventListener('click', () => {
        const modal = document.getElementById('logout-confirm-modal');
        modal.querySelector('form').reset();
        modal.querySelector('#logout-confirm-error').textContent = '';
        modal.classList.add('visible');
    });

    document.getElementById('cancel-logout-confirm-btn').addEventListener('click', () => {
        document.getElementById('logout-confirm-modal').classList.remove('visible');
    });

    document.getElementById('logout-confirm-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('logout-password-confirm').value;
        const errorEl = document.getElementById('logout-confirm-error');
        errorEl.textContent = '';

        if (!password) {
            errorEl.textContent = 'Password is required.';
            return;
        }

        signInWithEmailAndPassword(auth, currentUserEmail, password)
            .then(() => {
                document.getElementById('logout-confirm-modal').classList.remove('visible');
                signOut(auth).catch((err) => {
                     console.error('Sign Out Error', err);
                     alert('Could not sign out. Please try again.');
                });
            })
            .catch((error) => {
                 errorEl.textContent = 'Incorrect password. Please try again.';
            });
    });
    
    function cleanupListeners() {
        activeListeners.forEach(l => off(l.ref, 'value', l.listener));
        activeListeners = [];
    }
    
    function initKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName);
            
            // MOBILE KEYBOARD FIX: If typing a regular character in an input field, do nothing.
            // This prevents the keyboard from closing on mobile devices after each keystroke.
            // We check if the key is a single character and not part of a ctrl/alt shortcut.
            if (isTyping && e.key.length === 1 && !e.ctrlKey && !e.altKey) {
                return;
            }
            
            // This condition handles special keys (like F-keys or Escape) while typing.
            // It's a fallback, but the main fix is the check above.
            if (isTyping && !['Escape', 'Enter', 'F2', 'F4', 'F10', 'F11', 'F12', 'End', 'Insert'].includes(e.key) && !e.ctrlKey && !e.altKey) {
                return;
            }

            // --- Shortcut Logic from here ---

            if (e.key === 'Escape') {
                e.preventDefault();
                const visibleModal = document.querySelector('.modal-overlay.visible');
                const cartSidebar = document.getElementById('cart-sidebar');
                if (visibleModal && visibleModal.id === 'barcode-scanner-modal') {
                    closeScanner();
                } else if (visibleModal) {
                    visibleModal.classList.remove('visible');
                } else if (cartSidebar.classList.contains('open')) {
                    closeCartSidebar();
                }
            }
            
            if (e.altKey) {
                e.preventDefault();
                let pageToGo = null;
                switch(e.key.toLowerCase()) {
                    case 'd': pageToGo = 'dashboard'; break;
                    case 'p': pageToGo = 'pos'; break;
                    case 't': pageToGo = 'transactions'; break;
                    case 'c': pageToGo = 'customers'; break;
                    case 'r': pageToGo = 'reports'; break;
                    case 'm': pageToGo = 'master-data'; break;
                    case 's': pageToGo = 'settings'; break;
                }
                if (pageToGo) { showPage(pageToGo); }
            }
            
            const activePageId = document.querySelector('.page.active')?.id;
            
            if (activePageId === 'pos') {
                 if (e.key === 'Enter' && e.target.id === 'product-search') {
                    e.preventDefault();
                    const searchTerm = e.target.value.trim();
                    if (!searchTerm) return;
                    
                    const exactBarcodeMatch = state.products.find(p => p.barcode === searchTerm && p.stock > 0);
                    
                    if (exactBarcodeMatch) {
                        app.addToCart(exactBarcodeMatch.id);
                        e.target.value = '';
                        e.target.focus();
                    } else {
                        renderPosProducts();
                    }
                    return;
                }

                switch(e.key) {
                    case 'F2': e.preventDefault(); document.getElementById('product-search')?.focus(); break;
                    case 'F4': e.preventDefault(); document.getElementById('cart-discount-value')?.focus(); document.getElementById('cart-discount-value')?.select(); break;
                    case 'End': e.preventDefault(); document.getElementById('complete-sale-btn')?.click(); break;
                    case 'F10': e.preventDefault(); document.getElementById('credit-sale-btn')?.click(); break;
                    case 'F11': e.preventDefault(); document.getElementById('hold-sale-btn')?.click(); break;
                    case 'F12': e.preventDefault(); document.getElementById('cancel-sale-btn')?.click(); break;
                }
            }

            if (e.key === 'Insert') {
                e.preventDefault();
                let addButton;
                switch(activePageId) {
                    case 'products': addButton = document.getElementById('show-add-product-modal-btn'); break;
                    case 'customers': addButton = document.getElementById('add-customer-btn'); break;
                    case 'suppliers': addButton = document.getElementById('add-purchase-btn'); break;
                    case 'staff': addButton = document.getElementById('add-staff-btn'); break;
                    case 'expenses': document.getElementById('add-expense-form')['expense-category-select'].focus(); break;
                }
                addButton?.click();
            }

            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const visibleModal = document.querySelector('.modal-overlay.visible');
                if (visibleModal) {
                    const submitButton = visibleModal.querySelector('button[type="submit"]') || visibleModal.querySelector('.btn-success');
                    submitButton?.click();
                }
            }
        });
    }

    function initAppForUser() {
        if (!currentUserUID) return;
        
        cleanupListeners();
        initKeyboardShortcuts();

        dbRefs = {
            products: ref(database, `data/${currentUserUID}/products`),
            sales: ref(database, `data/${currentUserUID}/sales`),
            settings: ref(database, `data/${currentUserUID}/settings`),
            customers: ref(database, `data/${currentUserUID}/customers`),
            purchases: ref(database, `data/${currentUserUID}/purchases`),
            holdBills: ref(database, `data/${currentUserUID}/holdBills`),
            staff: ref(database, `data/${currentUserUID}/staff`),
            expenses: ref(database, `data/${currentUserUID}/expenses`),
            groups: ref(database, `data/${currentUserUID}/masterData/groups`),
            productCategories: ref(database, `data/${currentUserUID}/masterData/productCategories`),
            expenseCategories: ref(database, `data/${currentUserUID}/masterData/expenseCategories`),
        };
        
        let state = { products: [], sales: [], cart: [], settings: { discountType: 'amount', printerType: 'thermal', posViewType: 'card', taxEnabled: false, taxRate: 0, serviceChargeEnabled: false, serviceChargeRate: 0 }, customers: [], purchases: [], holdBills: [], currentPurchaseItems: [], editingPurchaseOriginalItems: [], activeCategory: 'All', activeGroup: 'All', activeFormula: 'All', staff: [], expenses: [], groups: [], productCategories: [], expenseCategories: [], salesCounts: {} };
        const formatCurrency = (amount) => `Rs${(parseFloat(amount) || 0).toFixed(2)}`;
        const getCategoryColor = (categoryName) => (state.productCategories.find(c => c.name === categoryName)?.color || '#64748b');
        
        const openCartSidebar = () => { document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('app-layout').classList.add('cart-open'); };
        const closeCartSidebar = () => { document.getElementById('cart-sidebar').classList.remove('open'); document.getElementById('app-layout').classList.remove('cart-open'); };
        
        const handleButtonFeedback = async (button, processingText, callback) => {
            const originalHtml = button.innerHTML;
            const spinner = `<i class="fas fa-spinner fa-spin mr-2"></i>`;
            button.innerHTML = `${spinner}${processingText}`;
            button.disabled = true;

            try {
                await new Promise(resolve => setTimeout(resolve, 0)); // Allow UI to update
                await callback();
            } catch (error) {
                console.error(`Action failed: ${processingText}`, error);
                // The alert is now more specific, handled in the calling function.
            } finally {
                button.innerHTML = originalHtml;
                button.disabled = false;
            }
        };
        
        const handlePrintButtonFeedback = (button, processingText, callback) => {
            const originalHtml = button.innerHTML;
            const spinner = `<i class="fas fa-spinner fa-spin mr-2"></i>`;
            button.innerHTML = `${spinner}${processingText}`;
            button.disabled = true;

            setTimeout(() => {
                try {
                    callback();
                } catch(error) {
                    console.error("Printing failed:", error);
                    alert("Could not print. Please check console for errors.");
                } finally {
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                }
            }, 100); // Small delay to allow UI update
        }


        const showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if(targetPage){ targetPage.classList.add('active'); }

            document.querySelectorAll('.nav-button[data-page]').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-button[data-page="${pageId}"]`)?.classList.add('active');
            
            updateAllPages();
            
            if (pageId === 'pos') { renderPosProducts(); }
            if (pageId === 'settings') document.getElementById('logged-in-email').textContent = currentUserEmail;
            if (pageId === 'reports' && !document.getElementById('report-transactions-table').innerHTML) { document.getElementById('report-daily-btn').click(); }
            if (pageId === 'day-end-report') { const today = new Date().toISOString().split('T')[0]; document.getElementById('dayend-start-date').value = today; document.getElementById('dayend-end-date').value = today; renderDayEndReport(); }
            if (pageId === 'dashboard') { 
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('db-start-date').value = today; 
                document.getElementById('db-end-date').value = today; 
                updateDashboard(new Date(), new Date()); 
            }
        };

        const setTheme = (theme) => {
            document.body.className = '';
            if (theme === 'dark' || theme === 'light-pink') {
                document.body.classList.add(theme);
            }
            localStorage.setItem('pos-theme', theme);
        };
        
        document.querySelectorAll('#theme-buttons-container button').forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                setTheme(e.currentTarget.dataset.theme);
            });
        });
    
        const savedTheme = localStorage.getItem('pos-theme') || 'light'; 
        setTheme(savedTheme);

        document.querySelectorAll('.nav-button[data-page]').forEach(link => link.addEventListener('click', e => { e.preventDefault(); showPage(link.dataset.page); }));
        
        function updateAllPages(){
            const activePage = document.querySelector('.page.active')?.id;
            if (activePage === 'dashboard') { const start = document.getElementById('db-start-date').value; const end = document.getElementById('db-end-date').value; if(start && end) { updateDashboard(new Date(start), new Date(end)); } else { const today = new Date(); updateDashboard(today, today); } }
            if (activePage === 'pos') { renderCategoryFilters(); renderGroupFilterDropdown(); renderFormulaFilterDropdown(); renderPosProducts(); }
            if (activePage === 'products') renderProductsTable();
            if (activePage === 'transactions') renderTransactionsPage();
            if (activePage === 'returned-bills') renderReturnedBillsPage();
            if (activePage === 'customers') renderCustomersPage();
            if (activePage === 'suppliers') renderPurchasesPage();
            if (activePage === 'master-data') renderMasterDataPage();
            if (activePage === 'hold-bills') renderHoldBillsPage();
            if (activePage === 'day-end-report') renderDayEndReport();
            if (activePage === 'expenses') renderExpensesPage();
            if (activePage === 'staff') renderStaffPage();
        }
        
        function updateDashboard(startDate, endDate) {
            const now = new Date();
            if (!startDate) startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            if (!endDate) endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            startDate.setHours(0,0,0,0); endDate.setHours(23,59,59,999);

            const filteredSales = state.sales.filter(s => { const d = new Date(s.date); return d >= startDate && d <= endDate; });
            const filteredExpenses = state.expenses.filter(e => { const d = new Date(e.date); return d >= startDate && d <= endDate; });
            const filteredPurchases = state.purchases.filter(p => { const d = new Date(p.date); return d >= startDate && d <= endDate; });
            const filteredPayments = state.customers.flatMap(c => Object.values(c.payments || {})).filter(p => { const d = new Date(p.date); return d >= startDate && d <= endDate; });
            
            const totalSales = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const totalPurchase = filteredPurchases.reduce((sum, p) => sum + p.totalAmount, 0);
            const creditReceived = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = filteredSales.reduce((sum, s) => sum + s.profit, 0);
            const totalVisits = filteredSales.length;
            
            const totalReturns = filteredSales.reduce((sum, s) => {
                return sum + (s.items || []).reduce((itemSum, i) => itemSum + (i.returnedQty || 0) * i.sellingPrice, 0);
            }, 0);
            
            const creditGiven = filteredSales.filter(s => s.status === 'Credit').reduce((sum, s) => sum + s.total, 0);
            
            const totalProductsCount = state.products.length;
            const totalStockValue = state.products.reduce((sum, p) => sum + (p.costPrice || 0) * (p.stock || 0), 0);
            
            const allExpiredLoss = state.products.filter(p => p.expiryDate && new Date(p.expiryDate) < now).reduce((sum, p) => sum + (p.costPrice || 0) * (p.stock || 0), 0);
            
            document.getElementById('dashboard-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('dashboard-total-purchase').textContent = formatCurrency(totalPurchase);
            document.getElementById('dashboard-credit-received').textContent = formatCurrency(creditReceived);
            document.getElementById('dashboard-total-expense').textContent = formatCurrency(totalExpenses);
            document.getElementById('dashboard-total-profit').textContent = formatCurrency(netProfit);
            document.getElementById('dashboard-total-visits').textContent = totalVisits;
            document.getElementById('dashboard-total-returns').textContent = formatCurrency(totalReturns);
            document.getElementById('dashboard-credit-given').textContent = formatCurrency(creditGiven);
            document.getElementById('dashboard-total-products').textContent = totalProductsCount;
            document.getElementById('dashboard-stock-value').textContent = formatCurrency(totalStockValue);
            document.getElementById('dashboard-expired-loss').textContent = formatCurrency(allExpiredLoss);
            
            const salesCount = filteredSales.filter(s => s.status !== "Returned").flatMap(s => s.items).reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + item.quantity; return acc; }, {});
            document.getElementById('top-selling-products').innerHTML = Object.entries(salesCount).sort((a,b) => b[1] - a[1]).slice(0, 10).map(([name, count]) => `<div class="flex justify-between"><span>${name}</span> <b>${count} sold</b></div>`).join('') || '<p class="text-gray-400">No sales in this period.</p>';
            
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(now.getDate() + 30);
            
            const lowStockProducts = state.products.filter(p => p.stock > 0 && p.stock <= (p.lowStockThreshold || 10));
            const expiringSoonProducts = state.products.filter(p => p.expiryDate && new Date(p.expiryDate) > now && new Date(p.expiryDate) <= thirtyDaysFromNow);
            const expiredProducts = state.products.filter(p => p.expiryDate && new Date(p.expiryDate) < now);

            document.getElementById('low-stock-alerts').innerHTML = lowStockProducts.map(p => `<div class="flex justify-between text-red-500"><span>${p.name}</span> <b>${p.stock} left</b></div>`).join('') || '<p class="text-gray-400">No low stock alerts.</p>';
            document.getElementById('expiring-soon-alerts').innerHTML = expiringSoonProducts.map(p => `<div class="flex justify-between text-yellow-500"><span>${p.name}</span> <b>Expires: ${p.expiryDate}</b></div>`).join('') || '<p class="text-gray-400">No products expiring soon.</p>';
            document.getElementById('expired-alerts').innerHTML = expiredProducts.map(p => `<div class="flex justify-between text-red-700"><span>${p.name}</span> <b>Expired: ${p.expiryDate}</b></div>`).join('') || '<p class="text-gray-400">No expired products.</p>';
        }

        async function renderPosProducts() {
            const search = document.getElementById('product-search').value.toLowerCase();
            const categoryFiltered = state.activeCategory === 'All' ? state.products : state.products.filter(p => p.category === state.activeCategory);
            const formulaFiltered = state.activeFormula === 'All' ? categoryFiltered : categoryFiltered.filter(p => p.genericName === state.activeFormula);
            const groupFiltered = state.activeGroup === 'All' ? formulaFiltered : formulaFiltered.filter(p => p.groupId === state.activeGroup);

            let filtered = search ? groupFiltered.filter(p => 
                (p.name.toLowerCase().includes(search) || 
                (p.barcode && p.barcode.toLowerCase().includes(search)) ||
                (p.batchNumber && p.batchNumber.toLowerCase().includes(search)) || 
                (p.genericName && p.genericName.toLowerCase().includes(search)))
            ) : groupFiltered;
            
            const isDefaultView = state.activeCategory === 'All' && state.activeGroup === 'All' && state.activeFormula === 'All' && search === '';
            if (isDefaultView) {
                filtered.sort((a, b) => (state.salesCounts[b.id] || 0) - (state.salesCounts[a.id] || 0));
            } else {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            const cardView = document.getElementById('product-card-view');
            const listView = document.getElementById('product-list-view');
            
            if (state.settings.posViewType === 'list') {
                cardView.classList.add('hidden');
                listView.classList.remove('hidden');
                renderPosProductsAsList(filtered);
            } else {
                listView.classList.add('hidden');
                cardView.classList.remove('hidden');
                renderPosProductsAsCards(filtered);
            }
        }

        async function renderPosProductsAsCards(products) {
            const listEl = document.getElementById('product-card-view');
            if (!listEl) return;
            let html = '';
            for (const p of products) {
                const cartItem = state.cart.find(item => item.id === p.id);
                const displayStock = p.stock - (cartItem ? cartItem.quantity : 0);
                const disabled = displayStock <= 0;
                const stockColor = displayStock <= (p.lowStockThreshold || 10) ? 'rgb(251 146 60)' : '#FFFFFF';
                
                const imageSrc = p.imageUrl || 'icons/placeholder.png';
                const backgroundStyle = p.imageUrl ? `background-image: url(${imageSrc});` : `background-color: ${getCategoryColor(p.category || 'Default')};`;

                html += `<div class="product-card-pos ${disabled ? 'disabled' : ''}" style="${backgroundStyle}" ${!disabled ? `onclick="app.addToCart('${p.id}')"` : ''}>
                    <div class="info-overlay">
                        <div class="product-name">${p.name}</div>
                        ${p.genericName ? `<div class="product-formula">(${p.genericName})</div>` : ''}
                        <div class="product-details mt-1">
                            <span>${formatCurrency(p.sellingPrice)}</span>
                            <span class="stock-text" style="color: ${stockColor};">Stock: ${displayStock}</span>
                        </div>
                    </div>
                </div>`;
            }
            listEl.innerHTML = html || '<p class="col-span-full p-8 text-center text-lg">No products found.</p>';
        }

        async function renderPosProductsAsList(products) {
            const listEl = document.getElementById('product-list-view');
            if (!listEl) return;
            let html = '';
            for (const p of products) {
                const cartItem = state.cart.find(item => item.id === p.id);
                const displayStock = p.stock - (cartItem ? cartItem.quantity : 0);
                const disabled = displayStock <= 0;
                const imageSrc = p.imageUrl || 'icons/placeholder.png';
                
                html += `
                <div class="product-list-item ${disabled ? 'disabled' : ''}" ${!disabled ? `onclick="app.addToCart('${p.id}')"` : ''}>
                    <img src="${imageSrc}" class="w-12 h-12 object-cover rounded-md mr-4">
                    <div class="flex-grow">
                        <p class="font-bold">${p.name}</p>
                        <p class="text-sm" style="color: var(--text-secondary);">${p.genericName || 'No formula'}</p>
                    </div>
                    <div class="w-24 text-center font-semibold ${displayStock <= (p.lowStockThreshold || 10) ? 'text-orange-500' : ''}">
                        Stock: ${displayStock}
                    </div>
                    <div class="w-28 text-right font-bold text-lg text-blue-500">
                        ${formatCurrency(p.sellingPrice)}
                    </div>
                </div>`;
            }
            listEl.innerHTML = html || '<div class="text-center p-8">No products found.</div>';
        }

        function renderCategoryFilters() {
            const container = document.getElementById('category-filters'); 
            if (!container) return;
            
            let buttonsHTML = `<button class="category-filter-btn ${state.activeCategory === 'All' ? 'active' : ''}" data-category="All" style="background-color: #64748b; color: white;">All</button>`;
            buttonsHTML += state.productCategories.map(cat => `<button class="category-filter-btn ${state.activeCategory === cat.name ? 'active' : ''}" data-category="${cat.name}" style="background-color: ${cat.color};">${cat.name}</button>`).join('');
            container.innerHTML = buttonsHTML;
            
            container.querySelectorAll('.category-filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const category = e.target.dataset.category;
                state.activeCategory = category;

                if (category === 'All') {
                    state.activeGroup = 'All';
                    state.activeFormula = 'All';
                    document.getElementById('group-filter-dropdown').value = 'All';
                    document.getElementById('formula-filter-dropdown').value = 'All';
                }

                renderCategoryFilters(); 
                renderPosProducts();
            }));
        }

        function renderGroupFilterDropdown() { const dropdown = document.getElementById('group-filter-dropdown'); if (!dropdown) return; dropdown.innerHTML = '<option value="All">All Groups</option>' + state.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join(''); dropdown.value = state.activeGroup; }
        function renderFormulaFilterDropdown() { const dropdown = document.getElementById('formula-filter-dropdown'); if (!dropdown) return; const formulas = [...new Set(state.products.map(p => p.genericName).filter(name => name && name.trim() !== ''))].sort(); dropdown.innerHTML = '<option value="All">All Formulas</option>' + formulas.map(f => `<option value="${f}">${f}</option>`).join(''); dropdown.value = state.activeFormula; }
        function populateProductCategorySelects(prefix = '') { const selects = document.querySelectorAll(`select[id^="${prefix}product-category"]`); selects.forEach(sel => { const currentVal = sel.value; sel.innerHTML = '<option value="">-- Select Category --</option>' + state.productCategories.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); sel.value = currentVal; });}
        function populateExpenseCategorySelect() { const sel = document.getElementById('expense-category-select'); if(sel) sel.innerHTML = '<option value="">-- Select Category --</option>' + state.expenseCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');}
        function populateGroupSelects(prefix = '') { const selects = document.querySelectorAll(`select[id^="${prefix}product-group"]`); selects.forEach(sel => { const currentVal = sel.value; sel.innerHTML = '<option value="">-- No Group --</option>' + state.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join(''); sel.value = currentVal; });}
        
        function renderTransactionsPage() {
            const tableBody = document.getElementById('transactions-table-body');
            if (!tableBody) return;
            const searchTerm = document.getElementById('transaction-search').value.toLowerCase();
            const filteredSales = state.sales.filter(s => (s.customerName && s.customerName.toLowerCase().includes(searchTerm)) || s.id.toLowerCase().includes(searchTerm));
            tableBody.innerHTML = filteredSales.sort((a, b) => new Date(b.date) - new Date(a.date)).map(s => { let statusClass; switch(s.status) { case 'Returned': statusClass = 'text-red-400'; break; case 'Partially Returned': statusClass = 'text-orange-400'; break; case 'Credit': statusClass = 'text-yellow-400'; break; default: statusClass = 'text-green-400'; } const returnBtnDisabled = s.status === 'Returned'; return `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${s.id}</td><td class="p-3">${new Date(s.date).toLocaleString()}</td><td class="p-3">${s.customerName || 'N/A'}</td><td class="p-3 ${statusClass} font-semibold">${s.status}</td><td class="p-3 text-right">${formatCurrency(s.total)}</td><td class="p-3 text-center space-x-2"><button class="btn btn-sm btn-info" onclick="app.showInvoice('${s.id}')"><i class="fas fa-print"></i></button><button class="btn btn-sm btn-warning" onclick="app.showReturnModal('${s.id}')" ${returnBtnDisabled ? 'disabled' : ''}><i class="fas fa-undo"></i></button></td></tr>`; }).join('') || `<tr><td colspan="6" class="text-center p-4">No transactions found.</td></tr>`;
        };
        
        const displayInvoice = (sale, isFirstTime = false) => { 
            if (!sale) return;
            const modal = document.getElementById('invoice-modal'); 
            modal.dataset.isFirstTime = isFirstTime;
            modal.querySelector('#receipt-store-name').textContent = state.settings.storeName || 'My Store';
            modal.querySelector('#receipt-store-address').textContent = state.settings.address || '';
            modal.querySelector('#receipt-store-contact').textContent = state.settings.contact || '';
            modal.querySelector('#receipt-store-email').textContent = state.settings.email || '';
            modal.querySelector('#invoice-id').textContent = sale.id; 
            modal.querySelector('#invoice-customer-name').textContent = sale.customerName; 
            modal.querySelector('#invoice-date').textContent = new Date(sale.date).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }); 
            modal.querySelector('#invoice-items').innerHTML = sale.items.map(item => { const formulaPart = item.genericName ? ` (${item.genericName})` : ''; return `<tr><td class="text-left py-1">${item.name}${formulaPart}</td><td class="text-center">${item.quantity}</td><td class="text-right">${(item.sellingPrice || 0).toFixed(2)}</td><td class="text-right">${formatCurrency(item.sellingPrice * item.quantity)}</td></tr>`; }).join(''); 
            modal.querySelector('#invoice-subtotal').textContent = formatCurrency(sale.subtotal); 
            modal.querySelector('#invoice-discount').textContent = formatCurrency(sale.discount); 

            const taxRow = modal.querySelector('#invoice-tax-row');
            if (sale.taxAmount > 0) {
                taxRow.querySelector('#invoice-tax').textContent = formatCurrency(sale.taxAmount);
                taxRow.style.display = 'flex';
            } else {
                taxRow.style.display = 'none';
            }
            
            const serviceChargeRow = modal.querySelector('#invoice-service-charge-row');
            if (sale.serviceChargeAmount > 0) {
                serviceChargeRow.querySelector('#invoice-service-charge').textContent = formatCurrency(sale.serviceChargeAmount);
                serviceChargeRow.style.display = 'flex';
            } else {
                serviceChargeRow.style.display = 'none';
            }
            
            modal.querySelector('#invoice-total').textContent = formatCurrency(sale.total); 
            modal.classList.add('visible'); 
        };

        const triggerPrint = (selector, style) => {
            const originalElement = document.querySelector(selector);
            if (!originalElement) { console.error("Print Error: Element to print not found:", selector); return; }
            const elementToPrint = originalElement.cloneNode(true);

            if (selector === '#barcode-print-area') {
                const svgElement = elementToPrint.querySelector('#barcode-svg');
                if (svgElement.jsbarcodeValue) {
                    JsBarcode(svgElement, svgElement.jsbarcodeValue, {
                        format: "CODE128",lineColor: "#000",width: 2,height: 50,displayValue: true,fontSize: 14
                    });
                }
            }

            document.body.appendChild(elementToPrint);
            elementToPrint.classList.add('printing-container');
            if (style === 'receipt') {
                elementToPrint.classList.add('printable-wrapper');
            } else { 
                elementToPrint.classList.add('printable-full-page');
            }
            window.print();
            document.body.removeChild(elementToPrint);
        };
        
        const generatePdf = async (elementSelector, fileName, type = 'thermal') => {
            const el = document.querySelector(elementSelector);
            if (!el) { console.error("PDF generation failed: Element not found."); return; }
            
            if (type === 'a4') {
                return generateLongPdf(elementSelector, fileName);
            }

            const clone = el.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.top = '0px';
            clone.style.width = el.offsetWidth + 'px';
            clone.style.height = 'auto';
            clone.classList.add('force-black-text');
            document.body.appendChild(clone);
            try {
                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(clone, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
                const pdfWidth = 75; 
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: [pdfWidth, pdfHeight] });
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
                pdf.setFontSize(7);
                pdf.setTextColor(150);
                pdf.text('KP SOFTWARE | 03139071038', pdf.internal.pageSize.getWidth() / 2, pdf.internal.pageSize.getHeight() - 4, { align: 'center', maxWidth: pdf.internal.pageSize.getWidth() - 10 });
                pdf.save(`${fileName}.pdf`);
            } catch (err) {
                console.error("PDF generation failed:", err);
            } finally {
                document.body.removeChild(clone);
            }
        };

        const generateLongPdf = async (elementSelector, fileName) => {
             const el = document.querySelector(elementSelector);
             const clone = el.cloneNode(true);
             clone.style.position = 'absolute';
             clone.style.left = '-9999px';
             clone.style.top = '0px';
             clone.style.width = '1024px'; 
             clone.style.height = 'auto';
             clone.classList.add('pdf-export-prepare');
             document.body.appendChild(clone);
             try {
                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(clone, { scale: 2.5, useCORS: true, backgroundColor: '#ffffff', windowWidth: clone.scrollWidth, windowHeight: clone.scrollHeight });
                const imgData = canvas.toDataURL('image/png', 1.0);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const ratio = canvas.height / canvas.width;
                const imgHeight = pdfWidth * ratio;
                let heightLeft = imgHeight;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pdfHeight;
                while (heightLeft > 0) {
                    position -= pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight, undefined, 'FAST');
                    heightLeft -= pdfHeight;
                }
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(150);
                    pdf.text('KP SOFTWARE | 03139071038', pdf.internal.pageSize.getWidth() / 2, pdf.internal.pageSize.getHeight() - 7, { align: 'center', maxWidth: pdf.internal.pageSize.getWidth() - 20 });
                }
                pdf.save(`${fileName}.pdf`);
            } catch(err) {
                console.error("Long PDF generation failed:", err);
            } finally {
                document.body.removeChild(clone);
            }
        }
        
        window.app = {
            addToCart: (id) => { const wasEmpty = state.cart.length === 0; const p = state.products.find(prod => prod.id === id); if (!p) return; const existing = state.cart.find(i => i.id === id); const availableStock = p.stock - (existing ? existing.quantity : 0); if (availableStock <= 0) { alert('Product is out of stock.'); return; } if (existing) { existing.quantity++; } else { state.cart.push({ ...p, quantity: 1 }); } renderCart(); if (wasEmpty && state.cart.length > 0) { openCartSidebar(); } },
            removeFromCart: (id) => { state.cart = state.cart.filter(i => i.id !== id); renderCart(); if(state.cart.length === 0) { closeCartSidebar(); } },
            updateCartQuantity: (id, change) => { const item = state.cart.find(i => i.id === id); if (!item) return; const p = state.products.find(prod => prod.id === id); if (change > 0 && p.stock <= item.quantity) return; item.quantity += change; if (item.quantity <= 0) app.removeFromCart(id); else renderCart(); },
            deleteProduct: (productId) => { if (confirm('Are you sure? This will delete the product permanently.')) { remove(ref(database, `data/${currentUserUID}/products/${productId}`)); } },
            deleteMasterDataItem: (type, id) => { if (confirm('Are you sure you want to delete this item?')) { remove(ref(database, `data/${currentUserUID}/masterData/${type}/${id}`)); } },
            deleteCustomer: (customerId) => { if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) { const ledger = getCustomerLedger(customerId); if (ledger.balance > 0) { if (!confirm(`This customer has an outstanding balance of ${formatCurrency(ledger.balance)}. Are you absolutely sure you want to delete them?`)) { return; } } remove(ref(database, `data/${currentUserUID}/customers/${customerId}`)); } },
            showEditProductModal: (productId) => { const p = state.products.find(p => p.id === productId); if (!p) return; const modal = document.getElementById('edit-product-modal'); const form = modal.querySelector('form'); form.reset(); populateProductCategorySelects('edit-'); populateGroupSelects('edit-'); modal.querySelector('#edit-product-id').value = productId; form.querySelector('#edit-product-name').value = p.name; form.querySelector('#edit-product-generic-name').value = p.genericName || ''; form.querySelector('#edit-product-batch-number').value = p.batchNumber || ''; form.querySelector('#edit-product-barcode').value = p.barcode || ''; form.querySelector('#edit-product-category').value = p.category || ''; form.querySelector('#edit-product-group').value = p.groupId || ''; form.querySelector('#edit-product-cost-price').value = p.costPrice || 0; form.querySelector('#edit-product-sell-price').value = p.sellingPrice || 0; form.querySelector('#edit-product-stock').value = p.stock || 0; form.querySelector('#edit-product-low-stock').value = p.lowStockThreshold || 10; form.querySelector('#edit-product-expiry').value = p.expiryDate || ''; form.querySelector('#edit-product-image-url').value = p.imageUrl || ''; document.getElementById('edit-product-modal').classList.add('visible'); },
            showEditCategoryModal: (categoryId) => {
                const category = state.productCategories.find(c => c.id === categoryId);
                if (!category) return;
                const modal = document.getElementById('edit-category-modal');
                modal.querySelector('#edit-category-id').value = categoryId;
                modal.querySelector('#edit-category-name').value = category.name;
                modal.querySelector('#edit-category-color').value = category.color;
                modal.classList.add('visible');
            },
            showInvoice: (saleId) => { const sale = state.sales.find(s => s.id === saleId); onInvoiceCloseCallback = null; displayInvoice(sale, false); },
            showReturnModal: (saleId) => { const sale = state.sales.find(s => s.id === saleId); if (!sale) return; const modal = document.getElementById('return-sale-modal'); modal.querySelector('#return-invoice-id').textContent = sale.id; modal.querySelector('#return-items-list').innerHTML = sale.items.map(item => { const maxReturn = item.quantity - (item.returnedQty || 0); if (maxReturn <= 0) return ''; return `<div class="grid grid-cols-3 gap-4 items-center"><span class="col-span-1">${item.name} (Sold: ${item.quantity})</span><label class="text-sm">Qty to Return:</label><input type="number" data-item-id="${item.id}" data-max-return="${maxReturn}" class="input-field" value="0" min="0" max="${maxReturn}"></div>`; }).join(''); document.getElementById('return-sale-form').dataset.saleId = saleId; modal.classList.add('visible'); },
            showSettleCreditModal: (customerId) => { const customer = state.customers.find(c => c.id === customerId); if (!customer) return; const modal = document.getElementById('settle-credit-modal'); const ledger = getCustomerLedger(customerId); modal.querySelector('#settle-customer-id').value = customerId; modal.querySelector('#settle-customer-name').textContent = customer.name; modal.querySelector('#settle-amount-due').textContent = formatCurrency(ledger.balance); const amountPaidInput = modal.querySelector('#settle-amount-paid'); amountPaidInput.value = ''; amountPaidInput.max = ledger.balance.toFixed(2); modal.querySelector('#settle-amount-remaining').textContent = formatCurrency(ledger.balance); modal.classList.add('visible'); },
            deletePurchase: (purchaseId) => { if(confirm('Are you sure you want to delete this purchase record? This will NOT update the product stock.')) { remove(ref(database, `data/${currentUserUID}/purchases/${purchaseId}`)); } },
            removePurchaseItemRow: (rowIndex) => { state.currentPurchaseItems.splice(rowIndex, 1); renderPurchaseItems(); },
            updatePurchaseItem: (index, field, value) => {
                const item = state.currentPurchaseItems[index];
                if (!item) return;

                if (field === 'name') {
                    item.name = value;
                    const selectedOption = document.querySelector(`#products-datalist option[value='${value.replace(/'/g, "\\'")}']`);
                    if (selectedOption) {
                        item.productId = selectedOption.dataset.id;
                        item.costPrice = parseFloat(selectedOption.dataset.cost) || 0;
                    } else {
                        item.productId = null;
                    }
                } else if (field === 'quantity') {
                    item.quantity = parseFloat(value) || 0;
                } else if (field === 'costPrice') {
                    item.costPrice = parseFloat(value) || 0;
                }
                renderPurchaseItems();
            },
            showPurchaseInvoiceById: (purchaseId) => { const purchase = state.purchases.find(p => p.id === purchaseId); if(purchase) displayPurchaseInvoice(purchase, false); },
            showEditPurchaseModal: (purchaseId) => { const purchase = state.purchases.find(p => p.id === purchaseId); if (!purchase) return; const modal = document.getElementById('purchase-modal'); document.getElementById('purchase-modal-title').textContent = 'Edit Supplier Purchase'; document.getElementById('purchase-form').reset(); document.getElementById('editing-purchase-id').value = purchase.id; document.getElementById('purchase-supplier-name').value = purchase.supplierName; document.getElementById('purchase-supplier-contact').value = purchase.contact || ''; document.getElementById('purchase-date').value = purchase.date; document.getElementById('purchase-amount-paid').value = purchase.amountPaid; state.currentPurchaseItems = JSON.parse(JSON.stringify(purchase.items || [])); state.editingPurchaseOriginalItems = JSON.parse(JSON.stringify(purchase.items || [])); renderPurchaseItems(); modal.classList.add('visible');},
            deleteHoldBill: (billId) => { if(confirm('Are you sure you want to delete this held bill?')) remove(ref(database, `data/${currentUserUID}/holdBills/${billId}`)); },
            resumeHoldBill: (billId) => { const bill = state.holdBills.find(b => b.id === billId); if(!bill) return; state.cart = bill.cart; document.getElementById('pos-customer-input').value = bill.customerName || 'Walk-in Customer'; document.getElementById('cart-discount-value').value = bill.discountValue || 0; updateCartTotals(); remove(ref(database, `data/${currentUserUID}/holdBills/${billId}`)); showPage('pos'); openCartSidebar(); },
            showCustomerLedger: (customerId) => { const customer = state.customers.find(c => c.id === customerId); if(!customer) return; const ledgerModal = document.getElementById('customer-ledger-modal'); ledgerModal.querySelector('#ledger-customer-name').textContent = customer.name; const ledger = getCustomerLedger(customerId); const tableBody = ledgerModal.querySelector('#customer-ledger-table-body'); let runningBalance = 0; tableBody.innerHTML = ledger.transactions.map(t => { runningBalance = t.balance; const actionCell = t.type === 'sale' ? `<td class="p-3 text-center align-top"><button class="btn btn-sm btn-info" onclick="app.showInvoice('${t.saleId}')">View</button></td>` : `<td class="p-3 text-center align-top"></td>`; return `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3 align-top">${new Date(t.date).toLocaleString()}</td><td class="p-3 align-top">${t.description}</td><td class="p-3 text-right align-top text-red-400">${formatCurrency(t.debit)}</td><td class="p-3 text-right align-top text-green-400">${formatCurrency(t.credit)}</td><td class="p-3 text-right align-top font-bold">${formatCurrency(t.balance)}</td>${actionCell}</tr>`; }).join(''); ledgerModal.classList.add('visible'); },
            deleteExpense: (expenseId) => { if(confirm('Are you sure you want to delete this expense record?')) remove(ref(database, `data/${currentUserUID}/expenses/${expenseId}`)); },
            deleteStaff: (staffId) => { if(confirm('Are you sure you want to delete this staff member? All their ledger data will also be lost.')) remove(ref(database, `data/${currentUserUID}/staff/${staffId}`)); },
            showEditStaffModal: (staffId) => { const staff = state.staff.find(s => s.id === staffId); if(!staff) return; const modal = document.getElementById('staff-modal'); modal.querySelector('#staff-modal-title').textContent = 'Edit Staff Member'; const form = modal.querySelector('#staff-form'); form.reset(); form.querySelector('#edit-staff-id').value = staff.id; form.querySelector('#staff-name-input').value = staff.name; form.querySelector('#staff-phone-input').value = staff.phone || ''; form.querySelector('#staff-role-input').value = staff.role || ''; form.querySelector('#staff-salary-input').value = staff.salary || 0; form.querySelector('#staff-joining-date-input').value = staff.joiningDate || ''; modal.classList.add('visible'); },
            showStaffLedger: (staffId) => {
                const staff = state.staff.find(s => s.id === staffId);
                if (!staff) return;
                const modal = document.getElementById('staff-ledger-modal');
                modal.querySelector('#ledger-staff-name').textContent = staff.name;
                modal.querySelector('#ledger-staff-id').value = staff.id;
                document.getElementById('staff-ledger-entry-form').reset();
                const ledgerEntries = staff.ledger ? Object.values(staff.ledger).sort((a, b) => new Date(a.date) - new Date(b.date)) : [];
                const totalAdvance = ledgerEntries.filter(e => e.type === 'Advance').reduce((sum, e) => sum + e.amount, 0);
                const totalPaid = ledgerEntries.filter(e => e.type === 'Salary').reduce((sum, e) => sum + e.amount, 0);
                const currentBalance = totalAdvance - totalPaid;
                modal.querySelector('#ledger-staff-base-salary').textContent = formatCurrency(staff.salary);
                modal.querySelector('#ledger-staff-current-balance').textContent = formatCurrency(currentBalance);
                modal.querySelector('#ledger-staff-net-payable').textContent = formatCurrency((staff.salary || 0) + currentBalance);
                const tableBody = modal.querySelector('#staff-ledger-table-body');
                let runningBalance = 0;
                tableBody.innerHTML = ledgerEntries.map(entry => {
                    let debit = 0, credit = 0;
                    if (entry.type === 'Advance') { debit = entry.amount; } else { credit = entry.amount; }
                    runningBalance += (debit - credit);
                    return `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${new Date(entry.date).toLocaleDateString()}</td><td class="p-3">${entry.notes || entry.type}</td><td class="p-3 text-right text-green-400">${formatCurrency(credit)}</td><td class="p-3 text-right text-red-400">${formatCurrency(debit)}</td><td class="p-3 text-right font-bold">${formatCurrency(runningBalance)}</td></tr>`;
                }).join('');
                document.getElementById('generate-full-month-salary-btn').onclick = () => app.generateMonthlySalarySlip(staffId);
                modal.classList.add('visible');
            },
            generateMonthlySalarySlip: (staffId) => {
                const staff = state.staff.find(s => s.id === staffId);
                if (!staff || !staff.salary) { alert('Staff salary is not set.'); return; }
                const date = new Date();
                const month = date.getMonth();
                const year = date.getFullYear();
                const ledgerEntries = staff.ledger ? Object.values(staff.ledger) : [];
                const advancesThisMonth = ledgerEntries.filter(e => e.type === 'Advance' && new Date(e.date).getMonth() === month && new Date(e.date).getFullYear() === year);
                const totalAdvances = advancesThisMonth.reduce((sum, e) => sum + e.amount, 0);
                const netPayable = staff.salary - totalAdvances;
                if (!confirm(`Pay ${formatCurrency(netPayable)} to ${staff.name} for ${date.toLocaleString('default', { month: 'long' })} salary?\nThis will create a final salary slip.`)) return;
                const entryData = { type: 'Salary', amount: netPayable, notes: `Salary for ${date.toLocaleString('default', { month: 'long' })} ${year}`, date: new Date().toISOString() };
                const ledgerEntryRef = push(ref(database, `data/${currentUserUID}/staff/${staffId}/ledger`));
                set(ledgerEntryRef, {...entryData, id: ledgerEntryRef.key}).then(() => {
                    alert('Salary slip generated!');
                    app.displayMonthlySalarySlip(staff, advancesThisMonth, totalAdvances, netPayable, entryData.date, true);
                    app.showStaffLedger(staffId); 
                }).catch(err => alert('Error: ' + err.message));
            },
            displayMonthlySalarySlip: (staff, advances, totalAdvances, netPayable, paymentDate, isFirstTime = false) => {
                const modal = document.getElementById('monthly-salary-slip-modal');
                modal.dataset.isFirstTime = isFirstTime;
                const date = new Date(paymentDate);
                modal.querySelector('#monthly-slip-store-name').textContent = state.settings.storeName || 'My Store';
                modal.querySelector('#monthly-slip-store-address').textContent = state.settings.address || '';
                modal.querySelector('#monthly-slip-staff-name').textContent = staff.name;
                modal.querySelector('#monthly-slip-date').textContent = date.toLocaleDateString();
                modal.querySelector('#monthly-slip-month').textContent = `${date.toLocaleString('default', { month: 'long' })} ${date.getFullYear()}`;
                modal.querySelector('#monthly-slip-base-salary').textContent = formatCurrency(staff.salary);
                modal.querySelector('#monthly-slip-advances-list').innerHTML = advances.map(a => `<div class="flex justify-between"><span>- ${a.notes || 'Advance'} (${new Date(a.date).toLocaleDateString()})</span><span>-${formatCurrency(a.amount)}</span></div>`).join('') || '<span>No advances this month.</span>';
                modal.querySelector('#monthly-slip-total-advances').textContent = formatCurrency(totalAdvances);
                modal.querySelector('#monthly-slip-net-payable').textContent = formatCurrency(netPayable);
                modal.classList.add('visible');
            },
            showStaffReceipt: (staff, entryData, title, isFirstTime = false) => { 
                const modal = document.getElementById('staff-receipt-modal');
                modal.dataset.isFirstTime = isFirstTime;
                modal.querySelector('#staff-receipt-store-name').textContent = state.settings.storeName || 'My Store';
                modal.querySelector('#staff-receipt-store-address').textContent = state.settings.address || '';
                modal.querySelector('#staff-receipt-title').textContent = title; 
                modal.querySelector('#staff-receipt-staff-name').textContent = staff.name; 
                modal.querySelector('#staff-receipt-date').textContent = new Date(entryData.date).toLocaleDateString(); 
                modal.querySelector('#staff-receipt-notes').textContent = entryData.notes; 
                modal.querySelector('#staff-receipt-amount').textContent = formatCurrency(entryData.amount); 
                modal.classList.add('visible'); 
            },
            showAllStaffTransactions: () => { const allTransactions = []; state.staff.forEach(s => { if (s.ledger) { Object.values(s.ledger).forEach(entry => allTransactions.push({ ...entry, staffName: s.name, staffId: s.id })); } }); allTransactions.sort((a,b) => new Date(b.date) - new Date(a.date)); const tableBody = document.getElementById('staff-history-table-body'); tableBody.innerHTML = allTransactions.map(t => `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${new Date(t.date).toLocaleDateString()}</td><td class="p-3">${t.staffName}</td><td class="p-3 font-semibold ${t.type === 'Salary' ? 'text-green-400' : 'text-yellow-400'}">${t.type}</td><td class="p-3">${t.notes || ''}</td><td class="p-3 text-right">${formatCurrency(t.amount)}</td><td class="p-3 text-center"><button class="btn btn-sm btn-info" onclick="app.reprintStaffReceipt('${t.staffId}', '${t.id}')">View</button></td></tr>`).join(''); document.getElementById('staff-transactions-history-modal').classList.add('visible'); },
            reprintStaffReceipt: (staffId, transactionId) => { const staff = state.staff.find(s => s.id === staffId); const transaction = staff?.ledger?.[transactionId]; if (staff && transaction) { const title = transaction.type === 'Salary' ? 'Salary Payment Receipt' : 'Advance Payment Receipt'; app.showStaffReceipt(staff, transaction, title, false); } else { alert('Transaction not found!'); } },
            printBarcode: (productId) => {
                const product = state.products.find(p => p.id === productId);
                if (!product || !product.barcode) { alert('This product does not have a barcode.'); return; }
                const modal = document.getElementById('barcode-modal');
                modal.querySelector('#barcode-product-name').textContent = product.name;
                modal.querySelector('#barcode-product-price').textContent = formatCurrency(product.sellingPrice);
                const svgElement = modal.querySelector('#barcode-svg');
                svgElement.jsbarcodeValue = product.barcode;
                try {
                    JsBarcode(svgElement, product.barcode, {
                        format: "CODE128", lineColor: "#000", width: 2.5, height: 60, displayValue: true, fontSize: 18, margin: 10
                    });
                    modal.classList.add('visible');
                } catch (e) { console.error(e); alert("Error generating barcode. The barcode value might be invalid.");}
            }
        };
        
        function renderMasterDataPage(){ renderGroupsTable(); renderProductCategoriesTable(); renderExpenseCategoriesTable(); }
        function renderGroupsTable() { const tableBody = document.getElementById('groups-table-body'); if (!tableBody) return; tableBody.innerHTML = state.groups.sort((a,b) => a.name.localeCompare(b.name)).map(g => `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${g.name}</td><td class="text-center p-3"><button class="btn btn-sm btn-danger" onclick="app.deleteMasterDataItem('groups', '${g.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="2" class="text-center p-4">No groups found.</td></tr>`;}
        function renderProductCategoriesTable() { 
            const tableBody = document.getElementById('product-categories-table-body'); 
            if (!tableBody) return; 
            tableBody.innerHTML = state.productCategories.sort((a,b) => a.name.localeCompare(b.name)).map(c => `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3 flex items-center gap-3"><span class="w-5 h-5 rounded-full border" style="background-color:${c.color}; border-color: var(--border-color);"></span>${c.name}</td><td class="text-center p-3 space-x-2"><button class="btn btn-sm btn-warning" onclick="app.showEditCategoryModal('${c.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="app.deleteMasterDataItem('productCategories', '${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="2" class="text-center p-4">No product categories found.</td></tr>`;
        }
        function renderExpenseCategoriesTable() { const tableBody = document.getElementById('expense-categories-table-body'); if (!tableBody) return; tableBody.innerHTML = state.expenseCategories.sort((a,b) => a.name.localeCompare(b.name)).map(c => `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${c.name}</td><td class="text-center p-3"><button class="btn btn-sm btn-danger" onclick="app.deleteMasterDataItem('expenseCategories', '${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="2" class="text-center p-4">No expense categories found.</td></tr>`;}
        
        function getCustomerLedger(customerId) { const customer = state.customers.find(c => c.id === customerId); if(!customer) return { balance: 0, transactions: [] }; const sales = state.sales.filter(s => s.customerId === customerId && s.status === 'Credit'); const payments = customer.payments ? Object.values(customer.payments) : []; const rawTransactions = [ ...sales.map(s => ({ type: 'sale', date: s.date, amount: s.total, description: `Sale (Invoice: ${s.id})`, saleId: s.id })), ...payments.map(p => ({ type: 'payment', date: p.date, amount: p.amount, description: 'Payment Received' })) ].sort((a,b) => new Date(a.date) - new Date(b.date)); let balance = 0; const transactions = rawTransactions.map(t => { const debit = t.type === 'sale' ? t.amount : 0; const credit = t.type === 'payment' ? t.amount : 0; balance += debit - credit; return { ...t, debit, credit, balance }; }); return { balance, transactions }; }
        function renderCustomersPage() { const tableBody = document.getElementById('customers-table-body'); if(!tableBody) return; tableBody.innerHTML = state.customers.map(customer => { const ledger = getCustomerLedger(customer.id); return `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${customer.name}</td><td class="p-3">${customer.phone || 'N/A'}</td><td class="p-3 font-bold text-red-400">${formatCurrency(ledger.balance)}</td><td class="p-3 text-center space-x-2"><button class="btn btn-sm btn-info" onclick="app.showCustomerLedger('${customer.id}')">Ledger</button><button class="btn btn-sm btn-success" onclick="app.showSettleCreditModal('${customer.id}')" ${ledger.balance <= 0 ? 'disabled' : ''}>Settle</button><button class="btn btn-sm btn-danger" onclick="app.deleteCustomer('${customer.id}')">Delete</button></td></tr>`; }).join('') || `<tr><td colspan="4" class="text-center p-4">No customers found.</td></tr>`; }
        function renderHoldBillsPage() { const container = document.getElementById('hold-bills-list'); if(!container) return; container.innerHTML = state.holdBills.map(bill => { const total = bill.cart.reduce((sum, item) => sum + item.sellingPrice * item.quantity, 0); const itemsList = bill.cart.map(item => `<div class="flex justify-between text-sm"><span>${item.name} x ${item.quantity}</span><span>${formatCurrency(item.sellingPrice * item.quantity)}</span></div>`).join(''); return `<div class="card p-4 flex flex-col justify-between"><div><div class="flex justify-between items-baseline"><p class="font-bold text-lg">${bill.customerName || 'Walk-in Customer'}</p><p class="text-2xl font-bold">${formatCurrency(total)}</p></div><hr class="my-2" style="border-color: var(--border-color);"><div class="space-y-1 max-h-32 overflow-y-auto pr-2">${itemsList}</div></div><div class="flex gap-2 mt-4 pt-2 border-t" style="border-color: var(--border-color);"><button class="btn btn-sm btn-success flex-grow" onclick="app.resumeHoldBill('${bill.id}')"><i class="fas fa-play mr-2"></i>Resume</button><button class="btn btn-sm btn-danger flex-grow" onclick="app.deleteHoldBill('${bill.id}')"><i class="fas fa-trash mr-2"></i>Delete</button></div></div>`; }).join('') || `<div class="col-span-full text-center p-10" style="color: var(--text-secondary);">No bills are currently on hold.</div>`;}
        function renderReturnedBillsPage() { const tableBody = document.getElementById('returned-bills-table-body'); if(!tableBody) return; const searchTerm = document.getElementById('returned-bills-search').value.toLowerCase(); const returnedSales = state.sales.filter(s => (s.status === 'Returned' || s.status === 'Partially Returned') && s.id.toLowerCase().includes(searchTerm)).sort((a, b) => new Date(b.date) - new Date(a.date)); tableBody.innerHTML = returnedSales.map(sale => { const returnedValue = sale.items.reduce((sum, item) => sum + (item.returnedQty || 0) * item.sellingPrice, 0); return `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${sale.id}</td><td class="p-3">${new Date(sale.date).toLocaleString()}</td><td class="p-3">${sale.customerName}</td><td class="p-3 font-semibold text-orange-400">${sale.status}</td><td class="p-3">${formatCurrency(returnedValue)}</td><td class="p-3 text-center"><button class="btn btn-sm btn-info" onclick="app.showInvoice('${sale.id}')"><i class="fas fa-eye"></i></button></td></tr>`; }).join('') || `<tr><td colspan="6" class="text-center p-4">No returned bills found.</td></tr>`; }
        async function renderProductsTable() {
            const tableBody = document.getElementById('products-table-body');
            if (!tableBody) return;
            const searchTerm = document.getElementById('product-table-search').value.toLowerCase();
            const filteredProducts = state.products.filter(p => 
                (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                (p.barcode && p.barcode.toLowerCase().includes(searchTerm)) ||
                (p.genericName && p.genericName.toLowerCase().includes(searchTerm)) ||
                (p.batchNumber && p.batchNumber.toLowerCase().includes(searchTerm))
            );
            let rowsHtml = '';
            for (const p of filteredProducts.sort((a, b) => a.name.localeCompare(b.name))) {
                const imageSrc = p.imageUrl || 'icons/placeholder.png';
                rowsHtml += `<tr class="border-b" style="border-color: var(--border-color);">
                    <td class="p-3"><img src="${imageSrc}" class="h-12 w-12 object-cover rounded-md mx-auto"></td>
                    <td class="p-3" title="${p.name}">${p.name}</td>
                    <td class="p-3">${p.barcode || '-'}</td>
                    <td class="p-3" title="${p.genericName || ''}">${p.genericName || '-'}</td>
                    <td class="p-3">${p.batchNumber || '-'}</td>
                    <td class="p-3">${p.category || 'N/A'}</td>
                    <td class="p-3 text-right">${formatCurrency(p.costPrice)}</td>
                    <td class="p-3 text-right">${formatCurrency(p.sellingPrice)}</td>
                    <td class="p-3 text-center">${p.stock || 0}</td>
                    <td class="p-3">${p.expiryDate || 'N/A'}</td>
                    <td class="p-3 text-center space-x-1">
                        <button class="btn btn-sm btn-info" onclick="app.showEditProductModal('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-secondary" onclick="app.printBarcode('${p.id}')" title="Print Barcode"><i class="fas fa-barcode"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="app.deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }
            tableBody.innerHTML = rowsHtml || `<tr><td colspan="11" class="text-center p-4">No products found.</td></tr>`;
        };
        function renderPurchasesPage() { const tableBody = document.getElementById('purchases-table-body'); if (!tableBody) return; tableBody.innerHTML = state.purchases.sort((a,b) => new Date(b.date) - new Date(a.date)).map(p => { const remaining = (p.totalAmount || 0) - (p.amountPaid || 0); return `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${p.supplierName}</td><td class="p-3">${new Date(p.date).toLocaleDateString()}</td><td class="p-3">${p.id}</td><td class="p-3 text-right">${formatCurrency(p.totalAmount)}</td><td class="p-3 text-right">${formatCurrency(p.amountPaid)}</td><td class="p-3 font-bold text-right ${remaining > 0 ? 'text-red-400' : 'text-green-400'}">${formatCurrency(remaining)}</td><td class="p-3 text-center space-x-2"><button class="btn btn-sm btn-info" onclick="app.showPurchaseInvoiceById('${p.id}')"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-warning" onclick="app.showEditPurchaseModal('${p.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="app.deletePurchase('${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }).join('') || `<tr><td colspan="7" class="text-center p-4">No purchase history found.</td></tr>`; };
        function renderExpensesPage() { const tableBody = document.getElementById('expenses-table-body'); if (!tableBody) return; tableBody.innerHTML = state.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(e => `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${new Date(e.date).toLocaleDateString()}</td><td class="p-3">${e.categoryName || 'General'}</td><td class="p-3">${e.description}</td><td class="p-3 text-right">${formatCurrency(e.amount)}</td><td class="p-3 text-center"><button class="btn btn-sm btn-danger" onclick="app.deleteExpense('${e.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="5" class="text-center p-4">No expenses recorded yet.</td></tr>`; }
        function renderStaffPage() { const tableBody = document.getElementById('staff-table-body'); if (!tableBody) return; tableBody.innerHTML = state.staff.sort((a,b) => a.name.localeCompare(b.name)).map(s => { const ledgerEntries = s.ledger ? Object.values(s.ledger) : []; const balance = ledgerEntries.reduce((bal, entry) => bal + (entry.type === 'Advance' ? entry.amount : -entry.amount), 0); return `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${s.name}</td><td class="p-3">${s.phone || 'N/A'}</td><td class="p-3">${s.role || 'N/A'}</td><td class="p-3 text-right">${formatCurrency(s.salary)}</td><td class="p-3 font-bold text-right ${balance > 0 ? 'text-red-400' : 'text-green-400'}">${formatCurrency(balance)}</td><td class="p-3 text-center space-x-2"><button class="btn btn-sm btn-success" onclick="app.showStaffLedger('${s.id}')">Manage</button><button class="btn btn-sm btn-warning" onclick="app.showEditStaffModal('${s.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="app.deleteStaff('${s.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }).join('') || `<tr><td colspan="6" class="text-center p-4">No staff members found. Add one to get started.</td></tr>`; }
        
        function renderDayEndReport() {
            const startDateEl = document.getElementById('dayend-start-date'); const endDateEl = document.getElementById('dayend-end-date');
            if (!startDateEl.value || !endDateEl.value) return;
            let startDate = new Date(startDateEl.value); startDate.setHours(0, 0, 0, 0);
            let endDate = new Date(endDateEl.value); endDate.setHours(23, 59, 59, 999);

            const filteredSales = state.sales.filter(s => { const d = new Date(s.date); return d >= startDate && d <= endDate; });
            const filteredPurchases = state.purchases.filter(p => { const d = new Date(p.date); return d >= startDate && d <= endDate; });
            const filteredExpenses = state.expenses.filter(e => { const d = new Date(e.date); return d >= startDate && d <= endDate; });
            const expiredInPeriod = state.products.filter(p => p.expiryDate && new Date(p.expiryDate) >= startDate && new Date(p.expiryDate) <= endDate);
            
            const totalSales = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const totalProfit = filteredSales.reduce((sum, s) => sum + s.profit, 0);
            const totalPurchasesPaid = filteredPurchases.reduce((sum, p) => sum + p.amountPaid, 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalCashSales = filteredSales.filter(s => s.status === 'Completed').reduce((sum, s) => sum + s.total, 0);
            
            const creditGiven = filteredSales.filter(s => s.status === 'Credit').reduce((sum, s) => sum + s.total, 0);
            const creditReceived = state.customers.flatMap(c => c.payments ? Object.values(c.payments) : []).filter(p => { const pDate = new Date(p.date); return pDate >= startDate && pDate <= endDate; }).reduce((sum, p) => sum + p.amount, 0);
            
            const cashInHand = (totalCashSales + creditReceived) - (totalPurchasesPaid + totalExpenses);

            document.getElementById('dayend-report-title').textContent = `Report from ${startDateEl.value} to ${endDateEl.value}`;
            document.getElementById('dayend-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('dayend-total-profit').textContent = formatCurrency(totalProfit);
            document.getElementById('dayend-credit-given').textContent = formatCurrency(creditGiven);
            document.getElementById('dayend-credit-received').textContent = formatCurrency(creditReceived);
            document.getElementById('dayend-total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('dayend-cash-in-hand').textContent = formatCurrency(cashInHand);

            document.getElementById('dayend-sales-table').innerHTML = filteredSales.map(s => `<tr><td class="p-2">${s.id}</td><td>${s.customerName}</td><td class="text-right">${formatCurrency(s.total)}</td></tr>`).join('') || `<tr><td colspan="3" class="p-2 text-center text-gray-400">No Sales</td></tr>`;
            document.getElementById('dayend-purchases-table').innerHTML = filteredPurchases.map(p => `<tr><td class="p-2">${p.supplierName}</td><td>${p.id}</td><td class="text-right">${formatCurrency(p.totalAmount)}</td></tr>`).join('') || `<tr><td colspan="3" class="p-2 text-center text-gray-400">No Purchases</td></tr>`;
            document.getElementById('dayend-expenses-table').innerHTML = filteredExpenses.map(e => `<tr><td class="p-2">${e.description}</td><td class="text-right">${formatCurrency(e.amount)}</td></tr>`).join('') || `<tr><td colspan="2" class="p-2 text-center text-gray-400">No Expenses</td></tr>`;
            document.getElementById('dayend-expired-table').innerHTML = expiredInPeriod.map(p => `<tr><td class="p-2">${p.name}</td><td>${p.stock}</td><td class="text-right">${formatCurrency(p.costPrice * p.stock)}</td></tr>`).join('') || `<tr><td colspan="3" class="p-2 text-center text-gray-400">No Expired Products</td></tr>`;
        }
        document.getElementById('dayend-filter-btn').addEventListener('click', renderDayEndReport);

        const renderCart = () => { document.getElementById('cart-items').innerHTML = state.cart.map(item => `<div class="flex justify-between items-center p-2 rounded-md" style="background-color: #334155;"><div style="color: #e2e8f0;"><p class="font-medium text-amber-400">${item.name}</p><p class="text-sm text-gray-400">${formatCurrency(item.sellingPrice)} x ${item.quantity}</p></div><div class="flex items-center gap-3"><button class="w-6 h-6 bg-slate-600 rounded" onclick="app.updateCartQuantity('${item.id}', -1)">-</button><span>${item.quantity}</span><button class="w-6 h-6 bg-slate-600 rounded" onclick="app.updateCartQuantity('${item.id}', 1)">+</button><button class="text-red-500 ml-2" onclick="app.removeFromCart('${item.id}')"><i class="fas fa-times-circle"></i></button></div></div>`).join('') || '<p class="text-center mt-16 text-gray-400">Cart is empty.</p>'; updateCartTotals(); renderPosProducts(); };
        const updateCartTotals = () => { 
            const subtotal = state.cart.reduce((sum, item) => sum + item.sellingPrice * item.quantity, 0); 
            const discountValue = parseFloat(document.getElementById('cart-discount-value').value) || 0; 
            let calculatedDiscount = 0; 
            if (state.settings.discountType === 'percent') { calculatedDiscount = (subtotal * discountValue) / 100; } else { calculatedDiscount = discountValue; } 
            
            let taxAmount = 0;
            const taxRow = document.getElementById('cart-tax-row');
            if (state.settings.taxEnabled) {
                taxAmount = subtotal * (state.settings.taxRate / 100);
                taxRow.querySelector('#cart-tax').textContent = formatCurrency(taxAmount);
                taxRow.style.display = 'flex';
            } else {
                taxRow.style.display = 'none';
            }

            let serviceChargeAmount = 0;
            const serviceChargeRow = document.getElementById('cart-service-charge-row');
             if (state.settings.serviceChargeEnabled) {
                serviceChargeAmount = subtotal * (state.settings.serviceChargeRate / 100);
                serviceChargeRow.querySelector('#cart-service-charge').textContent = formatCurrency(serviceChargeAmount);
                serviceChargeRow.style.display = 'flex';
            } else {
                serviceChargeRow.style.display = 'none';
            }

            const total = subtotal - calculatedDiscount + taxAmount + serviceChargeAmount;

            document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal); 
            document.getElementById('cart-total').textContent = formatCurrency(Math.max(0, total)); 
            const discountLabel = document.getElementById('cart-discount-label'); 
            if (discountLabel) { discountLabel.textContent = `Discount (${state.settings.discountType === 'percent' ? '%' : '₨'})`; } 
        };
        const resetPOS = () => { state.cart = []; document.getElementById('pos-customer-input').value = ''; document.getElementById('cart-discount-value').value = 0; renderCart(); closeCartSidebar(); };
        
        document.getElementById('cart-close-btn').addEventListener('click', closeCartSidebar);
        document.getElementById('product-search').addEventListener('input', renderPosProducts);
        document.getElementById('product-table-search').addEventListener('input', renderProductsTable);
        document.getElementById('transaction-search').addEventListener('input', renderTransactionsPage);
        document.getElementById('returned-bills-search').addEventListener('input', renderReturnedBillsPage);
        document.getElementById('group-filter-dropdown').addEventListener('change', (e) => { state.activeGroup = e.target.value; renderPosProducts(); });
        document.getElementById('formula-filter-dropdown').addEventListener('change', (e) => { state.activeFormula = e.target.value; renderPosProducts(); });
        document.getElementById('cart-discount-value').addEventListener('input', updateCartTotals);
        
        document.getElementById('close-invoice-btn').addEventListener('click', () => {
            document.getElementById('invoice-modal').classList.remove('visible');
            if (typeof onInvoiceCloseCallback === 'function') {
                onInvoiceCloseCallback();
                onInvoiceCloseCallback = null;
            }
        });

        document.getElementById('print-invoice-btn').addEventListener('click', function() {
            const modal = document.getElementById('invoice-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#invoice-print-area-wrapper', state.settings.printerType === 'thermal' ? 'receipt' : 'full-page'));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to print this invoice again?")) { action(); } }
        });

        document.getElementById('download-invoice-pdf-btn').addEventListener('click', function() {
            const modal = document.getElementById('invoice-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                handleButtonFeedback(this, 'Downloading...', () => generatePdf('#invoice-print-area-wrapper', `invoice-${document.getElementById('invoice-id').textContent}`, state.settings.printerType));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to download this invoice PDF again?")) { action(); } }
        });
        
        document.getElementById('db-filter-btn').addEventListener('click', () => { 
            const start = document.getElementById('db-start-date').value; 
            const end = document.getElementById('db-end-date').value; 
            if(start && end) { 
                updateDashboard(new Date(start), new Date(end)); 
            } else { 
                alert('Please select both start and end dates.'); 
            }
        });

        document.getElementById('db-today-btn').addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('db-start-date').value = today;
            document.getElementById('db-end-date').value = today;
            document.getElementById('db-filter-btn').click();
        });
        document.getElementById('db-week-btn').addEventListener('click', () => {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            document.getElementById('db-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('db-end-date').value = today.toISOString().split('T')[0];
            document.getElementById('db-filter-btn').click();
        });
        document.getElementById('db-month-btn').addEventListener('click', () => {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('db-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('db-end-date').value = today.toISOString().split('T')[0];
            document.getElementById('db-filter-btn').click();
        });

        function renderSalesReport(startDate, endDate, title) {
            if (!startDate || !endDate) return;
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);

            const reportType = document.getElementById('report-type-select').value;
            const reportTitleEl = document.getElementById('report-title');
            const tableHead = document.getElementById('report-table-head');
            const tableBody = document.getElementById('report-transactions-table');
            
            reportTitleEl.textContent = title || "Sales Report";
            
            const filteredSales = state.sales.filter(s => { const saleDate = new Date(s.date); return saleDate >= startDate && saleDate <= endDate && s.status !== 'Returned'; });

            const netSales = filteredSales.reduce((sum, s) => sum + (s.total || 0), 0);
            const netProfit = filteredSales.reduce((sum, s) => sum + (s.profit || 0), 0);
            
            document.getElementById('report-total-sales').textContent = formatCurrency(netSales);
            document.getElementById('report-total-profit').textContent = formatCurrency(netProfit);

            if (reportType === 'invoice') {
                document.getElementById('report-total-bills').textContent = filteredSales.length;
                tableHead.innerHTML = `<tr><th class="p-3">Invoice ID</th><th class="p-3">Date</th><th class="p-3">Customer</th><th class="p-3 text-right">Total</th><th class="p-3 text-right">Profit</th></tr>`;
                tableBody.innerHTML = filteredSales.sort((a, b) => new Date(b.date) - new Date(a.date)).map(s => `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${s.id}</td><td class="p-3">${new Date(s.date).toLocaleString()}</td><td class="p-3">${s.customerName || 'N/A'}</td><td class="p-3 text-right">${formatCurrency(s.total)}</td><td class="p-3 text-right text-green-400">${formatCurrency(s.profit)}</td></tr>`).join('') || `<tr><td colspan="5" class="text-center p-4">No sales in this period.</td></tr>`;
            } else if (reportType === 'formula') {
                const genericSales = {};
                filteredSales.forEach(sale => {
                    if (sale.subtotal > 0) {
                        sale.items.forEach(item => {
                            if ((item.returnedQty || 0) === item.quantity) return;
                            const genericId = item.genericName || 'no-generic';
                            const genericName = item.genericName || 'No Generic Name';
                            if (!genericSales[genericId]) { genericSales[genericId] = { name: genericName, qty: 0, sales: 0, profit: 0 }; }
                            const qtySold = item.quantity - (item.returnedQty || 0);
                            const itemValueProportion = sale.subtotal > 0 ? (item.sellingPrice * qtySold) / sale.subtotal : 0;
                            genericSales[genericId].qty += qtySold;
                            genericSales[genericId].sales += sale.total * itemValueProportion;
                            genericSales[genericId].profit += sale.profit * itemValueProportion;
                        });
                    }
                });
                const genericArray = Object.values(genericSales).sort((a,b) => b.sales - a.sales);
                document.getElementById('report-total-bills').textContent = genericArray.length;
                tableHead.innerHTML = `<tr><th class="p-3">Generic Name</th><th class="p-3 text-right">Qty Sold</th><th class="p-3 text-right">Net Sales</th><th class="p-3 text-right">Net Profit</th></tr>`;
                tableBody.innerHTML = genericArray.map(f => `<tr class="border-b" style="border-color: var(--border-color);"><td class="p-3">${f.name}</td><td class="p-3 text-right">${f.qty}</td><td class="p-3 text-right">${formatCurrency(f.sales)}</td><td class="p-3 text-right text-green-400">${formatCurrency(f.profit)}</td></tr>`).join('') || `<tr><td colspan="4" class="text-center p-4">No sales in this period.</td></tr>`;
            }
        }

        const reportFilterHandler = () => { 
            const startInput = document.getElementById('report-start-date');
            const endInput = document.getElementById('report-end-date');
            const start = startInput.value || new Date().toISOString().split('T')[0]; 
            const end = endInput.value || new Date().toISOString().split('T')[0]; 
            if(!startInput.value) startInput.value = start;
            if(!endInput.value) endInput.value = end;
            renderSalesReport(new Date(start), new Date(end), `Report from ${start} to ${end}`); 
        };
        document.getElementById('report-daily-btn').addEventListener('click', () => { const today = new Date(); document.getElementById('report-start-date').value = today.toISOString().split('T')[0]; document.getElementById('report-end-date').value = today.toISOString().split('T')[0]; reportFilterHandler(); });
        document.getElementById('report-weekly-btn').addEventListener('click', () => { const today = new Date(); const dayOfWeek = today.getDay(); const startDate = new Date(today); startDate.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0]; document.getElementById('report-end-date').value = today.toISOString().split('T')[0]; reportFilterHandler(); });
        document.getElementById('report-monthly-btn').addEventListener('click', () => { const today = new Date(); const startDate = new Date(today.getFullYear(), today.getMonth(), 1); document.getElementById('report-start-date').value = startDate.toISOString().split('T')[0]; document.getElementById('report-end-date').value = today.toISOString().split('T')[0]; reportFilterHandler(); });
        document.getElementById('report-filter-btn').addEventListener('click', reportFilterHandler);
        document.getElementById('report-type-select').addEventListener('change', reportFilterHandler);
        
        document.getElementById('print-report-btn').addEventListener('click', function() {
            if (confirm("Are you sure you want to print this report?")) {
                handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#report-print-area', 'full-page'));
            }
        });
        document.getElementById('print-dayend-report-btn').addEventListener('click', function() {
            if (confirm("Are you sure you want to print this day-end report?")) {
                handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#dayend-report-print-area', 'full-page'));
            }
        });
        document.getElementById('print-ledger-btn').addEventListener('click', function() {
            if (confirm("Are you sure you want to print this ledger?")) {
                handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#customer-ledger-printable-area', 'full-page'));
            }
        });
        
        document.getElementById('print-purchase-invoice-btn').addEventListener('click', function() {
            const modal = document.getElementById('purchase-invoice-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#purchase-invoice-print-area-wrapper', state.settings.printerType === 'thermal' ? 'receipt' : 'full-page'));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to print this purchase invoice again?")) { action(); } }
        });

        document.getElementById('print-barcode-btn').addEventListener('click', function() {
            if (confirm("Are you sure you want to print this barcode?")) {
                handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#barcode-print-area', 'receipt'));
            }
        });

        document.getElementById('download-report-pdf-btn').addEventListener('click', function() {
            if (confirm("Are you sure you want to download this report PDF?")) {
                handleButtonFeedback(this, 'Downloading...', () => generatePdf('#report-print-area', `sales-report-${new Date().toISOString().split('T')[0]}`, 'a4'));
            }
        });
        document.getElementById('download-dayend-report-pdf-btn').addEventListener('click', function() {
            if (confirm("Are you sure you want to download this day-end report PDF?")) {
                handleButtonFeedback(this, 'Downloading...', () => generatePdf('#dayend-report-print-area', `day-end-report-${new Date().toISOString().split('T')[0]}`, 'a4'));
            }
        });
        document.getElementById('download-ledger-pdf-btn').addEventListener('click', function() {
            if (confirm("Are you sure you want to download this ledger PDF?")) {
                handleButtonFeedback(this, 'Downloading...', () => generatePdf('#customer-ledger-printable-area', `ledger-${document.getElementById('ledger-customer-name').textContent}`, 'a4'));
            }
        });
        
        document.getElementById('download-purchase-invoice-pdf-btn').addEventListener('click', function() {
             const modal = document.getElementById('purchase-invoice-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                handleButtonFeedback(this, 'Downloading...', () => generatePdf('#purchase-invoice-print-area-wrapper', `purchase-${document.getElementById('purchase-invoice-id').textContent}`, state.settings.printerType));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to download this purchase invoice PDF again?")) { action(); } }
        });

        document.getElementById('cancel-return-btn').onclick = () => document.getElementById('return-sale-modal').classList.remove('visible');
        document.getElementById('cancel-edit-product-btn').onclick = () => document.getElementById('edit-product-modal').classList.remove('visible');
        document.getElementById('cancel-add-product-btn').onclick = () => document.getElementById('add-product-modal').classList.remove('visible');
        document.getElementById('cancel-barcode-print-btn').onclick = () => document.getElementById('barcode-modal').classList.remove('visible');
        document.getElementById('cancel-customer-btn').onclick = () => document.getElementById('customer-modal').classList.remove('visible');
        document.getElementById('cancel-purchase-btn').onclick = () => document.getElementById('purchase-modal').classList.remove('visible');
        document.getElementById('cancel-settle-credit-btn').onclick = () => document.getElementById('settle-credit-modal').classList.remove('visible');
        document.getElementById('cancel-sub-product-btn').onclick = () => document.getElementById('new-product-submodal').classList.remove('visible');
        document.getElementById('cancel-credit-select-btn').onclick = () => document.getElementById('credit-customer-select-modal').classList.remove('visible');
        document.getElementById('cancel-ledger-btn').onclick = () => document.getElementById('customer-ledger-modal').classList.remove('visible');
        document.getElementById('cancel-staff-btn').onclick = () => document.getElementById('staff-modal').classList.remove('visible');
        document.getElementById('cancel-staff-ledger-btn').onclick = () => document.getElementById('staff-ledger-modal').classList.remove('visible');
        document.getElementById('close-staff-history-btn').onclick = () => document.getElementById('staff-transactions-history-modal').classList.remove('visible');
        document.getElementById('close-staff-receipt-btn').onclick = () => document.getElementById('staff-receipt-modal').classList.remove('visible');
        document.getElementById('close-monthly-slip-btn').onclick = () => document.getElementById('monthly-salary-slip-modal').classList.remove('visible');
        document.getElementById('close-purchase-invoice-btn').onclick = () => document.getElementById('purchase-invoice-modal').classList.remove('visible');
        document.getElementById('cancel-edit-category-btn').onclick = () => document.getElementById('edit-category-modal').classList.remove('visible');
        document.getElementById('show-help-modal-btn').onclick = () => document.getElementById('help-modal').classList.add('visible');
        document.getElementById('close-help-modal-btn').onclick = () => document.getElementById('help-modal').classList.remove('visible');

        document.getElementById('print-staff-receipt-btn').addEventListener('click', function() {
            const modal = document.getElementById('staff-receipt-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                 handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#staff-receipt-print-wrapper', state.settings.printerType === 'thermal' ? 'receipt' : 'full-page'));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to print this receipt again?")) { action(); } }
        });
        document.getElementById('download-staff-receipt-btn').addEventListener('click', function() {
            const modal = document.getElementById('staff-receipt-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                handleButtonFeedback(this, 'Downloading...', () => generatePdf('#staff-receipt-print-wrapper', `staff-receipt-${Date.now()}`, state.settings.printerType));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to download this receipt PDF again?")) { action(); } }
        });
        document.getElementById('print-monthly-slip-btn').addEventListener('click', function() {
            const modal = document.getElementById('monthly-salary-slip-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                handlePrintButtonFeedback(this, 'Printing...', () => triggerPrint('#monthly-salary-slip-wrapper', state.settings.printerType === 'thermal' ? 'receipt' : 'full-page'));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to print this monthly slip again?")) { action(); } }
        });
        document.getElementById('download-monthly-slip-btn').addEventListener('click', function() {
            const modal = document.getElementById('monthly-salary-slip-modal');
            const isFirst = modal.dataset.isFirstTime === 'true';
            const action = () => {
                handleButtonFeedback(this, 'Downloading...', () => generatePdf('#monthly-salary-slip-wrapper', `salary-slip-${Date.now()}`, state.settings.printerType));
                modal.dataset.isFirstTime = 'false';
            };
            if (isFirst) { action(); } else { if (confirm("Are you sure you want to download this monthly slip PDF again?")) { action(); } }
        });
        
        document.getElementById('settings-form').addEventListener('submit', (e) => { e.preventDefault(); const newSettings = { storeName: document.getElementById('setting-store-name').value, address: document.getElementById('setting-store-address').value, contact: document.getElementById('setting-contact-number').value, email: document.getElementById('setting-email').value, discountType: document.getElementById('setting-discount-type').value, printerType: document.getElementById('setting-printer-type').value, posViewType: document.getElementById('setting-pos-view').value, taxEnabled: document.getElementById('setting-tax-enabled').checked, taxRate: parseFloat(document.getElementById('setting-tax-rate').value) || 0, serviceChargeEnabled: document.getElementById('setting-service-charge-enabled').checked, serviceChargeRate: parseFloat(document.getElementById('setting-service-charge-rate').value) || 0 }; set(dbRefs.settings, newSettings).then(() => alert('Settings saved!')).catch(e => alert(e.message)); });
        
        document.getElementById('edit-category-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const categoryId = form['edit-category-id'].value;
            const originalCategory = state.productCategories.find(c => c.id === categoryId);
            const updatedData = {
                ...originalCategory,
                name: form['edit-category-name'].value,
                color: form['edit-category-color'].value
            };
            
            update(ref(database, `data/${currentUserUID}/masterData/productCategories/${categoryId}`), updatedData)
            .then(() => {
                document.getElementById('edit-category-modal').classList.remove('visible');
            })
            .catch(err => alert('Error updating category: ' + err.message));
        });


        function updatePurchaseTotals() { let total = 0; state.currentPurchaseItems.forEach(item => { total += (item.costPrice || 0) * (item.quantity || 0); }); document.getElementById('purchase-total-amount').textContent = formatCurrency(total); const paid = parseFloat(document.getElementById('purchase-amount-paid').value) || 0; const remaining = total - paid; document.getElementById('purchase-amount-remaining').textContent = formatCurrency(remaining); }
        
        function renderPurchaseItems() { 
            const container = document.getElementById('purchase-items-container'); 
            const datalist = document.getElementById('products-datalist'); 
            datalist.innerHTML = state.products.map(p => `<option value="${p.name}" data-id="${p.id}" data-cost="${p.costPrice || 0}"></option>`).join(''); 
            container.innerHTML = state.currentPurchaseItems.map((item, index) => {
                return `<div class="grid grid-cols-12 gap-2 items-center p-1 rounded"> 
                    <div class="col-span-5"><input type="text" list="products-datalist" class="input-field p-2 text-sm" placeholder="Select or type product" value="${item.name || ''}" onchange="app.updatePurchaseItem(${index}, 'name', this.value)"></div> 
                    <div class="col-span-2"><input type="number" class="input-field p-2 text-sm text-center" placeholder="Qty" value="${item.quantity || ''}" onchange="app.updatePurchaseItem(${index}, 'quantity', this.value)"></div> 
                    <div class="col-span-2"><input type="number" step="0.01" class="cost-input input-field p-2 text-sm text-right" placeholder="Cost" value="${item.costPrice || ''}" onchange="app.updatePurchaseItem(${index}, 'costPrice', this.value)"></div> 
                    <div class="col-span-3 flex justify-end items-center"> <span class="mr-3">${formatCurrency((item.quantity || 0) * (item.costPrice || 0))}</span> <button type="button" class="text-red-500 hover:text-red-400" onclick="app.removePurchaseItemRow(${index})"><i class="fas fa-trash-alt"></i></button> </div> 
                </div>`
            }).join(''); 
            updatePurchaseTotals(); 
        }

        document.getElementById('add-purchase-btn').addEventListener('click', () => { document.getElementById('purchase-modal-title').textContent = 'Add Supplier Purchase'; state.currentPurchaseItems = [{}]; state.editingPurchaseOriginalItems = []; document.getElementById('purchase-form').reset(); document.getElementById('editing-purchase-id').value = ''; renderPurchaseItems(); document.getElementById('purchase-modal').classList.add('visible'); const today = new Date().toISOString().split('T')[0]; document.getElementById('purchase-date').value = today; });
        document.getElementById('add-purchase-item-row').addEventListener('click', () => { state.currentPurchaseItems.push({}); renderPurchaseItems(); });
        document.getElementById('purchase-amount-paid').addEventListener('input', updatePurchaseTotals);
        
        document.getElementById('purchase-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.closest('.modal-content').querySelector('.btn-success');

            await handleButtonFeedback(submitBtn, 'Saving...', async () => {
                const invalidItems = state.currentPurchaseItems.filter(item => item.name && item.name.trim() !== '' && !item.productId);
                if (invalidItems.length > 0) {
                    const itemNames = invalidItems.map(i => i.name).join(', ');
                    alert(`The following product(s) do not exist in the system: ${itemNames}. Please add them to your products list before saving this purchase.`);
                    throw new Error("Invalid products in purchase list.");
                }

                const editingId = form['editing-purchase-id'].value;
                const updates = {};
                const allProductIds = new Set();
                
                state.currentPurchaseItems.forEach(item => item.productId && allProductIds.add(item.productId));
                (state.editingPurchaseOriginalItems || []).forEach(item => item.productId && allProductIds.add(item.productId));

                for (const productId of allProductIds) {
                    const originalItem = (state.editingPurchaseOriginalItems || []).find(o => o.productId === productId);
                    const currentItem = state.currentPurchaseItems.find(c => c.productId === productId);
                    const originalQty = originalItem ? originalItem.quantity : 0;
                    const currentQty = currentItem ? currentItem.quantity : 0;
                    const stockDiff = currentQty - originalQty;

                    if (stockDiff !== 0) {
                        const productStockRef = ref(database, `data/${currentUserUID}/products/${productId}/stock`);
                        await runTransaction(productStockRef, (currentStock) => (currentStock || 0) + stockDiff);
                    }
                    if (currentItem) {
                         updates[`data/${currentUserUID}/products/${productId}/costPrice`] = currentItem.costPrice;
                    }
                }

                const processedItems = state.currentPurchaseItems.filter(item => item.productId && item.quantity > 0 && item.costPrice >= 0);
                if (processedItems.length === 0) throw new Error("Please add at least one valid product.");

                const totalAmount = processedItems.reduce((sum, item) => sum + item.quantity * item.costPrice, 0);
                const amountPaid = parseFloat(document.getElementById('purchase-amount-paid').value) || 0;
                if (amountPaid > totalAmount) throw new Error("Amount paid cannot be greater than the total bill.");

                const purchaseId = editingId || 'PUR-' + Date.now();
                const purchaseData = {
                    id: purchaseId,
                    supplierName: document.getElementById('purchase-supplier-name').value,
                    contact: document.getElementById('purchase-supplier-contact').value,
                    date: document.getElementById('purchase-date').value,
                    totalAmount,
                    amountPaid,
                    items: processedItems
                };
                updates[`data/${currentUserUID}/purchases/${purchaseData.id}`] = purchaseData;
                
                await update(ref(database), updates);

                alert(`Purchase ${editingId ? 'updated' : 'saved'} successfully!`);
                document.getElementById('purchase-modal').classList.remove('visible');
                displayPurchaseInvoice(purchaseData, true);
            });
        });

        document.getElementById('open-new-product-submodal-btn').addEventListener('click', () => { document.getElementById('new-product-subform').reset(); populateProductCategorySelects('sub-'); populateGroupSelects('sub-'); document.getElementById('new-product-submodal').classList.add('visible'); });
        document.getElementById('new-product-subform').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const newProductKey = push(dbRefs.products).key; const newProductData = { id: newProductKey, name: form['sub-product-name'].value, genericName: form['sub-product-generic-name'].value || '', sellingPrice: parseFloat(form['sub-product-sell-price'].value), category: form['sub-product-category'].value, expiryDate: form['sub-product-expiry'].value, groupId: form['sub-product-group'].value, lowStockThreshold: parseInt(form['sub-product-low-stock'].value) || 10, batchNumber: form['sub-product-batch-number'].value, costPrice: 0, stock: 0 }; try { await set(ref(database, `data/${currentUserUID}/products/${newProductKey}`), newProductData); state.currentPurchaseItems.push({ productId: newProductKey, name: newProductData.name, quantity: 1, costPrice: 0 }); renderPurchaseItems(); alert('New product created. Now enter its quantity and cost in the list.'); document.getElementById('new-product-submodal').classList.remove('visible'); } catch (err) { alert('Error creating product: ' + err.message); } });
        function displayPurchaseInvoice(purchase, isFirstTime = false) { if (!purchase) return; const modal = document.getElementById('purchase-invoice-modal'); modal.dataset.isFirstTime = isFirstTime; modal.querySelector('#purchase-receipt-store-name').textContent = state.settings.storeName || 'My Store'; modal.querySelector('#purchase-receipt-store-address').textContent = state.settings.address || ''; modal.querySelector('#purchase-receipt-store-contact').textContent = state.settings.contact || ''; modal.querySelector('#purchase-receipt-store-email').textContent = state.settings.email || ''; modal.querySelector('#purchase-invoice-id').textContent = purchase.id; modal.querySelector('#purchase-invoice-supplier-name').textContent = purchase.supplierName; modal.querySelector('#purchase-invoice-date').textContent = new Date(purchase.date).toLocaleDateString(); modal.querySelector('#purchase-invoice-items').innerHTML = (purchase.items || []).map(item => `<tr><td class="text-left py-1">${item.name}</td><td class="text-center">${item.quantity}</td><td class="text-right">${formatCurrency(item.costPrice)}</td><td class="text-right">${formatCurrency(item.costPrice * item.quantity)}</td></tr>`).join(''); modal.querySelector('#purchase-invoice-total').textContent = formatCurrency(purchase.totalAmount); modal.querySelector('#purchase-invoice-paid').textContent = formatCurrency(purchase.amountPaid); modal.querySelector('#purchase-invoice-remaining').textContent = formatCurrency(purchase.totalAmount - purchase.amountPaid); modal.classList.add('visible'); }
        
        document.getElementById('add-customer-btn').addEventListener('click', () => { document.getElementById('customer-modal-title').textContent = 'Add New Customer'; document.getElementById('customer-form').reset(); document.getElementById('edit-customer-id').value = ''; document.getElementById('customer-modal').classList.add('visible'); });
        document.getElementById('customer-form').addEventListener('submit', (e) => { e.preventDefault(); const form = e.target; const customerId = form['edit-customer-id'].value || push(dbRefs.customers).key; const existingCustomer = state.customers.find(c => c.id === customerId); const customerData = { id: customerId, name: form['customer-name-input'].value, phone: form['customer-phone-input'].value, cnic: form['customer-cnic-input'].value, address: form['customer-address-input'].value, payments: existingCustomer?.payments || {} }; set(ref(database, `data/${currentUserUID}/customers/${customerId}`), customerData).then(() => { document.getElementById('customer-modal').classList.remove('visible'); }).catch(err => alert('Error: ' + err.message)); });
        document.getElementById('settle-credit-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const customerId = form['settle-customer-id'].value; const amountPaid = parseFloat(form['settle-amount-paid'].value); const ledger = getCustomerLedger(customerId); if(isNaN(amountPaid) || amountPaid <= 0) { alert("Please enter a valid amount."); return; } if(amountPaid > ledger.balance + 0.01) { alert("Paid amount cannot be more than the due amount."); return; } const customerPaymentsRef = ref(database, `data/${currentUserUID}/customers/${customerId}/payments`); const newPaymentRef = push(customerPaymentsRef); try { await set(newPaymentRef, { id: newPaymentRef.key, amount: amountPaid, date: new Date().toISOString() }); alert("Payment saved successfully!"); document.getElementById('settle-credit-modal').classList.remove('visible'); } catch(err) { alert('Error saving payment: ' + err.message); }});
        
        document.getElementById('add-expense-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            handleButtonFeedback(submitBtn, 'Adding...', async () => {
                const categorySelect = form['expense-category-select'];
                const categoryId = categorySelect.value;
                if (!categoryId) throw new Error('Please select an expense category.');
                const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
                const newExpenseKey = push(dbRefs.expenses).key;
                const expenseData = { id: newExpenseKey, categoryId, categoryName, description: form['expense-description'].value, amount: parseFloat(form['expense-amount'].value), date: new Date().toISOString() };
                await set(ref(database, `data/${currentUserUID}/expenses/${newExpenseKey}`), expenseData);
                form.reset();
            });
        });

        document.getElementById('add-staff-btn').addEventListener('click', () => { document.getElementById('staff-modal-title').textContent = 'Add New Staff Member'; document.getElementById('staff-form').reset(); document.getElementById('edit-staff-id').value = ''; const today = new Date().toISOString().split('T')[0]; document.getElementById('staff-joining-date-input').value = today; document.getElementById('staff-modal').classList.add('visible'); });
        document.getElementById('show-staff-history-btn').addEventListener('click', () => window.app.showAllStaffTransactions());
        document.getElementById('staff-form').addEventListener('submit', (e) => { e.preventDefault(); const form = e.target; const staffId = form['edit-staff-id'].value || push(dbRefs.staff).key; const existingStaff = state.staff.find(s => s.id === staffId); const staffData = { id: staffId, name: form['staff-name-input'].value, phone: form['staff-phone-input'].value, role: form['staff-role-input'].value, salary: parseFloat(form['staff-salary-input'].value), joiningDate: form['staff-joining-date-input'].value, ledger: existingStaff ? existingStaff.ledger : {} }; set(ref(database, `data/${currentUserUID}/staff/${staffId}`), staffData).then(() => { document.getElementById('staff-modal').classList.remove('visible'); }).catch(err => alert('Error: ' + err.message)); });
        document.getElementById('staff-ledger-entry-form').addEventListener('submit', (e) => { e.preventDefault(); const form = e.target; const staffId = form['ledger-staff-id'].value; if(!staffId) return; const entryType = form['staff-entry-type'].value; const amount = parseFloat(form['staff-entry-amount'].value); const notes = form['staff-entry-notes'].value; if(isNaN(amount) || amount <= 0) { alert('Please enter a valid amount.'); return; } const ledgerEntryRef = push(ref(database, `data/${currentUserUID}/staff/${staffId}/ledger`)); const entryData = { id: ledgerEntryRef.key, type: entryType, amount, notes, date: new Date().toISOString() }; set(ledgerEntryRef, entryData).then(() => { const staff = state.staff.find(s => s.id === staffId); window.app.showStaffReceipt(staff, entryData, `${entryType} Receipt`, true); window.app.showStaffLedger(staffId); form.reset(); }).catch(err => { alert('Error adding ledger entry: ' + err.message); }); });
        
        document.getElementById('add-group-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            handleButtonFeedback(submitBtn, 'Adding...', async () => {
                const name = form['group-name'].value.trim();
                if (!name) throw new Error("Group name cannot be empty.");
                const newKey = push(dbRefs.groups).key;
                await set(ref(database, `data/${currentUserUID}/masterData/groups/${newKey}`), { id: newKey, name });
                form.reset();
            });
        });
document.getElementById('add-product-category-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            handleButtonFeedback(submitBtn, 'Adding...', async () => {
                const name = form['product-category-name'].value.trim();
                if (!name) throw new Error("Category name cannot be empty.");
                const color = form['product-category-color'].value;
                const newKey = push(dbRefs.productCategories).key;
                await set(ref(database, `data/${currentUserUID}/masterData/productCategories/${newKey}`), { id: newKey, name, color });
                form.reset();
            });
        });
        document.getElementById('add-expense-category-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            handleButtonFeedback(submitBtn, 'Adding...', async () => {
                const name = form['expense-category-name'].value.trim();
                if (!name) throw new Error("Category name cannot be empty.");
                const newKey = push(dbRefs.expenseCategories).key;
                await set(ref(database, `data/${currentUserUID}/masterData/expenseCategories/${newKey}`), { id: newKey, name });
                form.reset();
            });
        });

        document.getElementById('cancel-sale-btn').addEventListener('click', () => { if(confirm('Are you sure you want to cancel this sale?')) resetPOS(); });
        document.getElementById('hold-sale-btn').addEventListener('click', () => { if(state.cart.length === 0) { alert('Cart is empty.'); return; } const billToHold = { id: 'HB-' + Date.now(), cart: state.cart, customerName: document.getElementById('pos-customer-input').value, discountValue: document.getElementById('cart-discount-value').value, heldAt: new Date().toISOString() }; set(ref(database, `data/${currentUserUID}/holdBills/${billToHold.id}`), billToHold).then(() => { alert('Bill held successfully.'); resetPOS(); }); });
        document.getElementById('credit-sale-btn').addEventListener('click', () => { if(state.cart.length === 0) { alert('Cart is empty.'); return; } const listEl = document.getElementById('credit-customer-list'); listEl.innerHTML = state.customers.map(c => `<div class="p-3 rounded-md hover:bg-blue-600 cursor-pointer" style="background-color: var(--bg-modal-darker);" onclick="app.chargeToAccount('${c.id}')"><p class="font-bold">${c.name}</p><p class="text-sm" style="color: var(--text-secondary);">${c.cnic || 'No CNIC'}</p></div>`).join('') || '<p class="text-center">No customers found. Add one from the Customers page.</p>'; document.getElementById('credit-customer-select-modal').classList.add('visible'); });
        
window.app.chargeToAccount = (customerId) => { document.getElementById('credit-customer-select-modal').classList.remove('visible'); handleSale(true, customerId); }

        async function handleSale(isCredit, customerId = null) {
            if (state.cart.length === 0) { alert('Cart is empty.'); return; }
            const saleBtn = document.getElementById('complete-sale-btn'); const creditBtn = document.getElementById('credit-sale-btn');
            const originalSaleText = saleBtn.innerHTML; const originalCreditText = creditBtn.innerHTML;
            try {
                saleBtn.disabled = true; creditBtn.disabled = true;
                const loadingSpinner = `<i class="fas fa-spinner fa-spin mr-2"></i>`;
                saleBtn.innerHTML = `${loadingSpinner}Processing...`; creditBtn.innerHTML = `${loadingSpinner}Processing...`;
                
                const customer = isCredit ? state.customers.find(c => c.id === customerId) : null;
                const customerName = isCredit ? (customer ? customer.name : 'Unknown Account') : (document.getElementById('pos-customer-input').value.trim() || 'Walk-in Customer');

                const subtotal = state.cart.reduce((s, i) => s + (i.sellingPrice || 0) * i.quantity, 0);
                const discountValue = parseFloat(document.getElementById('cart-discount-value').value) || 0;
                let calculatedDiscount = (state.settings.discountType === 'percent') ? (subtotal * discountValue) / 100 : discountValue;
                
                let taxAmount = 0;
                if (state.settings.taxEnabled && state.settings.taxRate > 0) {
                    taxAmount = subtotal * (state.settings.taxRate / 100);
                }
                
                let serviceChargeAmount = 0;
                if (state.settings.serviceChargeEnabled && state.settings.serviceChargeRate > 0) {
                    serviceChargeAmount = subtotal * (state.settings.serviceChargeRate / 100);
                }

                const total = subtotal - calculatedDiscount + taxAmount + serviceChargeAmount;
                const profit = state.cart.reduce((s, i) => s + ((i.sellingPrice || 0) - (i.costPrice || 0)) * i.quantity, 0) - calculatedDiscount;
                const saleId = 'INV-' + Date.now();
                const saleStatus = isCredit ? 'Credit' : 'Completed';
                
                const sale = { id: saleId, date: new Date().toISOString(), customerName, customerId: isCredit ? customerId : null, items: state.cart.map(i => ({...i})), subtotal, discount: calculatedDiscount, total, profit, status: saleStatus, taxAmount, serviceChargeAmount };
                
                await set(ref(database, `data/${currentUserUID}/sales/${sale.id}`), sale);
                for(const item of sale.items) { const productStockRef = ref(database, `data/${currentUserUID}/products/${item.id}/stock`); await runTransaction(productStockRef, (currentStock) => (currentStock || 0) - item.quantity); };
                                
                if (isCredit) { alert('Sale charged to account successfully!'); resetPOS(); } else { onInvoiceCloseCallback = resetPOS; displayInvoice(sale, true); }
            } catch (err) { alert('Error: ' + err.message); console.error(err); } finally { saleBtn.disabled = false; creditBtn.disabled = false; saleBtn.innerHTML = originalSaleText; creditBtn.innerHTML = originalCreditText; }
        }
        document.getElementById('complete-sale-btn').addEventListener('click', () => handleSale(false));
        
        document.getElementById('show-add-product-modal-btn').addEventListener('click', () => {
            const modal = document.getElementById('add-product-modal');
            const form = modal.querySelector('form');
            form.reset();
            populateProductCategorySelects('add-');
            populateGroupSelects('add-');
            const newProductKey = push(dbRefs.products).key;
            form.querySelector('#add-product-new-id').value = newProductKey;
            modal.classList.add('visible');
        });
        
        document.getElementById('add-generate-barcode-btn').addEventListener('click', (e) => {
            const tempId = document.getElementById('add-product-new-id').value;
            document.getElementById('add-product-barcode').value = tempId;
        });

        document.getElementById('edit-generate-barcode-btn').addEventListener('click', (e) => {
            const productId = document.getElementById('edit-product-id').value;
            document.getElementById('edit-product-barcode').value = productId;
        });

document.getElementById('add-product-form').addEventListener('submit', async e => {
            e.preventDefault();
            const form = e.target;
            const newProductKey = form.querySelector('#add-product-new-id').value || push(dbRefs.products).key;
            const imageFile = form['add-product-image'].files[0];
            const imageUrl = form['add-product-image-url'].value.trim();
            if (imageFile) { alert("Image upload is not supported in this version. Please use an Image URL."); return; }
            
            let barcode = form['add-product-barcode'].value.trim();
            if (!barcode) { barcode = newProductKey; } 
            
            const newProduct = { id: newProductKey, name: form['add-product-name'].value, genericName: form['add-product-generic-name'].value || '', batchNumber: form['add-product-batch-number'].value, barcode: barcode, category: form['add-product-category'].value, groupId: form['add-product-group'].value, costPrice: parseFloat(form['add-product-cost-price'].value), sellingPrice: parseFloat(form['add-product-sell-price'].value), stock: parseInt(form['add-product-stock'].value), lowStockThreshold: parseInt(form['add-product-low-stock'].value) || 10, expiryDate: form['add-product-expiry'].value, imageUrl: imageUrl || null };
            set(ref(database, `data/${currentUserUID}/products/${newProductKey}`), newProduct).then(() => {
                form.reset();
                document.getElementById('add-product-modal').classList.remove('visible');
            }).catch(e => alert('Error: ' + e.message));
        });

document.getElementById('edit-product-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const productId = form.querySelector('#edit-product-id').value; const imageFile = form['edit-product-image'].files[0]; const imageUrl = form['edit-product-image-url'].value.trim(); if (imageFile) { alert("Image upload is not supported in this version. Please use an Image URL."); return; } let barcode = form['edit-product-barcode'].value.trim(); if (!barcode) { barcode = productId; } const updatedData = { name: form['edit-product-name'].value, genericName: form['edit-product-generic-name'].value || '', batchNumber: form['edit-product-batch-number'].value, barcode: barcode, category: form['edit-product-category'].value, groupId: form['edit-product-group'].value, costPrice: parseFloat(form['edit-product-cost-price'].value), sellingPrice: parseFloat(form['edit-product-sell-price'].value), stock: parseInt(form['edit-product-stock'].value), lowStockThreshold: parseInt(form['edit-product-low-stock'].value) || 10, expiryDate: form['edit-product-expiry'].value, imageUrl: imageUrl || null }; update(ref(database, `data/${currentUserUID}/products/${productId}`), updatedData).then(() => { document.getElementById('edit-product-modal').classList.remove('visible'); }).catch(e => alert('Error: ' + e.message)); });
        document.getElementById('return-sale-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const saleId = form.dataset.saleId; const saleRef = ref(database, `data/${currentUserUID}/sales/${saleId}`); const itemsToReturn = Array.from(form.querySelectorAll('input[type="number"]')).map(input => ({ id: input.dataset.itemId, qty: parseInt(input.value, 10) })).filter(item => item.qty > 0); if (itemsToReturn.length === 0) { alert('Please enter a quantity to return.'); return; } try { await runTransaction(saleRef, (sale) => { if (sale) { let totalReturnAmount = 0; let totalReturnProfit = 0; itemsToReturn.forEach(returnItem => { const saleItem = sale.items.find(i => i.id === returnItem.id); if (saleItem) { const returnedQty = saleItem.returnedQty || 0; if (returnItem.qty > 0 && returnItem.qty <= (saleItem.quantity - returnedQty)) { saleItem.returnedQty = returnedQty + returnItem.qty; totalReturnAmount += returnItem.qty * saleItem.sellingPrice; totalReturnProfit += returnItem.qty * (saleItem.sellingPrice - saleItem.costPrice); const productRef = ref(database, `data/${currentUserUID}/products/${saleItem.id}/stock`); runTransaction(productRef, (currentStock) => (currentStock || 0) + returnItem.qty); } } }); sale.total -= totalReturnAmount; sale.profit -= totalReturnProfit; const allItemsReturned = sale.items.every(item => (item.returnedQty || 0) === item.quantity); sale.status = allItemsReturned ? 'Returned' : 'Partially Returned'; } return sale; }); alert('Return processed successfully!'); document.getElementById('return-sale-modal').classList.remove('visible'); } catch (error) { console.error("Return failed: ", error); alert("An error occurred during the return process."); }});
        document.getElementById('settle-credit-modal').querySelector('#settle-amount-paid').addEventListener('input', (e) => { const due = parseFloat(document.getElementById('settle-amount-due').textContent.replace('Rs','')); const paid = parseFloat(e.target.value) || 0; document.getElementById('settle-amount-remaining').textContent = formatCurrency(Math.max(0, due - paid)); });
        
        async function startScanner(targetInputId) {
            currentScannerTargetInput = document.getElementById(targetInputId);
            if (!currentScannerTargetInput) {
                console.error("Scanner target input not found:", targetInputId);
                return;
            }

            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
            } catch(err) {
                alert("Camera permission is required to use the scanner. Please allow camera access in your browser settings.");
                console.error("Camera permission denied.", err);
                return;
            }

            document.getElementById('barcode-scanner-modal').classList.add('visible');
            html5QrCode = new Html5Qrcode("reader");
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                if (decodedText) {
                    currentScannerTargetInput.value = decodedText;
                    closeScanner();
                }
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback).catch(err => {
                console.error("Failed to start scanner", err);
                alert("Could not start camera scanner. Ensure your camera is not being used by another application.");
                closeScanner();
            });
        }

        function closeScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner cleanly", err));
            }
            html5QrCode = null;
            document.getElementById('barcode-scanner-modal').classList.remove('visible');
        }

        document.querySelectorAll('.scan-barcode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetInputId = e.currentTarget.dataset.targetInput;
                startScanner(targetInputId);
            });
        });
        document.getElementById('close-scanner-btn').addEventListener('click', closeScanner);

        function attachListener(dbRef, callback) {
            const listener = onValue(dbRef, callback);
            activeListeners.push({ ref: dbRef, listener: listener });
        }

        // Initialize listeners
        attachListener(dbRefs.products, (snap) => { state.products = snap.exists() ? Object.values(snap.val()) : []; updateAllPages(); });
        attachListener(dbRefs.sales, (snap) => { const salesData = snap.exists() ? Object.values(snap.val()) : []; state.sales = salesData; const newSalesCounts = {}; salesData.forEach(sale => { if (sale.status !== 'Returned' && sale.items) { sale.items.forEach(item => { const soldQty = item.quantity - (item.returnedQty || 0); if (soldQty > 0) { newSalesCounts[item.id] = (newSalesCounts[item.id] || 0) + soldQty; } }); } }); state.salesCounts = newSalesCounts; updateAllPages(); });
        attachListener(dbRefs.customers, (snap) => { state.customers = snap.exists() ? Object.values(snap.val()) : []; updateAllPages(); });
        attachListener(dbRefs.purchases, (snap) => { state.purchases = snap.exists() ? Object.values(snap.val()) : []; updateAllPages(); });
        attachListener(dbRefs.settings, (snap) => { const defaultSettings = { posViewType: 'card', printerType: 'thermal', discountType: 'amount', taxEnabled: false, taxRate: 0, serviceChargeEnabled: false, serviceChargeRate: 0 }; state.settings = snap.exists() ? { ...defaultSettings, ...snap.val() } : defaultSettings; document.getElementById('setting-store-name').value = state.settings.storeName || ''; document.getElementById('setting-store-address').value = state.settings.address || ''; document.getElementById('setting-contact-number').value = state.settings.contact || ''; document.getElementById('setting-email').value = state.settings.email || ''; document.getElementById('setting-discount-type').value = state.settings.discountType; document.getElementById('setting-printer-type').value = state.settings.printerType; document.getElementById('setting-pos-view').value = state.settings.posViewType; document.getElementById('setting-tax-enabled').checked = state.settings.taxEnabled; document.getElementById('setting-tax-rate').value = state.settings.taxRate; document.getElementById('setting-tax-rate').disabled = !state.settings.taxEnabled; document.getElementById('setting-service-charge-enabled').checked = state.settings.serviceChargeEnabled; document.getElementById('setting-service-charge-rate').value = state.settings.serviceChargeRate; document.getElementById('setting-service-charge-rate').disabled = !state.settings.serviceChargeEnabled; updateCartTotals(); });
        attachListener(dbRefs.holdBills, (snap) => { state.holdBills = snap.exists() ? Object.values(snap.val()) : []; updateAllPages(); });
        attachListener(dbRefs.expenses, (snap) => { state.expenses = snap.exists() ? Object.values(snap.val()) : []; updateAllPages(); });
        attachListener(dbRefs.staff, (snap) => { state.staff = snap.exists() ? Object.values(snap.val()) : []; updateAllPages(); });
        attachListener(dbRefs.groups, (snap) => { state.groups = snap.exists() ? Object.values(snap.val()) : []; populateGroupSelects('add-'); populateGroupSelects('edit-'); populateGroupSelects('sub-'); updateAllPages(); });
        
        attachListener(dbRefs.productCategories, (snap) => {
            if (!snap.exists()) {
                // First time setup for a new user
                const defaultCategories = [
                    { name: 'Tablets', color: '#FDBA74' }, { name: 'Syrups', color: '#93C5FD' },
                    { name: 'Injections', color: '#FCA5A5' }, { name: 'Ointments', color: '#D8B4FE' },
                    { name: 'Drops', color: '#67E8F9' }, { name: 'Surgical', color: '#A3A3A3' },
                    { name: 'General', color: '#BEF264' }
                ];
                const updates = {};
                defaultCategories.forEach(cat => {
                    const newKey = push(dbRefs.productCategories).key;
                    updates[newKey] = { id: newKey, ...cat };
                });
                update(ref(database, `data/${currentUserUID}/masterData/productCategories`), updates);
            } else {
                state.productCategories = Object.values(snap.val());
                populateProductCategorySelects('add-');
                populateProductCategorySelects('sub-');
                populateProductCategorySelects('edit-');
                updateAllPages();
            }
        });

        attachListener(dbRefs.expenseCategories, (snap) => { state.expenseCategories = snap.exists() ? Object.values(snap.val()) : []; populateExpenseCategorySelect(); updateAllPages(); });
        
        document.getElementById('setting-tax-enabled').addEventListener('change', (e) => { document.getElementById('setting-tax-rate').disabled = !e.target.checked; });
        document.getElementById('setting-service-charge-enabled').addEventListener('change', (e) => { document.getElementById('setting-service-charge-rate').disabled = !e.target.checked; });

        showPage('dashboard');
    }
});
</script>
</body>
</html>
