<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedicoPOS - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .main-container { max-width: 1800px; margin: 0 auto; padding: 1rem; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.5px; border: none; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .input-field { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid #d1d5db; border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        .tab-button { padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; color: #374151; }
        .tab-button.active { color: #1d4ed8; border-bottom-color: #2563eb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .report-sub-tab-btn { padding: 0.5rem 1rem; font-weight: 500; cursor: pointer; border-radius: 6px; border: 1px solid #d1d5db; }
        .report-sub-tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .report-sub-content { display: none; }
        .report-sub-content.active { display: block; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            main, header { display: none !important; }
            body > .modal-overlay {
                visibility: visible; background: none; display: block; position: absolute; top: 0; left: 0;
            }
            .modal-content-for-print {
                visibility: visible; box-shadow: none; display: block; position: absolute; top: 0; left: 0; width: 100%;
            }
        }
    </style>
</head>
<body>

    <header class="main-container no-print">
        <div class="flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-4xl font-bold text-gray-800"><i class="fas fa-pills text-blue-600"></i> MedicoPOS</h1>
            <nav class="flex mt-4 sm:mt-0 border-b">
                <button class="tab-button" onclick="showTab('pos')"><i class="fas fa-cash-register mr-2"></i>POS</button>
                <button class="tab-button" onclick="showTab('dashboard')"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</button>
                <button class="tab-button" onclick="showTab('products')"><i class="fas fa-box-open mr-2"></i>Products</button>
                <button class="tab-button" onclick="showTab('reports')"><i class="fas fa-chart-pie mr-2"></i>Sales Report</button>
            </nav>
        </div>
    </header>

    <main class="main-container no-print">
        <!-- POS Tab -->
        <div id="pos" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-8 card">
                    <input type="text" id="product-search" placeholder="Search products or scan ID..." class="input-field w-full mb-4">
                    <div id="product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 max-h-[70vh] overflow-y-auto p-1"></div>
                </div>
                <div class="lg:col-span-4 card flex flex-col">
                    <h2 class="text-2xl font-bold mb-4">Current Sale</h2>
                    <div id="cart-items" class="space-y-3 mb-4 min-h-[35vh] flex-grow max-h-[50vh] overflow-y-auto pr-2"></div>
                    <div class="border-t pt-4 space-y-3">
                        <div class="flex justify-between font-medium"><span>Subtotal</span><span id="cart-subtotal">₨0.00</span></div>
                        <div class="flex justify-between font-medium text-xl"><span>Total</span><span id="cart-total" class="font-bold">₨0.00</span></div>
                        <div class="mt-4">
                            <label for="customer-name" class="font-medium">Customer Name (Optional)</label>
                            <input type="text" id="customer-name" placeholder="Enter customer name" class="input-field mt-1">
                        </div>
                    </div>
                    <button id="complete-sale-btn" class="btn btn-success w-full mt-4 text-lg"><i class="fas fa-check-circle mr-2"></i>Finalize Sale</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-5"><h3 class="text-gray-500">Total Products</h3><p id="total-products" class="text-3xl font-bold">0</p></div>
                <div class="card p-5"><h3 class="text-gray-500">Stock Value (Cost)</h3><p id="total-stock-value" class="text-3xl font-bold">₨0.00</p></div>
                <div class="card p-5"><h3 class="text-gray-500">Stock Value (Selling)</h3><p id="total-stock-value-selling" class="text-3xl font-bold">₨0.00</p></div>
                <div class="card p-5"><h3 class="text-gray-500">Total Profit (All Time)</h3><p id="total-profit" class="text-3xl font-bold">₨0.00</p></div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <div class="lg:col-span-1 card"><h3 class="text-xl font-semibold mb-4">Top Selling Products</h3><div id="top-selling-products" class="space-y-3"></div></div>
                <div class="lg:col-span-1 card"><h3 class="text-xl font-semibold mb-4 text-orange-600">Expiry Warnings (Next 90 Days)</h3><div id="expiry-warnings" class="space-y-2"></div></div>
                <div class="lg:col-span-1 card"><h3 class="text-xl font-semibold mb-4 text-red-600">Expired Stock</h3><div id="expired-products-list" class="space-y-2"></div></div>
             </div>
             <div class="grid grid-cols-1 lg:grid-cols-1 gap-6 mt-6">
                 <div class="lg:col-span-1 card"><h3 class="text-xl font-semibold mb-4 text-red-600">Low Stock Alerts (<= 10)</h3><div id="low-stock-alerts" class="space-y-2"></div></div>
             </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content">
            <div class="card">
                <h2 class="text-2xl font-bold mb-4">Product Management</h2>
                <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                    <input type="hidden" id="product-id">
                    <div><label class="font-medium">Product Name</label><input type="text" id="product-name" class="input-field" required></div>
                    <div><label class="font-medium">Category</label><input type="text" id="product-category" placeholder="e.g., Painkiller" class="input-field" required></div>
                    <div><label class="font-medium">Cost Price (Buy Price)</label><input type="number" id="cost-price" class="input-field" required min="0" step="0.01"></div>
                    <div><label class="font-medium">Selling Price</label><input type="number" id="selling-price" class="input-field" required min="0" step="0.01"></div>
                    <div><label class="font-medium">Stock Quantity</label><input type="number" id="stock-quantity" class="input-field" required min="0"></div>
                    <div><label class="font-medium">Expiry Date</label><input type="date" id="expiry-date" class="input-field" required></div>
                    <div class="md:col-span-3 flex gap-4"><button type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Save Product</button><button type="button" id="clear-form-btn" class="btn bg-gray-600 text-white hover:bg-gray-700">Cancel</button></div>
                </form>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-100"><th class="p-3">Name</th><th>Category</th><th>Cost Price</th><th>Sell Price</th><th>Stock</th><th>Expiry</th><th>Actions</th></tr></thead><tbody id="products-table-body"></tbody></table></div>
            </div>
        </div>

        <!-- Sales Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 no-print">
                    <h2 class="text-2xl font-bold">Sales Report</h2>
                    <div class="flex items-center gap-4 mt-4 sm:mt-0">
                        <div>
                            <label for="report-start-date" class="text-sm font-medium">Start Date</label>
                            <input type="date" id="report-start-date" class="input-field w-auto">
                        </div>
                        <div>
                            <label for="report-end-date" class="text-sm font-medium">End Date</label>
                            <input type="date" id="report-end-date" class="input-field w-auto">
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 border-b mb-4 no-print">
                    <button id="summary-report-btn" class="report-sub-tab-btn" onclick="showReportSubTab('summary')">Summary</button>
                    <button id="bills-report-btn" class="report-sub-tab-btn" onclick="showReportSubTab('bills')">Bills</button>
                </div>

                <!-- Summary View -->
                <div id="summary-report-content" class="report-sub-content">
                    <div class="flex justify-end no-print mb-4">
                        <button id="download-summary-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download Summary</button>
                    </div>
                    <div id="report-print-area" class="p-4 border rounded-lg">
                        <div class="text-center mb-6"><h2 class="text-3xl font-bold">Medico Health Store</h2><p>Sales Report</p></div>
                        <h3 class="text-xl font-semibold text-center mb-4">Report for: <span id="report-date-display"></span></h3>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-100 p-4 rounded-lg text-center"><p class="text-blue-800 font-semibold">Total Sales</p><p id="report-total-sales" class="text-2xl font-bold text-blue-900">₨0.00</p></div>
                            <div class="bg-green-100 p-4 rounded-lg text-center"><p class="text-green-800 font-semibold">Total Profit</p><p id="report-total-profit" class="text-2xl font-bold text-green-900">₨0.00</p></div>
                        </div>
                        <h4 class="font-semibold mb-2 text-lg">Transactions Summary:</h4>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-2">Invoice ID</th><th>Time</th><th>Customer</th><th>Items</th><th class="text-right">Total</th></tr></thead><tbody id="report-transactions-table"></tbody></table></div>
                    </div>
                </div>

                <!-- Bills View -->
                <div id="bills-report-content" class="report-sub-content">
                    <h4 class="font-semibold mb-2 text-lg no-print">All Bills for: <span id="bills-date-display"></span></h4>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-100"><th class="p-3">Invoice ID</th><th>Customer</th><th>Time</th><th class="text-right">Total</th><th class="text-center">Actions</th></tr></thead><tbody id="daily-bills-table"></tbody></table></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal-overlay hidden no-print">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full modal-content-for-print">
            <div id="invoice-print-area" class="p-8">
                <div class="text-center mb-8">
                    <div style="font-size: 50px; color: #2563eb;"><i class="fas fa-clinic-medical"></i></div>
                    <h2 class="text-3xl font-bold mt-2">Medico Health Store</h2><p class="text-gray-500">Your Trusted Pharmacy</p>
                </div>
                <div class="flex justify-between mb-4 text-sm">
                    <div>
                        <p><strong>Invoice ID:</strong> <span id="invoice-id"></span></p>
                        <p><strong>Customer:</strong> <span id="invoice-customer-name"></span></p>
                    </div>
                    <div><p><strong>Date:</strong> <span id="invoice-date"></span></p></div>
                </div>
                <table class="w-full mb-8">
                    <thead><tr class="border-b-2 border-gray-500"><th class="text-left py-2">ITEM</th><th class="text-center">QTY</th><th class="text-right">PRICE</th><th class="text-right">TOTAL</th></tr></thead>
                    <tbody id="invoice-items" class="divide-y"></tbody>
                </table>
                <div class="flex justify-end"><div class="w-full sm:w-1/2"><div class="flex justify-between text-lg"><span class="text-gray-600">Subtotal:</span><span id="invoice-subtotal"></span></div><div class="flex justify-between font-bold text-2xl mt-2 border-t pt-2"><span class="">Grand Total:</span><span id="invoice-total"></span></div></div></div>
                <p class="text-center text-gray-500 mt-10 text-xs">Thank you for your business!</p>
            </div>
            <div class="invoice-buttons flex justify-end gap-3 p-5 bg-gray-100 rounded-b-lg no-print">
                <button id="print-invoice-btn" class="btn bg-gray-600 text-white"><i class="fas fa-print mr-2"></i>Print</button>
                <button id="download-invoice-btn" class="btn btn-primary"><i class="fas fa-file-pdf mr-2"></i>Download PDF</button>
                <button id="close-invoice-btn" class="btn btn-danger"><i class="fas fa-times mr-2"></i>Close</button>
            </div>
        </div>
    </div>

<script type="module">
  // Import Firebase functions
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBdm5Ot1bjCq6Ytrul9L2UQo61oSmSeaa0",
    authDomain: "student-program-e6ed4.firebaseapp.com",
    databaseURL: "https://student-program-e6ed4-default-rtdb.firebaseio.com",
    projectId: "student-program-e6ed4",
    storageBucket: "student-program-e6ed4.firebasestorage.app",
    messagingSenderId: "466600750135",
    appId: "1:466600750135:web:a5f034144278156ef0a3b2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  // Database references
  const productsRef = ref(database, 'products');
  const salesRef = ref(database, 'sales');

document.addEventListener('DOMContentLoaded', () => {
    // --- LOCAL STATE (Cache for Firebase data) ---
    let state = {
        products: [],
        sales: [],
        cart: [],
        editingProductId: null,
    };

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => `₨${(parseFloat(amount) || 0).toFixed(2)}`;
    const toISODateString = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split("T")[0];

    // --- TAB MANAGEMENT ---
    window.showTab = (tabName) => {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`.tab-button[onclick*="'${tabName}'"]`).classList.add('active');
        
        const tabActions = {
            'dashboard': updateDashboard,
            'pos': () => { renderPosProducts(); document.getElementById('product-search').focus(); },
            'products': renderProductsTable,
            'reports': () => { renderSalesReport(); showReportSubTab('summary'); }
        };
        if (tabActions[tabName]) tabActions[tabName]();
    };
    
    // --- PRODUCT MANAGEMENT ---
    const renderProductsTable = () => {
        const tableBody = document.getElementById('products-table-body');
        tableBody.innerHTML = state.products.map(p => 
            `<tr class="border-b hover:bg-gray-50"><td class="p-3">${p.name}</td><td>${p.category}</td><td>${formatCurrency(p.costPrice)}</td><td>${formatCurrency(p.sellingPrice)}</td><td>${p.stock}</td><td>${p.expiryDate}</td><td><button class="text-blue-600 mr-2" onclick="editProduct('${p.id}')"><i class="fas fa-edit"></i></button><button class="text-red-600" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`
        ).join('');
    };

    document.getElementById('product-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const productData = {
            name: document.getElementById('product-name').value.trim(), category: document.getElementById('product-category').value.trim(),
            costPrice: parseFloat(document.getElementById('cost-price').value), sellingPrice: parseFloat(document.getElementById('selling-price').value),
            stock: parseInt(document.getElementById('stock-quantity').value), expiryDate: document.getElementById('expiry-date').value
        };

        if (state.editingProductId) {
            update(ref(database, `products/${state.editingProductId}`), productData);
        } else {
            const newProductRef = push(productsRef);
            set(newProductRef, { ...productData, id: newProductRef.key });
        }
        resetProductForm();
    });

    window.editProduct = (id) => {
        const p = state.products.find(p => p.id === id);
        if (!p) return;
        state.editingProductId = id;
        document.getElementById('product-id').value = p.id;
        document.getElementById('product-name').value = p.name;
        document.getElementById('product-category').value = p.category;
        document.getElementById('cost-price').value = p.costPrice;
        document.getElementById('selling-price').value = p.sellingPrice;
        document.getElementById('stock-quantity').value = p.stock;
        document.getElementById('expiry-date').value = p.expiryDate;
        document.querySelector('#product-form button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Update Product';
    };
    const resetProductForm = () => {
        document.getElementById('product-form').reset();
        state.editingProductId = null;
        document.querySelector('#product-form button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Save Product';
    };
    document.getElementById('clear-form-btn').addEventListener('click', resetProductForm);
    window.deleteProduct = (id) => { if (confirm('Are you sure?')) remove(ref(database, `products/${id}`)); };

    // --- POS & CART ---
    const renderPosProducts = () => {
        const listEl = document.getElementById('product-list');
        const search = document.getElementById('product-search').value.toLowerCase();
        const filtered = state.products.filter(p => (p.name.toLowerCase().includes(search) || (p.id || '').toString().toLowerCase().includes(search)));
        
        listEl.innerHTML = filtered.length === 0 ? `<p class="col-span-full text-center p-4 text-gray-500">No products found.</p>` :
            filtered.map(p => {
                const cartItem = state.cart.find(item => item.id === p.id);
                const availableStock = p.stock - (cartItem ? cartItem.quantity : 0);
                const stockClass = availableStock <= 0 ? 'text-gray-400' : (availableStock <= 10 ? 'text-red-600' : 'text-green-600');
                const isExpired = new Date(p.expiryDate) < new Date();
                return `<div class="p-2 border rounded-lg text-center cursor-pointer transition-all hover:shadow-lg hover:border-blue-500 ${(availableStock <= 0 || isExpired) ? 'opacity-50 cursor-not-allowed' : ''}" ${(availableStock > 0 && !isExpired) ? `onclick="addToCart('${p.id}')"` : ''}>
                            <h4 class="font-semibold text-sm truncate">${p.name}</h4>
                            <p class="text-xs text-gray-500">${formatCurrency(p.sellingPrice)}</p>
                            <p class="text-xs font-medium mt-1 ${stockClass}">Stock: ${availableStock}</p>
                            ${isExpired ? '<p class="text-xs font-bold text-red-500">EXPIRED</p>' : ''}
                        </div>`;
            }).join('');
    };
    window.addToCart = (id) => {
        const product = state.products.find(p => p.id === id);
        const cartItem = state.cart.find(item => item.id === id);
        const availableStock = product.stock - (cartItem ? cartItem.quantity : 0);
        if (availableStock <= 0) { alert('Product is out of stock.'); return; }
        if (cartItem) cartItem.quantity++; else state.cart.push({ ...product, quantity: 1 });
        renderCart(); renderPosProducts();
    };
    const renderCart = () => {
        const cartEl = document.getElementById('cart-items');
        cartEl.innerHTML = state.cart.length === 0 ? '<p class="text-gray-500 text-center mt-16">Click a product to start a sale.</p>' :
            state.cart.map(item => `<div class="flex justify-between items-center"><div class="w-2/3"><p class="font-medium truncate">${item.name}</p><p class="text-sm text-gray-500">${formatCurrency(item.sellingPrice)} x ${item.quantity}</p></div><div class="flex items-center gap-3"><button class="text-gray-600" onclick="updateCartQuantity('${item.id}', -1)">-</button><span>${item.quantity}</span><button class="text-gray-600" onclick="updateCartQuantity('${item.id}', 1)">+</button><button class="text-red-500 ml-2" onclick="removeFromCart('${item.id}')"><i class="fas fa-times-circle"></i></button></div></div>`).join('');
        updateCartTotals();
    };
    window.updateCartQuantity = (id, change) => {
        const item = state.cart.find(i => i.id === id);
        if (!item) return;
        const product = state.products.find(p => p.id === id);
        if (change > 0 && item.quantity >= product.stock) { alert('Maximum stock reached.'); return; }
        item.quantity += change;
        if (item.quantity <= 0) state.cart = state.cart.filter(i => i.id !== id);
        renderCart(); renderPosProducts();
    };
    window.removeFromCart = (id) => { state.cart = state.cart.filter(i => i.id !== id); renderCart(); renderPosProducts(); };
    const updateCartTotals = () => {
        const total = state.cart.reduce((sum, item) => sum + item.sellingPrice * item.quantity, 0);
        document.getElementById('cart-subtotal').textContent = formatCurrency(total);
        document.getElementById('cart-total').textContent = formatCurrency(total);
    };
    document.getElementById('product-search').addEventListener('input', renderPosProducts);
    
    document.getElementById('complete-sale-btn').addEventListener('click', () => {
        if (state.cart.length === 0) { alert('Cart is empty.'); return; }
        const saleId = 'INV-' + Date.now();
        const sale = {
            id: saleId, date: new Date().toISOString(),
            customerName: document.getElementById('customer-name').value.trim() || 'Walk-in Customer',
            items: JSON.parse(JSON.stringify(state.cart)),
            total: state.cart.reduce((sum, item) => sum + item.sellingPrice * item.quantity, 0)
        };
        
        const updates = {};
        updates[`/sales/${saleId}`] = sale;
        sale.items.forEach(item => {
            const product = state.products.find(p => p.id === item.id);
            if (product) updates[`/products/${item.id}/stock`] = product.stock - item.quantity;
        });

        update(ref(database), updates).then(() => {
            state.cart = [];
            document.getElementById('customer-name').value = '';
            renderCart();
            showInvoice(sale);
        }).catch(error => console.error("Sale failed:", error));
    });

    // --- INVOICE ---
    window.reopenInvoice = (saleId) => {
        const sale = state.sales.find(s => s.id === saleId);
        if (sale) showInvoice(sale);
    };
    const showInvoice = (sale) => {
        document.getElementById('invoice-id').textContent = sale.id;
        document.getElementById('invoice-customer-name').textContent = sale.customerName;
        document.getElementById('invoice-date').textContent = new Date(sale.date).toLocaleString();
        document.getElementById('invoice-items').innerHTML = sale.items.map(item => `<tr><td class="py-2">${item.name}</td><td class="text-center">${item.quantity}</td><td class="text-right">${formatCurrency(item.sellingPrice)}</td><td class="text-right font-medium">${formatCurrency(item.sellingPrice * item.quantity)}</td></tr>`).join('');
        document.getElementById('invoice-subtotal').textContent = formatCurrency(sale.total);
        document.getElementById('invoice-total').textContent = formatCurrency(sale.total);
        document.getElementById('invoice-modal').classList.remove('hidden');
    };
    document.getElementById('close-invoice-btn').onclick = () => document.getElementById('invoice-modal').classList.add('hidden');
    document.getElementById('print-invoice-btn').onclick = () => window.print();
    document.getElementById('download-invoice-btn').onclick = () => downloadPDF('invoice-print-area', `invoice-${document.getElementById('invoice-id').textContent}.pdf`);

    // --- SALES REPORT ---
    window.showReportSubTab = (tabName) => {
        document.querySelectorAll('.report-sub-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.report-sub-tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tabName}-report-content`).classList.add('active');
        document.getElementById(`${tabName}-report-btn`).classList.add('active');
    };

    const renderSalesReport = () => {
        const startDate = new Date(document.getElementById('report-start-date').value);
        const endDate = new Date(document.getElementById('report-end-date').value);
        endDate.setHours(23, 59, 59, 999); // Include the entire end day

        const dateDisplay = `${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
        document.getElementById('report-date-display').textContent = dateDisplay;
        document.getElementById('bills-date-display').textContent = dateDisplay;
        
        const filteredSales = state.sales.filter(s => {
            const saleDate = new Date(s.date);
            return saleDate >= startDate && saleDate <= endDate;
        });
        
        let totalSales = 0, totalProfit = 0;
        filteredSales.forEach(sale => {
            totalSales += parseFloat(sale.total || 0);
            sale.items.forEach(item => {
                totalProfit += (parseFloat(item.sellingPrice || 0) - parseFloat(item.costPrice || 0)) * parseInt(item.quantity || 0);
            });
        });

        document.getElementById('report-total-sales').textContent = formatCurrency(totalSales);
        document.getElementById('report-total-profit').textContent = formatCurrency(totalProfit);
        document.getElementById('report-transactions-table').innerHTML = filteredSales.length === 0 ? `<tr><td colspan="5" class="text-center p-4 text-gray-500">No sales recorded for this period.</td></tr>` :
            filteredSales.map(sale => `<tr class="border-b"><td class="p-2">${sale.id}</td><td>${sale.customerName}</td><td>${new Date(sale.date).toLocaleString()}</td><td>${sale.items.map(i => `${i.name}(x${i.quantity})`).join(', ')}</td><td class="text-right font-medium">${formatCurrency(sale.total)}</td></tr>`).join('');
        document.getElementById('daily-bills-table').innerHTML = filteredSales.length === 0 ? `<tr><td colspan="5" class="text-center p-4 text-gray-500">No bills found for this period.</td></tr>` :
            filteredSales.map(sale => `<tr class="border-b hover:bg-gray-50"><td class="p-3">${sale.id}</td><td>${sale.customerName}</td><td>${new Date(sale.date).toLocaleString()}</td><td class="text-right font-medium">${formatCurrency(sale.total)}</td><td class="text-center"><button class="btn btn-primary text-xs" onclick="reopenInvoice('${sale.id}')">View/Print</button></td></tr>`).join('');
    };

    document.getElementById('report-start-date').addEventListener('change', renderSalesReport);
    document.getElementById('report-end-date').addEventListener('change', renderSalesReport);
    document.getElementById('download-summary-btn').onclick = () => downloadPDF('report-print-area', `sales-report-${document.getElementById('report-start-date').value}-to-${document.getElementById('report-end-date').value}.pdf`);

    // --- DASHBOARD ---
    const updateDashboard = () => {
        const totalSales = state.sales.reduce((sum, sale) => sum + parseFloat(sale.total || 0), 0);
        let totalCostOfGoodsSold = 0;
        const salesCount = {};
        state.sales.forEach(sale => sale.items.forEach(item => {
            totalCostOfGoodsSold += (item.costPrice || 0) * (item.quantity || 0);
            salesCount[item.name] = (salesCount[item.name] || 0) + item.quantity;
        }));
        
        document.getElementById('total-products').textContent = state.products.length;
        document.getElementById('total-stock-value').textContent = formatCurrency(state.products.reduce((sum, p) => sum + (p.costPrice * p.stock), 0));
        document.getElementById('total-stock-value-selling').textContent = formatCurrency(state.products.reduce((sum, p) => sum + (p.sellingPrice * p.stock), 0));
        document.getElementById('total-profit').textContent = formatCurrency(totalSales - totalCostOfGoodsSold);

        const topSellingEl = document.getElementById('top-selling-products');
        const sortedSales = Object.entries(salesCount).sort((a,b) => b[1] - a[1]).slice(0, 5);
        topSellingEl.innerHTML = sortedSales.length > 0 ? sortedSales.map(([name, count]) => `<div class="flex justify-between items-center"><span class="font-medium">${name}</span><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded">${count} sold</span></div>`).join('') : '<p class="text-gray-500">No sales data.</p>';

        const lowStockEl = document.getElementById('low-stock-alerts');
        const lowStockProducts = state.products.filter(p => p.stock > 0 && p.stock <= 10);
        lowStockEl.innerHTML = lowStockProducts.length > 0 ? lowStockProducts.map(p => `<div>${p.name} - <b>${p.stock} left</b></div>`).join('') : '<p class="text-gray-500">No low stock products.</p>';
        
        const today = new Date(); today.setHours(0,0,0,0);
        const ninetyDays = new Date(); ninetyDays.setDate(today.getDate() + 90);
        const expiryEl = document.getElementById('expiry-warnings');
        const expiringProducts = state.products.filter(p => { const expDate = new Date(p.expiryDate); return expDate <= ninetyDays && expDate >= today; });
        expiryEl.innerHTML = expiringProducts.length > 0 ? expiringProducts.map(p => `<div>${p.name} - <b>Expires ${p.expiryDate}</b></div>`).join('') : '<p class="text-gray-500">No products expiring soon.</p>';

        const expiredEl = document.getElementById('expired-products-list');
        const expiredProducts = state.products.filter(p => new Date(p.expiryDate) < today);
        expiredEl.innerHTML = expiredProducts.length > 0 ? expiredProducts.map(p => `<div>${p.name} - <b class="text-red-700">Expired on ${p.expiryDate}</b></div>`).join('') : '<p class="text-gray-500">No expired products.</p>';
    };

    // --- FIREBASE LISTENERS & INITIALIZATION ---
    function initializeApp() {
        onValue(productsRef, (snapshot) => {
            const data = snapshot.val();
            state.products = data ? Object.values(data) : [];
            renderProductsTable();
            renderPosProducts();
            updateDashboard();
        });

        onValue(salesRef, (snapshot) => {
            const data = snapshot.val();
            state.sales = data ? Object.values(data) : [];
            updateDashboard();
            renderSalesReport();
        });
        
        // Set default dates for report
        const today = toISODateString(new Date());
        const firstDayOfMonth = toISODateString(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
        document.getElementById('report-start-date').value = firstDayOfMonth;
        document.getElementById('report-end-date').value = today;

        showTab('dashboard'); // Start on dashboard
    };
    
    initializeApp();
});
</script>
</body>
</html>